kind: job
metadata:
  name: huggingface-auto-trainer
  tag: ''
  hash: 50c8a2db162b1fb346b0bf88e92200124ec6aad1
  project: ''
  labels:
    author: Zeevr
  categories:
  - machine-learning
  - model-training
spec:
  command: ''
  args: []
  image: mlrun/mlrun
  build:
    functionSourceCode: aW1wb3J0IGltcG9ydGxpYgppbXBvcnQgdGVtcGZpbGUKZnJvbSB0eXBpbmcgaW1wb3J0IFR1cGxlLCBVbmlvbgppbXBvcnQgcGVmdAppbXBvcnQgdG9yY2gKaW1wb3J0IHRyYW5zZm9ybWVycwpmcm9tIGRhdGFzZXRzIGltcG9ydCBEYXRhc2V0LCBsb2FkX2RhdGFzZXQKZnJvbSBtbHJ1bi5kYXRhc3RvcmUgaW1wb3J0IGlzX3N0b3JlX3VyaQpmcm9tIG1scnVuLnV0aWxzIGltcG9ydCBsb2dnZXIKaW1wb3J0IG9zCmltcG9ydCBzaHV0aWwKaW1wb3J0IHppcGZpbGUKZnJvbSBhYmMgaW1wb3J0IEFCQwpmcm9tIHR5cGluZyBpbXBvcnQgRGljdCwgTGlzdAppbXBvcnQgbWxydW4KaW1wb3J0IG51bXB5IGFzIG5wCmltcG9ydCBwYW5kYXMgYXMgcGQKZnJvbSBkYXRhc2V0cyBpbXBvcnQgRGF0YXNldApmcm9tIG1scnVuLmFydGlmYWN0cy5tYW5hZ2VyIGltcG9ydCBBcnRpZmFjdCwgUGxvdGx5QXJ0aWZhY3QKZnJvbSBtbHJ1bi5mcmFtZXdvcmtzLl9jb21tb24gaW1wb3J0IENvbW1vblR5cGVzLCBNTFJ1bkludGVyZmFjZQpmcm9tIHBlZnQgaW1wb3J0IExvcmFDb25maWcsIFBlZnRNb2RlbCwgZ2V0X3BlZnRfbW9kZWwsIHByZXBhcmVfbW9kZWxfZm9yX2tiaXRfdHJhaW5pbmcKZnJvbSBwbG90bHkgaW1wb3J0IGdyYXBoX29iamVjdHMgYXMgZ28KZnJvbSB0cmFuc2Zvcm1lcnMgaW1wb3J0ICgKICAgIEF1dG9Nb2RlbEZvckNhdXNhbExNLAogICAgQXV0b1Rva2VuaXplciwKICAgIEJpdHNBbmRCeXRlc0NvbmZpZywKICAgIERhdGFDb2xsYXRvckZvckxhbmd1YWdlTW9kZWxpbmcsCiAgICBQcmVUcmFpbmVkTW9kZWwsCiAgICBQcmVUcmFpbmVkVG9rZW5pemVyLAogICAgVHJhaW5lciwKICAgIFRyYWluZXJDYWxsYmFjaywKICAgIFRyYWluZXJDb250cm9sLAogICAgVHJhaW5lclN0YXRlLAogICAgVHJhaW5pbmdBcmd1bWVudHMsCikKCnN1cHBvcnRlZF90YXNrcyA9IFsKICAgICJxdWVzdGlvbi1hbnN3ZXJpbmciLAogICAgInN1bW1hcml6YXRpb24iLAogICAgInRhYmxlLXF1ZXN0aW9uLWFuc3dlcmluZyIsCiAgICAidGV4dDJ0ZXh0LWdlbmVyYXRpb24iLAogICAgInRleHQtY2xhc3NpZmljYXRpb24iLAogICAgInNlbnRpbWVudC1hbmFseXNpcyIsCiAgICAidGV4dC1nZW5lcmF0aW9uIiwKICAgICJ0b2tlbi1jbGFzc2lmaWNhdGlvbiIsCiAgICAidHJhbnNsYXRpb24iLAogICAgInRyYW5zbGF0aW9uX3h4X3RvX3l5IiwKXQoKCmNsYXNzIENvbmZpZ0tleXM6CiAgICBkZWVwc3BlZWQgPSAiZGVlcHNwZWVkIgogICAgcXVhbnRpemF0aW9uID0gInF1YW50aXphdGlvbiIKICAgIGxvcmEgPSAibG9yYSIKICAgIHRyYWluaW5nID0gInRyYWluaW5nIgogICAgdG9rZW5pemVyX3ByZXRyYWluZWQgPSAidG9rZW5pemVyX3ByZXRyYWluZWQiCiAgICBtb2RlbF9wcmV0cmFpbmVkID0gIm1vZGVsX3ByZXRyYWluZWQiCiAgICBkYXRhX2NvbGxhdG9yID0gImRhdGFfY29sbGF0b3IiCgojIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS1mcm9tIE1MUlVOLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KY2xhc3MgSEZUcmFpbmVyTUxSdW5JbnRlcmZhY2UoTUxSdW5JbnRlcmZhY2UsIEFCQyk6CiAgICAiIiIKICAgIFRoaXMgaXMgdGVtcG9yYXJ5IGFuZCB3aWxsIGJlIGJ1aWx0IGluIG1scnVuIDEuNS4wCiAgICBJbnRlcmZhY2UgZm9yIGFkZGluZyBNTFJ1biBmZWF0dXJlcyBmb3IgdGVuc29yZmxvdyBrZXJhcyBBUEkuCiAgICAiIiIKCiAgICAjIE1MUnVucyBjb250ZXh0IGRlZmF1bHQgbmFtZToKICAgIERFRkFVTFRfQ09OVEVYVF9OQU1FID0gIm1scnVuLWh1Z2dpbmdmYWNlIgoKICAgICMgQXR0cmlidXRlcyB0byByZXBsYWNlIHNvIHRoZSBNTFJ1biBpbnRlcmZhY2Ugd2lsbCBiZSBmdWxseSBlbmFibGVkLgogICAgX1JFUExBQ0VEX01FVEhPRFMgPSBbCiAgICAgICAgInRyYWluIiwKICAgICAgICAjICJldmFsdWF0ZSIKICAgIF0KCiAgICBAY2xhc3NtZXRob2QKICAgIGRlZiBhZGRfaW50ZXJmYWNlKAogICAgICAgIGNscywKICAgICAgICBvYmo6IFRyYWluZXIsCiAgICAgICAgcmVzdG9yYXRpb246IENvbW1vblR5cGVzLk1MUnVuSW50ZXJmYWNlUmVzdG9yYXRpb25UeXBlID0gTm9uZSwKICAgICk6CiAgICAgICAgc3VwZXIoSEZUcmFpbmVyTUxSdW5JbnRlcmZhY2UsIGNscykuYWRkX2ludGVyZmFjZSgKICAgICAgICAgICAgb2JqPW9iaiwgcmVzdG9yYXRpb249cmVzdG9yYXRpb24KICAgICAgICApCgogICAgQGNsYXNzbWV0aG9kCiAgICBkZWYgbWxydW5fdHJhaW4oY2xzKToKICAgICAgICBkZWYgd3JhcHBlcihzZWxmOiBUcmFpbmVyLCAqYXJncywgKiprd2FyZ3MpOgogICAgICAgICAgICAjIFJlc3RvcmUgdGhlIGV2YWx1YXRpb24gbWV0aG9kIGFzIGB0cmFpbmAgd2lsbCB1c2UgaXQ6CiAgICAgICAgICAgICMgY2xzLl9yZXN0b3JlX2F0dHJpYnV0ZShvYmo9c2VsZiwgYXR0cmlidXRlX25hbWU9ImV2YWx1YXRlIikKCiAgICAgICAgICAgICMgQ2FsbCB0aGUgb3JpZ2luYWwgZml0IG1ldGhvZDoKICAgICAgICAgICAgcmVzdWx0ID0gc2VsZi5vcmlnaW5hbF90cmFpbigqYXJncywgKiprd2FyZ3MpCgogICAgICAgICAgICAjIFJlcGxhY2UgdGhlIGV2YWx1YXRpb24gbWV0aG9kIGFnYWluOgogICAgICAgICAgICAjIGNscy5fcmVwbGFjZV9mdW5jdGlvbihvYmo9c2VsZiwgZnVuY3Rpb25fbmFtZT0iZXZhbHVhdGUiKQoKICAgICAgICAgICAgcmV0dXJuIHJlc3VsdAoKICAgICAgICByZXR1cm4gd3JhcHBlcgoKCmNsYXNzIE1MUnVuQ2FsbGJhY2soVHJhaW5lckNhbGxiYWNrKToKICAgICIiIgogICAgVGhpcyBpcyB0ZW1wb3JhcnkgYW5kIHdpbGwgYmUgYnVpbHQgaW4gbWxydW4gMS41LjAKICAgIENhbGxiYWNrIGZvciBjb2xsZWN0aW5nIGxvZ3MgZHVyaW5nIHRyYWluaW5nIC8gZXZhbHVhdGlvbiBvZiB0aGUgYFRyYWluZXJgIEFQSS4KICAgICIiIgoKICAgIGRlZiBfX2luaXRfXygKICAgICAgICBzZWxmLAogICAgICAgIGNvbnRleHQ6IG1scnVuLk1MQ2xpZW50Q3R4ID0gTm9uZSwKICAgICAgICBtb2RlbF9uYW1lOiBzdHIgPSAibW9kZWwiLAogICAgICAgIHRhZzogc3RyID0gIiIsCiAgICAgICAgbGFiZWxzOiBEaWN0W3N0ciwgc3RyXSA9IE5vbmUsCiAgICAgICAgZXh0cmFfZGF0YTogZGljdCA9IE5vbmUsCiAgICApOgogICAgICAgIHN1cGVyKCkuX19pbml0X18oKQoKICAgICAgICAjIFN0b3JlIHRoZSBjb25maWd1cmF0aW9uczoKICAgICAgICBzZWxmLl9jb250ZXh0ID0gKAogICAgICAgICAgICBjb250ZXh0CiAgICAgICAgICAgIGlmIGNvbnRleHQgaXMgbm90IE5vbmUKICAgICAgICAgICAgZWxzZSBtbHJ1bi5nZXRfb3JfY3JlYXRlX2N0eCgiLi9tbHJ1bi1odWdnaW5nZmFjZSIpCiAgICAgICAgKQogICAgICAgIHNlbGYuX21vZGVsX25hbWUgPSBtb2RlbF9uYW1lCiAgICAgICAgc2VsZi5fdGFnID0gdGFnCiAgICAgICAgc2VsZi5fbGFiZWxzID0gbGFiZWxzCiAgICAgICAgc2VsZi5fZXh0cmFfZGF0YSA9IGV4dHJhX2RhdGEgaWYgZXh0cmFfZGF0YSBpcyBub3QgTm9uZSBlbHNlIHt9CgogICAgICAgICMgU2V0IHVwIHRoZSBsb2dnaW5nIG1vZGU6CiAgICAgICAgc2VsZi5faXNfdHJhaW5pbmcgPSBGYWxzZQogICAgICAgIHNlbGYuX3N0ZXBzOiBMaXN0W0xpc3RbaW50XV0gPSBbXQogICAgICAgIHNlbGYuX21ldHJpY19zY29yZXM6IERpY3Rbc3RyLCBMaXN0W2Zsb2F0XV0gPSB7fQogICAgICAgIHNlbGYuX2FydGlmYWN0czogRGljdFtzdHIsIEFydGlmYWN0XSA9IHt9CgogICAgZGVmIG9uX2Vwb2NoX2JlZ2luKAogICAgICAgIHNlbGYsCiAgICAgICAgYXJnczogVHJhaW5pbmdBcmd1bWVudHMsCiAgICAgICAgc3RhdGU6IFRyYWluZXJTdGF0ZSwKICAgICAgICBjb250cm9sOiBUcmFpbmVyQ29udHJvbCwKICAgICAgICAqKmt3YXJncywKICAgICk6CiAgICAgICAgaWYgbm90IHN0YXRlLmlzX3dvcmxkX3Byb2Nlc3NfemVybzoKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgc2VsZi5fc3RlcHMuYXBwZW5kKFtdKQoKICAgIGRlZiBvbl9lcG9jaF9lbmQoCiAgICAgICAgc2VsZiwKICAgICAgICBhcmdzOiBUcmFpbmluZ0FyZ3VtZW50cywKICAgICAgICBzdGF0ZTogVHJhaW5lclN0YXRlLAogICAgICAgIGNvbnRyb2w6IFRyYWluZXJDb250cm9sLAogICAgICAgICoqa3dhcmdzLAogICAgKToKICAgICAgICBpZiBub3Qgc3RhdGUuaXNfd29ybGRfcHJvY2Vzc196ZXJvOgogICAgICAgICAgICByZXR1cm4KICAgICAgICBzZWxmLl9sb2dfbWV0cmljcygpCgogICAgZGVmIG9uX2xvZygKICAgICAgICBzZWxmLAogICAgICAgIGFyZ3M6IFRyYWluaW5nQXJndW1lbnRzLAogICAgICAgIHN0YXRlOiBUcmFpbmVyU3RhdGUsCiAgICAgICAgY29udHJvbDogVHJhaW5lckNvbnRyb2wsCiAgICAgICAgbG9nczogRGljdFtzdHIsIGZsb2F0XSA9IE5vbmUsCiAgICAgICAgKiprd2FyZ3MsCiAgICApOgogICAgICAgIGlmIG5vdCBzdGF0ZS5pc193b3JsZF9wcm9jZXNzX3plcm86CiAgICAgICAgICAgIHJldHVybgogICAgICAgIHJlY2VudF9sb2dzID0gc3RhdGUubG9nX2hpc3RvcnlbLTFdLmNvcHkoKQoKICAgICAgICByZWNlbnRfbG9ncy5wb3AoImVwb2NoIikKICAgICAgICBjdXJyZW50X3N0ZXAgPSBpbnQocmVjZW50X2xvZ3MucG9wKCJzdGVwIikpCiAgICAgICAgaWYgY3VycmVudF9zdGVwIG5vdCBpbiBzZWxmLl9zdGVwc1stMV06CiAgICAgICAgICAgIHNlbGYuX3N0ZXBzWy0xXS5hcHBlbmQoY3VycmVudF9zdGVwKQoKICAgICAgICBmb3IgbWV0cmljX25hbWUsIG1ldHJpY19zY29yZSBpbiByZWNlbnRfbG9ncy5pdGVtcygpOgogICAgICAgICAgICBpZiBtZXRyaWNfbmFtZS5zdGFydHN3aXRoKCJ0cmFpbl8iKToKICAgICAgICAgICAgICAgIGlmIG1ldHJpY19uYW1lLnNwbGl0KCJ0cmFpbl8iKVsxXSBub3QgaW4gc2VsZi5fbWV0cmljX3Njb3JlczoKICAgICAgICAgICAgICAgICAgICBzZWxmLl9tZXRyaWNfc2NvcmVzW21ldHJpY19uYW1lXSA9IFttZXRyaWNfc2NvcmVdCiAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICBpZiBtZXRyaWNfbmFtZSBub3QgaW4gc2VsZi5fbWV0cmljX3Njb3JlczoKICAgICAgICAgICAgICAgIHNlbGYuX21ldHJpY19zY29yZXNbbWV0cmljX25hbWVdID0gW10KICAgICAgICAgICAgc2VsZi5fbWV0cmljX3Njb3Jlc1ttZXRyaWNfbmFtZV0uYXBwZW5kKG1ldHJpY19zY29yZSkKCiAgICBkZWYgb25fdHJhaW5fYmVnaW4oCiAgICAgICAgc2VsZiwKICAgICAgICBhcmdzOiBUcmFpbmluZ0FyZ3VtZW50cywKICAgICAgICBzdGF0ZTogVHJhaW5lclN0YXRlLAogICAgICAgIGNvbnRyb2w6IFRyYWluZXJDb250cm9sLAogICAgICAgICoqa3dhcmdzLAogICAgKToKICAgICAgICBpZiBub3Qgc3RhdGUuaXNfd29ybGRfcHJvY2Vzc196ZXJvOgogICAgICAgICAgICByZXR1cm4KICAgICAgICBzZWxmLl9pc190cmFpbmluZyA9IFRydWUKCiAgICBkZWYgb25fdHJhaW5fZW5kKAogICAgICAgIHNlbGYsCiAgICAgICAgYXJnczogVHJhaW5pbmdBcmd1bWVudHMsCiAgICAgICAgc3RhdGU6IFRyYWluZXJTdGF0ZSwKICAgICAgICBjb250cm9sOiBUcmFpbmVyQ29udHJvbCwKICAgICAgICBtb2RlbDogUHJlVHJhaW5lZE1vZGVsID0gTm9uZSwKICAgICAgICB0b2tlbml6ZXI6IFByZVRyYWluZWRUb2tlbml6ZXIgPSBOb25lLAogICAgICAgICoqa3dhcmdzLAogICAgKToKICAgICAgICBpZiBub3Qgc3RhdGUuaXNfd29ybGRfcHJvY2Vzc196ZXJvOgogICAgICAgICAgICByZXR1cm4KICAgICAgICBzZWxmLl9sb2dfbWV0cmljcygpCgogICAgZGVmIG9uX2V2YWx1YXRlKAogICAgICAgIHNlbGYsCiAgICAgICAgYXJnczogVHJhaW5pbmdBcmd1bWVudHMsCiAgICAgICAgc3RhdGU6IFRyYWluZXJTdGF0ZSwKICAgICAgICBjb250cm9sOiBUcmFpbmVyQ29udHJvbCwKICAgICAgICAqKmt3YXJncywKICAgICk6CiAgICAgICAgaWYgbm90IHN0YXRlLmlzX3dvcmxkX3Byb2Nlc3NfemVybzoKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgc2VsZi5fbG9nX21ldHJpY3MoKQoKICAgICAgICBpZiBzZWxmLl9pc190cmFpbmluZzoKICAgICAgICAgICAgcmV0dXJuCgogICAgZGVmIF9sb2dfbWV0cmljcyhzZWxmKToKICAgICAgICBmb3IgbWV0cmljX25hbWUsIG1ldHJpY19zY29yZXMgaW4gc2VsZi5fbWV0cmljX3Njb3Jlcy5pdGVtcygpOgogICAgICAgICAgICBzZWxmLl9jb250ZXh0LmxvZ19yZXN1bHQoa2V5PW1ldHJpY19uYW1lLCB2YWx1ZT1tZXRyaWNfc2NvcmVzWy0xXSkKICAgICAgICAgICAgaWYgbGVuKG1ldHJpY19zY29yZXMpID4gMToKICAgICAgICAgICAgICAgIHNlbGYuX2xvZ19tZXRyaWNfcGxvdChuYW1lPW1ldHJpY19uYW1lLCBzY29yZXM9bWV0cmljX3Njb3JlcykKICAgICAgICBzZWxmLl9jb250ZXh0LmNvbW1pdChjb21wbGV0ZWQ9RmFsc2UpCgogICAgZGVmIF9sb2dfbWV0cmljX3Bsb3Qoc2VsZiwgbmFtZTogc3RyLCBzY29yZXM6IExpc3RbZmxvYXRdKToKICAgICAgICAjIEluaXRpYWxpemUgYSBwbG90bHkgZmlndXJlOgogICAgICAgIG1ldHJpY19maWd1cmUgPSBnby5GaWd1cmUoKQoKICAgICAgICAjIEFkZCB0aXRsZXM6CiAgICAgICAgbWV0cmljX2ZpZ3VyZS51cGRhdGVfbGF5b3V0KAogICAgICAgICAgICB0aXRsZT1uYW1lLmNhcGl0YWxpemUoKS5yZXBsYWNlKCJfIiwgIiAiKSwKICAgICAgICAgICAgeGF4aXNfdGl0bGU9IlNhbXBsZXMiLAogICAgICAgICAgICB5YXhpc190aXRsZT0iU2NvcmVzIiwKICAgICAgICApCgogICAgICAgICMgRHJhdzoKICAgICAgICBtZXRyaWNfZmlndXJlLmFkZF90cmFjZSgKICAgICAgICAgICAgZ28uU2NhdHRlcih4PW5wLmFyYW5nZShsZW4oc2NvcmVzKSksIHk9c2NvcmVzLCBtb2RlPSJsaW5lcyIpCiAgICAgICAgKQoKICAgICAgICAjIENyZWF0ZSB0aGUgcGxvdGx5IGFydGlmYWN0OgogICAgICAgIGFydGlmYWN0X25hbWUgPSBmIntuYW1lfV9wbG90IgogICAgICAgIGFydGlmYWN0ID0gUGxvdGx5QXJ0aWZhY3Qoa2V5PWFydGlmYWN0X25hbWUsIGZpZ3VyZT1tZXRyaWNfZmlndXJlKQogICAgICAgIHNlbGYuX2FydGlmYWN0c1thcnRpZmFjdF9uYW1lXSA9IHNlbGYuX2NvbnRleHQubG9nX2FydGlmYWN0KGFydGlmYWN0KQoKCmRlZiBhcHBseV9tbHJ1bigKICAgIHRyYWluZXI6IHRyYW5zZm9ybWVycy5UcmFpbmVyLAogICAgbW9kZWxfbmFtZTogc3RyID0gTm9uZSwKICAgIHRhZzogc3RyID0gIiIsCiAgICBjb250ZXh0OiBtbHJ1bi5NTENsaWVudEN0eCA9IE5vbmUsCiAgICBhdXRvX2xvZzogYm9vbCA9IFRydWUsCiAgICBsYWJlbHM6IERpY3Rbc3RyLCBzdHJdID0gTm9uZSwKICAgIGV4dHJhX2RhdGE6IGRpY3QgPSBOb25lLAogICAgKiprd2FyZ3MsCik6CiAgICAiIiIKICAgIFRoaXMgaXMgdGVtcG9yYXJ5IGFuZCB3aWxsIGJlIGJ1aWx0IGluIG1scnVuIDEuNS4wCiAgICAiIiIKICAgICMgR2V0IHBhcmFtZXRlcnMgZGVmYXVsdHM6CiAgICBpZiBjb250ZXh0IGlzIE5vbmU6CiAgICAgICAgY29udGV4dCA9IG1scnVuLmdldF9vcl9jcmVhdGVfY3R4KEhGVHJhaW5lck1MUnVuSW50ZXJmYWNlLkRFRkFVTFRfQ09OVEVYVF9OQU1FKQoKICAgIEhGVHJhaW5lck1MUnVuSW50ZXJmYWNlLmFkZF9pbnRlcmZhY2Uob2JqPXRyYWluZXIpCgogICAgaWYgYXV0b19sb2c6CiAgICAgICAgdHJhaW5lci5hZGRfY2FsbGJhY2soCiAgICAgICAgICAgIE1MUnVuQ2FsbGJhY2soCiAgICAgICAgICAgICAgICBjb250ZXh0PWNvbnRleHQsCiAgICAgICAgICAgICAgICBtb2RlbF9uYW1lPW1vZGVsX25hbWUsCiAgICAgICAgICAgICAgICB0YWc9dGFnLAogICAgICAgICAgICAgICAgbGFiZWxzPWxhYmVscywKICAgICAgICAgICAgICAgIGV4dHJhX2RhdGE9ZXh0cmFfZGF0YSwKICAgICAgICAgICAgKQogICAgICAgICkKCiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLWVuZCBmcm9tIE1MUlVOLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KCmRlZiBwcmludF90cmFpbmFibGVfcGFyYW1ldGVycyhtb2RlbCk6CiAgICAiIiIKICAgIFByaW50cyB0aGUgbnVtYmVyIG9mIHRyYWluYWJsZSBwYXJhbWV0ZXJzIGluIHRoZSBtb2RlbC4KICAgICIiIgogICAgdHJhaW5hYmxlX3BhcmFtcyA9IDAKICAgIGFsbF9wYXJhbSA9IDAKICAgIGZvciBfLCBwYXJhbSBpbiBtb2RlbC5uYW1lZF9wYXJhbWV0ZXJzKCk6CiAgICAgICAgYWxsX3BhcmFtICs9IHBhcmFtLm51bWVsKCkKICAgICAgICBpZiBwYXJhbS5yZXF1aXJlc19ncmFkOgogICAgICAgICAgICB0cmFpbmFibGVfcGFyYW1zICs9IHBhcmFtLm51bWVsKCkKICAgIHByaW50KAogICAgICAgIGYidHJhaW5hYmxlIHBhcmFtczoge3RyYWluYWJsZV9wYXJhbXN9IHx8IGFsbCBwYXJhbXM6IHthbGxfcGFyYW19IHx8IHRyYWluYWJsZSU6IgogICAgICAgIGYiIHsxMDAgKiB0cmFpbmFibGVfcGFyYW1zIC8gYWxsX3BhcmFtfSIKICAgICkKCgojIGRlZmF1bHQgY29uZmlncwojIHdpbGwgYmUgdXNlZCBpZiB1c2VyIHByb3ZpZGVzICJUcnVlIiB3aXRoIGNvbmZpZyBuYW1lIGFzIGlucHV0ClFVQU5USVpBVElPTl9DT05GSUcgPSB0cmFuc2Zvcm1lcnMuQml0c0FuZEJ5dGVzQ29uZmlnKAogICAgbG9hZF9pbl80Yml0PVRydWUsCiAgICBibmJfNGJpdF91c2VfZG91YmxlX3F1YW50PVRydWUsCiAgICBibmJfNGJpdF9xdWFudF90eXBlPSJuZjQiLAogICAgYm5iXzRiaXRfY29tcHV0ZV9kdHlwZT10b3JjaC5iZmxvYXQxNiwKKQoKTE9SQV9DT05GSUcgPSBwZWZ0LkxvcmFDb25maWcoCiAgICByPTgsCiAgICBsb3JhX2FscGhhPTMyLAogICAgdGFyZ2V0X21vZHVsZXM9WyJxdWVyeV9rZXlfdmFsdWUiXSwKICAgIGxvcmFfZHJvcG91dD0wLjA1LAogICAgYmlhcz0ibm9uZSIsCiAgICB0YXNrX3R5cGU9IkNBVVNBTF9MTSIsCikKCkRFRVBTUEVFRF9DT05GSUcgPSB7CiAgICAidHJhaW5fbWljcm9fYmF0Y2hfc2l6ZV9wZXJfZ3B1IjogImF1dG8iLAogICAgImZwMTYiOiB7CiAgICAgICAgImVuYWJsZWQiOiBUcnVlCiAgICB9LAogICAgImF1dG90dW5pbmciOiB7CiAgICAgICAgImVuYWJsZWQiOiBUcnVlLAogICAgICAgICJhcmdfbWFwcGluZ3MiOiB7CiAgICAgICAgICAgICJ0cmFpbl9taWNyb19iYXRjaF9zaXplX3Blcl9ncHUiOiAiLS1wZXJfZGV2aWNlX3RyYWluX2JhdGNoX3NpemUiLAogICAgICAgICAgICAiZ3JhZGllbnRfYWNjdW11bGF0aW9uX3N0ZXBzICI6ICItLWdyYWRpZW50X2FjY3VtdWxhdGlvbl9zdGVwcyIKICAgICAgICB9CiAgICB9LAogICAgInplcm9fb3B0aW1pemF0aW9uIjogewogICAgICAgICJzdGFnZSI6IDIsCiAgICB9LAp9CgoKZGVmIHVwZGF0ZV9jb25maWcoc3JjOiBkaWN0LCBkc3Q6IGRpY3QpOgogICAgIiIiCiAgICB1cGRhdGUgY29uZmlncyBhY2NvcmRpbmcgdG8gdXNlciwgdGhpcyB3YXkgdGhlIHVzZXIgY2FuIGFkZC9tb2RpZnkgdmFsdWVzIGluIGRlZmF1bHQgY29uZmlncyBmb3IgZS5nLgoKICAgIGdvZXMgb3ZlciBhbGwgY29uZmlncyBhbmQgY29ycmVzcG9uZGluZyBwcmVmaXhlcywgY29sbGVjdCBhbGwgdGhlIGtleXMgZnJvbSB0aGUgZ2l2ZW4gZGljdCB0aGF0IHN0YXJ0CiAgICAgd2l0aCB0aGUgcHJlZml4IGFuZCBhZGQgdGhlbSB0byBhcHByb3ByaWF0ZSBjb25maWcKCiAgICA6cGFyYW0gc3JjOiBkaWN0IG9mIGFsbCBjYW5kaWRhdGUgdmFsdWVzIHRvIHVwZGF0ZSBkaWN0LgogICAgOnBhcmFtIGRzdDogZGljdCBjb250YWluaW5nIGFsbCBjb25maWdzIHRvIHVwZGF0ZS4KICAgICIiIgoKICAgIGZvciBjb25maWdfbmFtZSwgY29uZmlnIGluIGRzdC5pdGVtcygpOgoKICAgICAgICAjIElmIGdpdmVuIFRydWUgd2UgdXNlIGRlZmF1bHQgZGljdAogICAgICAgICMgQ2FuIGFsc28gYmUgRmFsc2Ugb3IgYSBjb25maWcgZGljdCBnaXZlbiBmcm9tIHVzZXIsIHNvIHdlIGNoZWNrIHNwZWNpZmljYWxseSBmbyBUcnVlCiAgICAgICAgaWYgY29uZmlnIGlzIFRydWUgYW5kIGNvbmZpZ19uYW1lID09ICJxdWFudGl6YXRpb24iOgogICAgICAgICAgICBjb25maWcgPSBRVUFOVElaQVRJT05fQ09ORklHCgogICAgICAgIGlmIGNvbmZpZyBpcyBUcnVlIGFuZCBjb25maWdfbmFtZSA9PSAibG9yYSI6CiAgICAgICAgICAgIGNvbmZpZyA9IExPUkFfQ09ORklHCgogICAgICAgIGlmIGNvbmZpZyBpcyBUcnVlIGFuZCBjb25maWdfbmFtZSA9PSAiZGVlcHNwZWVkIjoKICAgICAgICAgICAgY29uZmlnID0gREVFUFNQRUVEX0NPTkZJRwoKICAgICAgICAjIGluIHNvbWUgY2FzZXMgd2UgY2FuIGdldCBhIGJvb2xlYW4gdmFsdWUsIGluIHRoYXQgY2FzZSBubyBuZWVkIHRvIGxvb2sgZm9yIGFyZ3MKICAgICAgICBpZiBpc2luc3RhbmNlKGNvbmZpZywgYm9vbCk6CiAgICAgICAgICAgIGNvbmZpZyA9IE5vbmUKCiAgICAgICAgZWxpZiBpc2luc3RhbmNlKGNvbmZpZywgZGljdCk6CiAgICAgICAgICAgIGZvciBrZXksIHZhbCBpbiBzcmMuaXRlbXMoKToKICAgICAgICAgICAgICAgIGlmIGtleS5zdGFydHN3aXRoKGNvbmZpZ19uYW1lKToKICAgICAgICAgICAgICAgICAgICBjb25maWdba2V5LnJlcGxhY2UoZiJ7Y29uZmlnX25hbWV9XyIsICIiKV0gPSB2YWwKCiAgICAgICAgIyB1cGRhdGUgYnkgY29uZmlnIG5hbWUKICAgICAgICBlbHNlOgogICAgICAgICAgICBmb3Iga2V5LCB2YWwgaW4gc3JjLml0ZW1zKCk6CiAgICAgICAgICAgICAgICBpZiBrZXkuc3RhcnRzd2l0aChjb25maWdfbmFtZSk6CiAgICAgICAgICAgICAgICAgICAgc2V0YXR0cihjb25maWcsIGtleS5yZXBsYWNlKGYie2NvbmZpZ19uYW1lfV8iLCAiIiksIHZhbCkKCiAgICAgICAgZHN0LnVwZGF0ZSh7Y29uZmlnX25hbWU6IGNvbmZpZ30pCgoKZGVmIGdldF9jbGFzc19vYmplY3QoY2xhc3NfcGF0aDogc3RyKSAtPiB0eXBlOgogICAgIiIiCiAgICBnaXZlbiBhIGZ1bGwgY2xhc3MgbmFtZSwgdGhpcyBmdW5jdGlvbiByZXR1cm5zIHRoZSBjb3JyZWN0IGNsYXNzCgogICAgOnBhcmFtIGNsYXNzX3BhdGg6IGEgZnVsbCBjbGFzcyBuYW1lIChleC4gJ3RyYW5zZm9ybWVycy5BdXRvTW9kZWxGb3JDYXVzYWxMTScpCgogICAgOnJldHVybiB0aGUgd2FudGVkIGNsYXNzIG9iamVjdAogICAgIiIiCiAgICBtb2R1bGVfcGF0aCwgY2xhc3NfbmFtZSA9IGNsYXNzX3BhdGgucnNwbGl0KCIuIiwgMSkKICAgIG1vZHVsZSA9IGltcG9ydGxpYi5pbXBvcnRfbW9kdWxlKG1vZHVsZV9wYXRoKQogICAgcmV0dXJuIGdldGF0dHIobW9kdWxlLCBjbGFzc19uYW1lKQoKCmRlZiBzZXRfbW9kZWxfYW5kX3Rva2VuaXplcigKICAgICAgICBtb2RlbDogVW5pb25bc3RyLCBUdXBsZVtzdHIsIHN0cl1dLAogICAgICAgIHRva2VuaXplcjogVW5pb25bc3RyLCBUdXBsZVtzdHIsIHN0cl1dLAogICAgICAgIHRhc2s6IHN0ciwKICAgICAgICBmcmFtZXdvcms6IHN0ciwKICAgICAgICBsb3JhX2NvbmZpZzogZGljdCwKICAgICAgICBxdWFudGl6YXRpb25fY29uZmlnOiBkaWN0LAogICAgICAgIHVzZV9jdWRhOiBib29sLAogICAgICAgIHRva2VuaXplcl9wcmV0cmFpbmVkX2NvbmZpZywKICAgICAgICBtb2RlbF9wcmV0cmFpbmVkX2NvbmZpZywKICAgICAgICBkZXZpY2VfbWFwOiBzdHIsCgopOgogICAgIiIiCiAgICBnZXQgdGhlIGNvcnJlY3QgbW9kZWwgYW5kIHRva2VuaXplciBhY2NvcmRpbmcgdG8gZ2l2ZW4gdXNlciBpbnB1dHMKCiAgICA6cGFyYW0gbW9kZWw6IGEgdHVwbGUgY29udGFpbmluZyBtb2RlbCBuYW1lIGFuZCBjbGFzcywgb3Igc3RyIHdpdGggbW9kZWwgbmFtZSBvciBwYXRoCiAgICA6cGFyYW0gdG9rZW5pemVyOiBhIHR1cGxlIGNvbnRhaW5pbmcgdG9rZW5pemVyIG5hbWUgYW5kIGNsYXNzLCBvciBzdHIgd2l0aCB0b2tlbml6ZXIgbmFtZSBvciBwYXRoCiAgICA6cGFyYW0gdGFzazogYSBzdXBwb3J0ZWQgbmxwIHRhc2ssIHVzZWQgdG8gY2hvb3NlIG1vZGVsIGlmIG5vdCBwcm92aWRlZAogICAgOnBhcmFtIGZyYW1ld29yazogcHQgb3IgdGYKICAgIDpwYXJhbSBsb3JhX2NvbmZpZzogbG9yYSBjb25maWcgb3IgTm9uZSwgdG8gbG9hZCBtb2RlbCBpbiBhcHByb3ByaWF0ZSB3YXkKICAgIDpwYXJhbSBxdWFudGl6YXRpb25fY29uZmlnOiBxdWFudGl6YXRpb24gY29uZmlnIG9yIE5vbmUsIHRvIGxvYWQgbW9kZWwgaW4gYXBwcm9wcmlhdGUgd2F5CiAgICA6cGFyYW0gdXNlX2N1ZGE6IHVzZSBncHUgb3Igbm90CiAgICA6cGFyYW0gdG9rZW5pemVyX3ByZXRyYWluZWRfY29uZmlnOiBjb25maWcgdG8gbG9hZCB0aGUgcHJldHJhaW5lZCB0b2tlbml6ZXIKICAgIDpwYXJhbSBtb2RlbF9wcmV0cmFpbmVkX2NvbmZpZzogY29uZmlnIHRvIGxvYWQgdGhlIHByZXRyYWluZWQgbW9kZWwKICAgIDpwYXJhbSBkZXZpY2VfbWFwOiBhIGRldmljZSBtYXAgZm9yIG1vZGVsIHRyYWluaW5nIGlmIHVzaW5nIG51bWJlciBvZiBncHUncwoKICAgIDpyZXR1cm4gbW9kZWwgYW5kIHRva2VuaXplcgogICAgIiIiCiAgICAjIGlmIHRhc2sgaXMgbm90IHN1cHBvcnRlZCBhbmQgbm8gbW9kZWwgd2FzIGdpdmVuIHdlIGNhbid0IGNob29zZSBvbmUKICAgIGlmIHRhc2sgYW5kIHRhc2sgbm90IGluIHN1cHBvcnRlZF90YXNrcyBhbmQgbm90IG1vZGVsOgogICAgICAgIGxvZ2dlci5lcnJvcigidW5zdXBwb3J0ZWQgdGFzayBvcHRpb24gY2hvc2VuIikKICAgICAgICByYWlzZQoKICAgICMgbG9hZCBtb2RlbCBmcm9tIHN0b3JlCiAgICBpZiBpc2luc3RhbmNlKG1vZGVsLCBzdHIpIGFuZCBpc19zdG9yZV91cmkobW9kZWwpOgogICAgICAgIHBhc3MKICAgICAgICAjIFRPRE86IGxvYWQgYm90aCBtb2RlbCBhbmQgdG9rZW5pemVyIGFuZCByZXR1cm4sIG5lZWQgZ3V5J3MgaGVscAoKICAgICMgaWYgaXQncyBhIHR1cGxlIHRoZW0gd2UgYXNzdW1lIGl0IGNvbnRhaW5zIG9mIGJvdGggbmFtZSBhbmQgY2xhc3MKICAgIGlmIGlzaW5zdGFuY2UobW9kZWwsIHR1cGxlKToKICAgICAgICBtb2RlbF9uYW1lLCBtb2RlbF9jbGFzcyA9IG1vZGVsCiAgICAgICAgbW9kZWxfY2xhc3MgPSBnZXRfY2xhc3Nfb2JqZWN0KG1vZGVsX2NsYXNzKQoKICAgICMgaW4gdGhlIGNhc2Ugd2UgZG9uJ3QgZ2V0IHRoZSBtb2RlbCBjbGFzcyB3ZSBuZWVkIHRoZSB0YXNrIGluIG9yZGVyIHRvIGNob29zZSB0aGUgY29ycmVjdCBtb2RlbAogICAgZWxzZToKICAgICAgICBpZiB0YXNrIGlzIE5vbmU6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcigidGFzayBtdXN0IGJlIGNob3NlbiBpbiBvcmRlciB0byBkZXRlcm1pbmUgdGhlIGNvcnJlY3QgbW9kZWwiKQogICAgICAgICAgICByYWlzZSBFeGNlcHRpb24oInRoaXMgZnVuY3Rpb24gcmVxdWlyZXMgZWl0aGVyIGEgc3VwcG9ydGVkIHRhc2sgb3IgYSBtb2RlbCBhbmQgbW9kZWwgY2xhc3MgdG8gYmUgY2hvc2VuIikKCiAgICAgICAgXywgYXZhaWxhYmxlX2NsYXNzZXMsIHRhc2tfb3B0aW9ucyA9IHRyYW5zZm9ybWVycy5waXBlbGluZXMuY2hlY2tfdGFzayh0YXNrKQoKICAgICAgICBpZiBpc2luc3RhbmNlKG1vZGVsLCBzdHIpOgogICAgICAgICAgICBtb2RlbF9uYW1lID0gbW9kZWwKCiAgICAgICAgIyBpZiBtb2RlbCBpcyBub3QgZ2l2ZW4sIHdlIHRha2UgdGhlIGRlZmF1bHQgbW9kZWwgZm9yIHRoZSBnaXZlbiB0YXNrCiAgICAgICAgZWxzZToKICAgICAgICAgICAgbW9kZWxfbmFtZSwgXyA9IHRyYW5zZm9ybWVycy5waXBlbGluZXMuZ2V0X2RlZmF1bHRfbW9kZWxfYW5kX3JldmlzaW9uKAogICAgICAgICAgICAgICAgYXZhaWxhYmxlX2NsYXNzZXMsIGZyYW1ld29yaywgdGFza19vcHRpb25zCiAgICAgICAgICAgICkKICAgICAgICBpZiBub3QgYXZhaWxhYmxlX2NsYXNzZXMuZ2V0KGZyYW1ld29yaywgdHVwbGUoKSk6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcigiZ2l2ZW4gdGFzaydzIGRlZmF1bHQgbW9kZWwgaXMgbm90IHN1cHBvcnRlZCBpbiBzcGVjaWZpZWQgZnJhbWV3b3JrIikKICAgICAgICAgICAgcmFpc2UgRXhjZXB0aW9uKCJ0aGlzIGZ1bmN0aW9uIHJlcXVpcmVzIGVpdGhlciBhIHN1cHBvcnRlZCB0YXNrIG9yIGEgbW9kZWwgYW5kIG1vZGVsIGNsYXNzIHRvIGJlIGNob3NlbiIpCgogICAgICAgIG1vZGVsX2NsYXNzID0gYXZhaWxhYmxlX2NsYXNzZXNbZnJhbWV3b3JrXVswXQoKICAgICMgbG9hZCB0aGUgcHJldHJhaW5lZCBtb2RlbAogICAgaWYgdXNlX2N1ZGE6CiAgICAgICAgZGV2aWNlX21hcCA9IGRldmljZV9tYXAKICAgIGVsc2U6CiAgICAgICAgZGV2aWNlX21hcCA9IE5vbmUKCiAgICBtb2RlbCA9IG1vZGVsX2NsYXNzLmZyb21fcHJldHJhaW5lZChtb2RlbF9uYW1lLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcXVhbnRpemF0aW9uX2NvbmZpZz1xdWFudGl6YXRpb25fY29uZmlnLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGV2aWNlX21hcD1kZXZpY2VfbWFwLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKiptb2RlbF9wcmV0cmFpbmVkX2NvbmZpZykKCiAgICAjIElmIHF1YW50aXphdGlvbiBjb25maWcgaXMgZ2l2ZW4gd2Ugd2lsbCBsb2FkIGEgcXVhbnRpemVkIG1vZGVsLCBpZiBub3QgYSByZWd1bGFyIG9uZQogICAgaWYgcXVhbnRpemF0aW9uX2NvbmZpZzoKICAgICAgICBtb2RlbC5ncmFkaWVudF9jaGVja3BvaW50aW5nX2VuYWJsZSgpCiAgICAgICAgbW9kZWwgPSBwZWZ0LnByZXBhcmVfbW9kZWxfZm9yX2tiaXRfdHJhaW5pbmcobW9kZWwpCgogICAgIyBJZiBsb3JhIGNvbmZpZyB3YXMgZ2l2ZW4gd2Ugd2FudCB0byBkbyBsb3JhIGZpbmUgdHVuZSwgd2UgdXBkYXRlIG1vZGVsIGhlcmUKICAgIGlmIGxvcmFfY29uZmlnOgogICAgICAgIG1vZGVsID0gcGVmdC5nZXRfcGVmdF9tb2RlbChtb2RlbCwgbG9yYV9jb25maWcpCgogICAgIyBpZiBub3Qgc3BlY2lmaWVkIHdlIGNob29zZSB0aGUgZGVmYXVsdCB0b2tlbml6ZXIgdGhhdCBjb3JyZXNwb25kaW5nIHRvIHRoZSBtb2RlbAogICAgaWYgdG9rZW5pemVyIGlzIE5vbmU6CiAgICAgICAgdG9rZW5pemVyID0gdHJhbnNmb3JtZXJzLkF1dG9Ub2tlbml6ZXIuZnJvbV9wcmV0cmFpbmVkKG1vZGVsX25hbWUpCiAgICAgICAgcmV0dXJuIG1vZGVsX25hbWUsIG1vZGVsLCB0b2tlbml6ZXIKCiAgICBpZiBpc2luc3RhbmNlKHRva2VuaXplciwgc3RyKToKICAgICAgICB0b2tlbml6ZXJfbmFtZSA9IHRva2VuaXplcgogICAgICAgIHRva2VuaXplcl9jbGFzcyA9IHRyYW5zZm9ybWVycy5BdXRvVG9rZW5pemVyCgogICAgIyBpZiBpdCdzIG5vdCBhIHN0ciB0aGVuIGl0J3MgYSB0dXBsZSBvZiBib3RoIG5hbWUgYW5kIGNsYXNzCiAgICBlbHNlOgogICAgICAgIHRva2VuaXplcl9uYW1lLCB0b2tlbml6ZXJfY2xhc3MgPSB0b2tlbml6ZXIKICAgICAgICB0b2tlbml6ZXJfY2xhc3MgPSBnZXRfY2xhc3Nfb2JqZWN0KHRva2VuaXplcl9jbGFzcykKCiAgICB0b2tlbml6ZXIgPSB0b2tlbml6ZXJfY2xhc3MuZnJvbV9wcmV0cmFpbmVkKHRva2VuaXplcl9uYW1lLCAqKnRva2VuaXplcl9wcmV0cmFpbmVkX2NvbmZpZykKCiAgICBpZiBub3QgdG9rZW5pemVyLnBhZF90b2tlbjoKICAgICAgICB0b2tlbml6ZXIucGFkX3Rva2VuID0gdG9rZW5pemVyLmVvc190b2tlbgoKICAgIHJldHVybiBtb2RlbF9uYW1lLCBtb2RlbCwgdG9rZW5pemVyCgoKZGVmIGRhdGFzZXRfbG9hZGVyKGRhdGFzZXQ6IHN0ciwgaXNfdHJhaW46IGJvb2wgPSBUcnVlLCAqKmt3YXJncykgLT4gRGF0YXNldDoKICAgICIiIgogICAgbG9hZHMgdGhlIHNwZWNpZmljIGRhdGFzZXQgcHJvdmlkZWQgYnkgdGhlIHVzZXIKCiAgICA6cGFyYW0gZGF0YXNldDogbmFtZSBvciBwYXRoIG9mIGRhdGFzZXQgdG8gbG9hZAogICAgOnBhcmFtIGlzX3RyYWluOiBib29sIHRoYXQgaW5kaWNhdGVzIHRoZSBwdXJwb3NlIG9mIHRoZSBkYXRhc2V0CiAgICA6cGFyYW0ga3dhcmdzOiBvdGhlciBrd2FyZ3MgZm9yIGxvYWRpbmcgdGhlIGRhdGFzZXQKCiAgICA6cmV0dXJuIGxvYWRlZCBkYXRhc2V0CiAgICAiIiIKICAgICMgaWYgc3BsaXQgaW4ga3dhcmdzIHRoZW4gdGhlIHVzZXIgZGVjaWRlcyBob3cgdG8gc3BsaXQgdGhlIGRhdGFzZXQKICAgIGlmICJzcGxpdCIgaW4ga3dhcmdzOgogICAgICAgIHJldHVybiBsb2FkX2RhdGFzZXQoZGF0YXNldCwgKiprd2FyZ3MpCgogICAgIyBpZiBpdCdzIGEgZGF0YXNldCBmb3IgdHJhaW4gd2Ugc3BsaXQgd2l0aCB0cmFpbgogICAgaWYgaXNfdHJhaW46CiAgICAgICAgcmV0dXJuIGxvYWRfZGF0YXNldChkYXRhc2V0LCBzcGxpdD0idHJhaW4iLCAqKmt3YXJncykKCiAgICAjIGlmIGl0J3MgZXZhbCBkYXRhc2V0LCB0aGVuIGEgbG90IG9mIG5hbWVzIGFyZSBhY2NlcHRhYmxlIGZvciB0aGUgc2V0IGFuZCB3ZSBjaGVjayBhbGwgb2YgdGhlbQogICAgZGF0YXNldCA9IGxvYWRfZGF0YXNldChkYXRhc2V0LCAqKmt3YXJncykKICAgIGlmICJ0ZXN0IiBpbiBkYXRhc2V0OgogICAgICAgIHJldHVybiBkYXRhc2V0LmdldCgidGVzdCIpCiAgICBlbGlmICJldmFsIiBpbiBkYXRhc2V0OgogICAgICAgIHJldHVybiBkYXRhc2V0LmdldCgiZXZhbCIpCiAgICBlbGlmICJ2YWxpZGF0aW9uIiBpbiBkYXRhc2V0OgogICAgICAgIHJldHVybiBkYXRhc2V0LmdldCgidmFsaWRhdGlvbiIpCgoKZGVmIHByZXBhcmVfZGF0YXNldCh0cmFpbl9kYXRhc2V0OiBzdHIsIGV2YWxfZGF0YXNldDogc3RyLCB0cmFpbl9sb2FkX2RhdGFzZXRfa3dhcmdzLCBldmFsX2xvYWRfZGF0YXNldF9rd2FyZ3MsCiAgICAgICAgICAgICAgICAgICAgdG9rZW5pemVyLCBkYXRhc2V0X2NvbHVtbnNfdG9fdHJhaW46IFVuaW9uW3N0ciwgbGlzdF0pIC0+IChEYXRhc2V0LCBVbmlvbltEYXRhc2V0LCBOb25lXSk6CiAgICAiIiIKICAgIExvYWRzIHRoZSB0cmFpbiBhbmQgZXZhbCBkYXRhc2V0cyAoaWYgcHJvdmlkZWQpIHBhc3NlcyB0aGVtIHRocm91Z2ggdGhlIHRva2VuaXplciBhbmQKICAgIHJldHVybnMgdGhlbSByZWFkeSB0byB1c2UgaW4gdHJhaW5pbmcKCiAgICA6cGFyYW0gdHJhaW5fZGF0YXNldDogdGhlIG5hbWUgb3IgcGF0aCB0byB0aGUgdHJhaW4gZGF0YXNldAogICAgOnBhcmFtIGV2YWxfZGF0YXNldDogdGhlIG5hbWUgb3IgcGF0aCB0byB0aGUgZXZhbCBkYXRhc2V0CiAgICA6cGFyYW0gZGF0YXNldF9jb2x1bW5zX3RvX3RyYWluOiB3aGljaCBjb2x1bW5zIHRvIHBhc3MgdG8gdGhlIG1vZGVsIGFzIGlucHV0cwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKG5lZWQgdG8gcGFzcyB0aHJvdWdoIHRoZSB0b2tlbml6ZXIgZmlyc3QpCiAgICA6cGFyYW0gdHJhaW5fbG9hZF9kYXRhc2V0X2t3YXJnczoga3dhcmdzIGZvciBkYXRhc2V0IGxvYWRpbmcKICAgIDpwYXJhbSBldmFsX2xvYWRfZGF0YXNldF9rd2FyZ3M6IGt3YXJncyBmb3IgZGF0YXNldCBsb2FkaW5nCiAgICA6cGFyYW0gdG9rZW5pemVyOiB0aGUgdG9rZW5pemVyIHRvIHBhc3MgdGhlIGRhdGEgdGhyb3VnaAoKICAgIDpyZXR1cm4gdG9rZW5pemVkIGRhdGFzZXRzCiAgICAiIiIKICAgICMgd2UgdGFrZSBjb2wgbmFtZS9zIGluIGEgbGlzdCBmb3IgZWFzeSBnZW5lcmFsaXphdGlvbgogICAgaWYgaXNpbnN0YW5jZShkYXRhc2V0X2NvbHVtbnNfdG9fdHJhaW4sIHN0cik6CiAgICAgICAgZGF0YXNldF9jb2x1bW5zX3RvX3RyYWluID0gW2RhdGFzZXRfY29sdW1uc190b190cmFpbl0KCiAgICAjIExvYWQgZGF0YXNldHMKICAgICMgaWYgcHJvdmlkZWQgdHdvIHBhdGhzL25hbWVzIHdlIGxvYWQgZWFjaCBzZXBhcmF0ZWx5IHVzaW5nIGRlc2lnbmF0ZWQgZnVuYwogICAgaWYgZXZhbF9kYXRhc2V0OgogICAgICAgIHRyYWluX2RhdGFzZXQgPSBkYXRhc2V0X2xvYWRlcihkYXRhc2V0PXRyYWluX2RhdGFzZXQsIGlzX3RyYWluPVRydWUsICoqdHJhaW5fbG9hZF9kYXRhc2V0X2t3YXJncykKICAgICAgICBldmFsX2RhdGFzZXQgPSBkYXRhc2V0X2xvYWRlcihkYXRhc2V0PWV2YWxfZGF0YXNldCwgaXNfdHJhaW49RmFsc2UsICoqZXZhbF9sb2FkX2RhdGFzZXRfa3dhcmdzKQoKICAgICMgaWYgb25seSBvbiBwYXRoIGlzIGdpdmVuIHRoZW4gd2UgbXVzdCBjaGVjayBpZiBpdCBjb250YWlucyBib3RoIGRhdGFzZXQgb3IgaWYgb25seSBvbmUgc2hvdWxkIGJlIHVzZWQKICAgIGVsc2U6CiAgICAgICAgZGF0YXNldCA9IGxvYWRfZGF0YXNldCh0cmFpbl9kYXRhc2V0LCAqKnRyYWluX2xvYWRfZGF0YXNldF9rd2FyZ3MpCiAgICAgICAgaWYgInRyYWluIiBpbiBkYXRhc2V0OgogICAgICAgICAgICB0cmFpbl9kYXRhc2V0ID0gZGF0YXNldC5nZXQoInRyYWluIikKICAgICAgICAgICAgaWYgInRlc3QiIGluIGRhdGFzZXQ6CiAgICAgICAgICAgICAgICBldmFsX2RhdGFzZXQgPSBkYXRhc2V0LmdldCgidGVzdCIpCiAgICAgICAgICAgIGVsaWYgImV2YWwiIGluIGRhdGFzZXQ6CiAgICAgICAgICAgICAgICBldmFsX2RhdGFzZXQgPSBkYXRhc2V0LmdldCgiZXZhbCIpCiAgICAgICAgICAgIGVsaWYgInZhbGlkYXRpb24iIGluIGRhdGFzZXQ6CiAgICAgICAgICAgICAgICBldmFsX2RhdGFzZXQgPSBkYXRhc2V0LmdldCgidmFsaWRhdGlvbiIpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAjIG9ubHkgdHJhaW4gZGF0YXNldCBnaXZlbiwgdG9rZW5pemUgYW5kIHJldHVybiBpdAogICAgICAgICAgICAgICAgcmV0dXJuIHRyYWluX2RhdGFzZXQubWFwKAogICAgICAgICAgICAgICAgICAgIGxhbWJkYSBleGFtcGxlczogdG9rZW5pemVyKCpbZXhhbXBsZXNbY29sXSBmb3IgY29sIGluIGRhdGFzZXRfY29sdW1uc190b190cmFpbl0sIHRydW5jYXRpb249VHJ1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYWRkaW5nPVRydWUpLAogICAgICAgICAgICAgICAgICAgIGJhdGNoZWQ9VHJ1ZSwgKSwgTm9uZQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcigidHJhaW4gZGF0YXNldCBpcyBtYW5kYXRvcnkiKQogICAgICAgICAgICByYWlzZSBLZXlFcnJvcigibm8gdHJhaW4gZGF0YXNldCBmb3VuZCBpbiBnaXZlbiBkYXRhc2V0IikKCiAgICAjIFRva2VuaXplIHRoZSBkYXRhIHNvIHRoZSBtb2RlbCBjYW4gdW5kZXJzdGFuZCBpdAogICAgdG9rZW5pemVkX3RyYWluX2RhdGFzZXQgPSB0cmFpbl9kYXRhc2V0Lm1hcCgKICAgICAgICBsYW1iZGEgZXhhbXBsZXM6IHRva2VuaXplcigqW2V4YW1wbGVzW2NvbF0gZm9yIGNvbCBpbiBkYXRhc2V0X2NvbHVtbnNfdG9fdHJhaW5dLCB0cnVuY2F0aW9uPVRydWUsIHBhZGRpbmc9VHJ1ZSksCiAgICAgICAgYmF0Y2hlZD1UcnVlLAogICAgKQoKICAgIHRva2VuaXplZF9ldmFsX2RhdGFzZXQgPSBldmFsX2RhdGFzZXQubWFwKAogICAgICAgIGxhbWJkYSBleGFtcGxlczogdG9rZW5pemVyKCpbZXhhbXBsZXNbY29sXSBmb3IgY29sIGluIGRhdGFzZXRfY29sdW1uc190b190cmFpbl0sIHRydW5jYXRpb249VHJ1ZSwgcGFkZGluZz1UcnVlKSwKICAgICAgICBiYXRjaGVkPVRydWUsCiAgICApCgogICAgcmV0dXJuIHRva2VuaXplZF90cmFpbl9kYXRhc2V0LCB0b2tlbml6ZWRfZXZhbF9kYXRhc2V0CgoKZGVmIGZpbmV0dW5lX2xsbSgKICAgICAgICBjb250ZXh0OiBtbHJ1bi5NTENsaWVudEN0eCwKICAgICAgICB0cmFpbl9kYXRhc2V0OiBzdHIsCiAgICAgICAgZXZhbF9kYXRhc2V0OiBzdHIgPSBOb25lLAogICAgICAgIHRyYWluX2xvYWRfZGF0YXNldF9rd2FyZ3M6IGRpY3QgPSB7fSwKICAgICAgICBldmFsX2xvYWRfZGF0YXNldF9rd2FyZ3M6IGRpY3QgPSB7fSwKICAgICAgICBkYXRhc2V0X2NvbHVtbnNfdG9fdHJhaW46IFVuaW9uW3N0ciwgbGlzdF0gPSAidGV4dCIsCiAgICAgICAgbW9kZWw6IFVuaW9uW3N0ciwgVHVwbGVbc3RyLCBzdHJdXSA9ICJodWdnaW5nZmFjZS1tb2RlbCIsCiAgICAgICAgdG9rZW5pemVyOiBVbmlvbltzdHIsIFR1cGxlW3N0ciwgc3RyXV0gPSBOb25lLAogICAgICAgIGRlZXBzcGVlZF9jb25maWc6IFVuaW9uW2RpY3QsIGJvb2xdID0gRmFsc2UsCiAgICAgICAgcXVhbnRpemF0aW9uX2NvbmZpZzogVW5pb25bZGljdCwgYm9vbF0gPSBGYWxzZSwKICAgICAgICBsb3JhX2NvbmZpZzogVW5pb25bZGljdCwgYm9vbF0gPSBGYWxzZSwKICAgICAgICB0cmFpbmluZ19jb25maWc6IGRpY3QgPSB7fSwKICAgICAgICBtb2RlbF9wcmV0cmFpbmVkX2NvbmZpZzogZGljdCA9IHt9LAogICAgICAgIHRva2VuaXplcl9wcmV0cmFpbmVkX2NvbmZpZzogZGljdCA9IHt9LAogICAgICAgIGRhdGFfY29sbGF0b3JfY29uZmlnOiBkaWN0ID0ge30sCiAgICAgICAgdGFzazogc3RyID0gInRleHQtZ2VuZXJhdGlvbiIsCiAgICAgICAgdXNlX2N1ZGE6IGJvb2wgPSBUcnVlLAogICAgICAgIGZyYW1ld29yazogc3RyID0gInB0IiwKICAgICAgICBkZXZpY2VfbWFwOiBzdHIgPSAiYXV0byIsCiAgICAgICAgKiprd2FyZ3MsCik6CiAgICAiIiIKICAgIEZpbmUtdHVuZXMgYSBMYW5ndWFnZSBNb2RlbCAoTExNKSBvbiBhIHNwZWNpZmljIHRhc2sgdXNpbmcgdGhlIHByb3ZpZGVkIGRhdGFzZXQuCiAgICAgVGhlIGZ1bmN0aW9uIHRha2VzIHZhcmlvdXMgY29uZmlndXJhdGlvbiBwYXJhbWV0ZXJzIHRvIGN1c3RvbWl6ZSB0aGUgdHJhaW5pbmcgcHJvY2VzcwogICAgIGFuZCBhZGFwdCB0aGUgbW9kZWwgdG8gc3BlY2lmaWMgdGFza3MgdXNpbmcgYSBwcm92aWRlZCBkYXRhc2V0LgoKICAgIDpwYXJhbSBjb250ZXh0OiBtbHJ1biBjb250ZXh0IGluIG9yZGVyIHRvIGxvZyB0cmFpbmVkIG1vZGVsCiAgICA6cGFyYW0gZGF0YXNldF9jb2x1bW5zX3RvX3RyYWluOiB3aGljaCBjb2x1bW5zIHRvIHBhc3MgdG8gdGhlIG1vZGVsIGFzIGlucHV0cwogICAgOnBhcmFtIGV2YWxfbG9hZF9kYXRhc2V0X2t3YXJnczoga3dhcmdzIGZvciBkYXRhc2V0IGxvYWRpbmcKICAgIDpwYXJhbSB0cmFpbl9sb2FkX2RhdGFzZXRfa3dhcmdzOiBrd2FyZ3MgZm9yIGRhdGFzZXQgbG9hZGluZwogICAgOnBhcmFtIGZyYW1ld29yazogcHQgb3QgdGYKICAgIDpwYXJhbSB1c2VfY3VkYTogdXNlIGdwdSBvciBub3QKICAgIDpwYXJhbSB0b2tlbml6ZXJfcHJldHJhaW5lZF9jb25maWc6IGNvbmZpZyB0byBsb2FkIHRoZSBwcmV0cmFpbmVkIHRva2VuaXplcgogICAgOnBhcmFtIG1vZGVsX3ByZXRyYWluZWRfY29uZmlnOiBjb25maWcgdG8gbG9hZCB0aGUgcHJldHJhaW5lZCBtb2RlbAogICAgOnBhcmFtIHRva2VuaXplcjogYSB0dXBsZSBjb250YWluaW5nIHRva2VuaXplciBuYW1lIGFuZCBjbGFzcywgb3Igc3RyIHdpdGggdG9rZW5pemVyIG5hbWUgb3IgcGF0aAogICAgOnBhcmFtIG1vZGVsOiBhIHR1cGxlIGNvbnRhaW5pbmcgbW9kZWwgbmFtZSBhbmQgY2xhc3MsIG9yIHN0ciB3aXRoIG1vZGVsIG5hbWUgb3IgcGF0aAogICAgOnBhcmFtIHRyYWluX2RhdGFzZXQ6IFRoZSB0cmFpbiBkYXRhc2V0IHVzZWQgZm9yIGZpbmUtdHVuaW5nIHRoZSBsYW5ndWFnZSBtb2RlbC4KICAgIDpwYXJhbSBldmFsX2RhdGFzZXQ6IFRoZSBldmFsIGRhdGFzZXQgdXNlZCBmb3IgZXZhbHVhdGUgdGhlIGxhbmd1YWdlIG1vZGVsIGR1cmluZyB0cmFpbmluZy4KICAgIDpwYXJhbSBkZWVwc3BlZWRfY29uZmlnOiBDb25maWd1cmF0aW9uIG9wdGlvbnMgZm9yIERlZXBTcGVlZCAob3B0aW9uYWwpLgogICAgOnBhcmFtIHF1YW50aXphdGlvbl9jb25maWc6IENvbmZpZ3VyYXRpb24gb3B0aW9ucyBmb3IgbW9kZWwgcXVhbnRpemF0aW9uIChvcHRpb25hbCkuCiAgICA6cGFyYW0gbG9yYV9jb25maWc6IENvbmZpZ3VyYXRpb24gb3B0aW9ucyBmb3IgTG93LVJhbmsgQXBwcm94aW1hdGlvbiAoTG9SQSkgKG9wdGlvbmFsKS4KICAgIDpwYXJhbSB0cmFpbmluZ19jb25maWc6IENvbmZpZ3VyYXRpb24gb3B0aW9ucyBzcGVjaWZpYyB0byB0aGUgZmluZS10dW5pbmcgdHJhaW5pbmcgcHJvY2VzcyAob3B0aW9uYWwpLgogICAgOnBhcmFtIGRhdGFfY29sbGF0b3JfY29uZmlnOiBDb25maWd1cmF0aW9uIG9wdGlvbnMgZm9yIGRhdGEgY29sbGF0aW9uIGR1cmluZyB0cmFpbmluZyAob3B0aW9uYWwpLgogICAgOnBhcmFtIHRhc2s6IEEgZGVzY3JpcHRpb24gb2YgdGhlIHNwZWNpZmljIHRhc2sgdGhlIG1vZGVsIGlzIGJlaW5nIGZpbmUtdHVuZWQgZm9yLgogICAgOnBhcmFtIGt3YXJnczogQWRkaXRpb25hbCBrZXl3b3JkIGFyZ3VtZW50cy4KICAgICIiIgoKICAgICMgVE9ETzogbWF0Y2ggZm9yd2FyZC5rZXl3b3JkIHRvIGRhdGFzZXQua2V5d29yZCAtIGNoZWNrIGlmIHJlbGV2YW50IGluIG5ldyBkZXNpZ24KICAgICMgVE9ETzogYWRkIHdhcm5pbmcgZm9yIGxhYmVsLCBhbmQgYWRkIG9wdGlvbiB0byBtb2RpZnkgZGF0YXNldCBjb2wgbmFtZXMgLSBjaGVjayBpZiByZWxldmFudCBpbiBuZXcgZGVzaWduCgogICAgIyBMb29rIGZvciB1cGRhdGVzIHRvIGNvbmZpZ3MgZ2l2ZW4gaW4ga3dhcmdzCiAgICBjb25maWdzID0gewogICAgICAgIENvbmZpZ0tleXMuZGVlcHNwZWVkOiBkZWVwc3BlZWRfY29uZmlnLAogICAgICAgIENvbmZpZ0tleXMucXVhbnRpemF0aW9uOiBxdWFudGl6YXRpb25fY29uZmlnLAogICAgICAgIENvbmZpZ0tleXMubG9yYTogbG9yYV9jb25maWcsCiAgICAgICAgQ29uZmlnS2V5cy50cmFpbmluZzogdHJhaW5pbmdfY29uZmlnLAogICAgICAgIENvbmZpZ0tleXMubW9kZWxfcHJldHJhaW5lZDogbW9kZWxfcHJldHJhaW5lZF9jb25maWcsCiAgICAgICAgQ29uZmlnS2V5cy50b2tlbml6ZXJfcHJldHJhaW5lZDogdG9rZW5pemVyX3ByZXRyYWluZWRfY29uZmlnLAogICAgICAgIENvbmZpZ0tleXMuZGF0YV9jb2xsYXRvcjogZGF0YV9jb2xsYXRvcl9jb25maWcsCiAgICB9CiAgICB1cGRhdGVfY29uZmlnKGRzdD1jb25maWdzLCBzcmM9a3dhcmdzKQoKICAgICMgY2hlY2sgZ3B1IHBlcm1pc3Npb24gYW5kIGF2YWlsYWJpbGl0eQogICAgaWYgdXNlX2N1ZGE6CiAgICAgICAgaWYgdG9yY2guY3VkYS5pc19hdmFpbGFibGUoKToKICAgICAgICAgICAgIyBDbGVhbiBncHUgY2FjaGUKICAgICAgICAgICAgdG9yY2guY3VkYS5lbXB0eV9jYWNoZSgpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoIid1c2VfY3VkYScgaXMgc2V0IHRvIFRydWUsIGJ1dCBubyBjdWRhIGRldmljZSBpcyBhdmFpbGFibGUiKQoKICAgICMgZ2V0IG1vZGVsIGFuZCB0b2tlbml6ZXIKICAgIG1vZGVsX25hbWUsIG1vZGVsLCB0b2tlbml6ZXIgPSBzZXRfbW9kZWxfYW5kX3Rva2VuaXplcigKICAgICAgICBtb2RlbD1tb2RlbCwKICAgICAgICB0b2tlbml6ZXI9dG9rZW5pemVyLAogICAgICAgIHRhc2s9dGFzaywKICAgICAgICBmcmFtZXdvcms9ZnJhbWV3b3JrLAogICAgICAgIGxvcmFfY29uZmlnPWNvbmZpZ3NbQ29uZmlnS2V5cy5sb3JhXSwKICAgICAgICBxdWFudGl6YXRpb25fY29uZmlnPWNvbmZpZ3NbQ29uZmlnS2V5cy5xdWFudGl6YXRpb25dLAogICAgICAgIHVzZV9jdWRhPXVzZV9jdWRhLAogICAgICAgIHRva2VuaXplcl9wcmV0cmFpbmVkX2NvbmZpZz10b2tlbml6ZXJfcHJldHJhaW5lZF9jb25maWcsCiAgICAgICAgbW9kZWxfcHJldHJhaW5lZF9jb25maWc9Y29uZmlnc1tDb25maWdLZXlzLm1vZGVsX3ByZXRyYWluZWRdLAogICAgICAgIGRldmljZV9tYXA9ZGV2aWNlX21hcCwKICAgICkKCgogICAgIyBMb2FkIGRhdGFzZXRzCiAgICB0b2tlbml6ZWRfdHJhaW4sIHRva2VuaXplZF9ldmFsID0gcHJlcGFyZV9kYXRhc2V0KHRyYWluX2RhdGFzZXQ9dHJhaW5fZGF0YXNldCwgZXZhbF9kYXRhc2V0PWV2YWxfZGF0YXNldCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJhaW5fbG9hZF9kYXRhc2V0X2t3YXJncz10cmFpbl9sb2FkX2RhdGFzZXRfa3dhcmdzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBldmFsX2xvYWRfZGF0YXNldF9rd2FyZ3M9ZXZhbF9sb2FkX2RhdGFzZXRfa3dhcmdzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b2tlbml6ZXI9dG9rZW5pemVyLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhc2V0X2NvbHVtbnNfdG9fdHJhaW49ZGF0YXNldF9jb2x1bW5zX3RvX3RyYWluKQoKICAgICMgSW5pdGlhbGl6ZSB0aGUgZGF0YSBjb2xsYXRvciBmb3IgdGhlIHRyYWluZXIgdG8gdXNlIGluIG9yZGVyIHRvIGNyZWF0ZSBiYXRjaGVzIG9mIGRhdGEKICAgIGRhdGFfY29sbGF0b3IgPSB0cmFuc2Zvcm1lcnMuRGF0YUNvbGxhdG9yRm9yTGFuZ3VhZ2VNb2RlbGluZygKICAgICAgICB0b2tlbml6ZXI9dG9rZW5pemVyLCBtbG09RmFsc2UsICoqZGF0YV9jb2xsYXRvcl9jb25maWcKICAgICkKCiAgICAjIEluaXRpYWxpemUgdHJhaW5pbmcga3dhcmdzIGZyb20gdXNlciBrd2FyZ3M6CiAgICB0cmFpbl9rd2FyZ3MgPSBjb25maWdzW0NvbmZpZ0tleXMudHJhaW5pbmddCgogICAgIyBJZiBkZWVwc3BlZWQgY29uZmlnIGdpdmVuIHdlIGFkZCBpdCB0byB0cmFpbmluZyBrd2FyZ3MKICAgIGlmIGNvbmZpZ3NbQ29uZmlnS2V5cy5kZWVwc3BlZWRdOgogICAgICAgIHRyYWluX2t3YXJnc1siZGVlcHNwZWVkIl0gPSBjb25maWdzW0NvbmZpZ0tleXMuZGVlcHNwZWVkXQoKICAgICMgVGFrZSBhIGxvb2sgYXQgdGhlIHRyYWluYWJsZSBwYXJhbWV0ZXJzIGluIHRoZSBtb2RlbAogICAgcHJpbnRfdHJhaW5hYmxlX3BhcmFtZXRlcnMobW9kZWwpCgogICAgIyBQcmVwYXJpbmcgdHJhaW5pbmcgYXJndW1lbnRzOgogICAgdHJhaW5pbmdfYXJncyA9IHRyYW5zZm9ybWVycy5UcmFpbmluZ0FyZ3VtZW50cygKICAgICAgICBvdXRwdXRfZGlyPXRlbXBmaWxlLm1rZHRlbXAoKSwKICAgICAgICAqKnRyYWluX2t3YXJncywKICAgICkKCiAgICB0cmFpbmVyID0gdHJhbnNmb3JtZXJzLlRyYWluZXIoCiAgICAgICAgbW9kZWw9bW9kZWwsCiAgICAgICAgdHJhaW5fZGF0YXNldD10b2tlbml6ZWRfdHJhaW4sCiAgICAgICAgZXZhbF9kYXRhc2V0PXRva2VuaXplZF9ldmFsLAogICAgICAgIHRva2VuaXplcj10b2tlbml6ZXIsCiAgICAgICAgZGF0YV9jb2xsYXRvcj1kYXRhX2NvbGxhdG9yLAogICAgICAgIGFyZ3M9dHJhaW5pbmdfYXJncywKICAgICkKCiAgICBhcHBseV9tbHJ1bih0cmFpbmVyLCBtb2RlbF9uYW1lPW1vZGVsX25hbWUpCiAgICBtb2RlbC5jb25maWcudXNlX2NhY2hlID0gKAogICAgICAgIEZhbHNlICAjIHNpbGVuY2UgdGhlIHdhcm5pbmdzLiBQbGVhc2UgcmUtZW5hYmxlIGZvciBpbmZlcmVuY2UhCiAgICApCgogICAgIyBBcHBseSB0cmFpbmluZyB3aXRoIGV2YWx1YXRpb246CiAgICBjb250ZXh0LmxvZ2dlci5pbmZvKGYidHJhaW5pbmcgJ3ttb2RlbF9uYW1lfSciKQogICAgdHJhaW5lci50cmFpbigpCgogICAgdGVtcF9kaXJlY3RvcnkgPSB0ZW1wZmlsZS5UZW1wb3JhcnlEaXJlY3RvcnkoKS5uYW1lCiAgICB0cmFpbmVyLnNhdmVfbW9kZWwodGVtcF9kaXJlY3RvcnkpCgogICAgIyBaaXAgdGhlIG1vZGVsIGRpcmVjdG9yeToKICAgIHNodXRpbC5tYWtlX2FyY2hpdmUoCiAgICAgICAgYmFzZV9uYW1lPSJtb2RlbCIsCiAgICAgICAgZm9ybWF0PSJ6aXAiLAogICAgICAgIHJvb3RfZGlyPXRlbXBfZGlyZWN0b3J5LAogICAgKQoKICAgICMgTG9nIHRoZSBtb2RlbDoKICAgIGNvbnRleHQubG9nX21vZGVsKAogICAgICAgIGtleT0ibW9kZWwiLAogICAgICAgIGRiX2tleT1tb2RlbF9uYW1lLAogICAgICAgIG1vZGVsX2ZpbGU9Im1vZGVsLnppcCIsCiAgICAgICAgdGFnPSIiLAogICAgICAgIGZyYW1ld29yaz0iSHVnZ2luZyBGYWNlIiwKICAgICkKCgpkZWYgZXZhbHVhdGUoCiAgICBjb250ZXh0LAogICAgbW9kZWxfcGF0aCwKICAgIGRhdGE6IHBkLkRhdGFGcmFtZSwKICAgIG1vZGVsX25hbWU6IHN0ciA9IE5vbmUsCiAgICB0b2tlbml6ZXJfbmFtZTogc3RyID0gTm9uZSwKKToKICAgICIiIgogICAgRXZhbHVhdGluZyB0aGUgbW9kZWwgdXNpbmcgcGVycGxleGl0eSwgZm9yIG1vcmUgaW5mb3JtYXRpb24gdmlzaXQ6CiAgICBodHRwczovL2h1Z2dpbmdmYWNlLmNvL2RvY3MvdHJhbnNmb3JtZXJzL3BlcnBsZXhpdHkKCiAgICA6cGFyYW0gY29udGV4dDogICAgIG1scnVuIGNvbnRleHQKICAgIDpwYXJhbSBtb2RlbF9wYXRoOiAgcGF0aCB0byB0aGUgbW9kZWwgZGlyZWN0b3J5CiAgICA6cGFyYW0gZGF0YTogICAgICAgIHRoZSBkYXRhIHRvIGV2YWx1YXRlIHRoZSBtb2RlbAogICAgOnBhcmFtIG1vZGVsX25hbWU6ICBuYW1lIG9mIGJhc2UgbW9kZWwKICAgIDpwYXJhbSB0b2tlbml6ZXJfbmFtZTogbmFtZSBvZiBiYXNlIHRva2VuaXplcgogICAgIiIiCiAgICAjIEdldCB0aGUgbW9kZWwgYXJ0aWZhY3QgYW5kIGZpbGU6CiAgICAoCiAgICAgICAgbW9kZWxfZmlsZSwKICAgICAgICBtb2RlbF9hcnRpZmFjdCwKICAgICAgICBleHRyYV9kYXRhLAogICAgKSA9IG1scnVuLmFydGlmYWN0cy5nZXRfbW9kZWwobW9kZWxfcGF0aCkKCiAgICAjIFJlYWQgdGhlIG5hbWU6CiAgICBfbW9kZWxfbmFtZSA9IG1vZGVsX2FydGlmYWN0LnNwZWMuZGJfa2V5CgogICAgIyBFeHRyYWN0IGxvZ2dlZCBtb2RlbCBmaWxlczoKICAgIG1vZGVsX2RpcmVjdG9yeSA9IG9zLnBhdGguam9pbihvcy5wYXRoLmRpcm5hbWUobW9kZWxfZmlsZSksIF9tb2RlbF9uYW1lKQogICAgd2l0aCB6aXBmaWxlLlppcEZpbGUobW9kZWxfZmlsZSwgInIiKSBhcyB6aXBfZmlsZToKICAgICAgICB6aXBfZmlsZS5leHRyYWN0YWxsKG1vZGVsX2RpcmVjdG9yeSkKCiAgICAjIExvYWRpbmcgdGhlIHNhdmVkIHByZXRyYWluZWQgdG9rZW5pemVyIGFuZCBtb2RlbDoKICAgIGRhdGFzZXQgPSBEYXRhc2V0LmZyb21fcGFuZGFzKGRhdGEpCiAgICB0b2tlbml6ZXIgPSBBdXRvVG9rZW5pemVyLmZyb21fcHJldHJhaW5lZCh0b2tlbml6ZXJfbmFtZSkKICAgIHBhZF90b2tlbl9pZCA9IHRva2VuaXplci5lb3NfdG9rZW5faWQKICAgIG1vZGVsID0gQXV0b01vZGVsRm9yQ2F1c2FsTE0uZnJvbV9wcmV0cmFpbmVkKAogICAgICAgIG1vZGVsX25hbWUsIGRldmljZV9tYXA9ImN1ZGE6MCIsIHRydXN0X3JlbW90ZV9jb2RlPVRydWUsIGxvYWRfaW5fOGJpdD1UcnVlCiAgICApCiAgICBtb2RlbCA9IFBlZnRNb2RlbC5mcm9tX3ByZXRyYWluZWQobW9kZWwsIG1vZGVsX2RpcmVjdG9yeSkKICAgIG1vZGVsLmV2YWwoKQogICAgZW5jb2RpbmdzID0gdG9rZW5pemVyKCJcblxuIi5qb2luKGRhdGFzZXRbInRleHQiXVs6NV0pLCByZXR1cm5fdGVuc29ycz0icHQiKQoKICAgIG1heF9sZW5ndGggPSAxMDI0CiAgICBzdHJpZGUgPSA1MTIKICAgIHNlcV9sZW4gPSBlbmNvZGluZ3MuaW5wdXRfaWRzLnNpemUoMSkKCiAgICBubGxzID0gW10KICAgIHByZXZfZW5kX2xvYyA9IDAKICAgIGZvciBiZWdpbl9sb2MgaW4gcmFuZ2UoMCwgc2VxX2xlbiwgc3RyaWRlKToKICAgICAgICBlbmRfbG9jID0gbWluKGJlZ2luX2xvYyArIG1heF9sZW5ndGgsIHNlcV9sZW4pCiAgICAgICAgdHJnX2xlbiA9IGVuZF9sb2MgLSBwcmV2X2VuZF9sb2MgICMgbWF5IGJlIGRpZmZlcmVudCBmcm9tIHN0cmlkZSBvbiBsYXN0IGxvb3AKICAgICAgICBpbnB1dF9pZHMgPSBlbmNvZGluZ3MuaW5wdXRfaWRzWzosIGJlZ2luX2xvYzplbmRfbG9jXQogICAgICAgIHRhcmdldF9pZHMgPSBpbnB1dF9pZHMuY2xvbmUoKQogICAgICAgIHRhcmdldF9pZHNbOiwgOi10cmdfbGVuXSA9IC0xMDAKCiAgICAgICAgd2l0aCB0b3JjaC5ub19ncmFkKCk6CiAgICAgICAgICAgIG91dHB1dHMgPSBtb2RlbChpbnB1dF9pZHMuY3VkYSgpLCBsYWJlbHM9dGFyZ2V0X2lkcykKCiAgICAgICAgICAgICMgbG9zcyBpcyBjYWxjdWxhdGVkIHVzaW5nIENyb3NzRW50cm9weUxvc3Mgd2hpY2ggYXZlcmFnZXMgb3ZlciB2YWxpZCBsYWJlbHMKICAgICAgICAgICAgIyBOLkIuIHRoZSBtb2RlbCBvbmx5IGNhbGN1bGF0ZXMgbG9zcyBvdmVyIHRyZ19sZW4gLSAxIGxhYmVscywgYmVjYXVzZSBpdCBpbnRlcm5hbGx5IHNoaWZ0cyB0aGUgbGFiZWxzCiAgICAgICAgICAgICMgdG8gdGhlIGxlZnQgYnkgMS4KICAgICAgICAgICAgbmVnX2xvZ19saWtlbGlob29kID0gb3V0cHV0cy5sb3NzCgogICAgICAgIG5sbHMuYXBwZW5kKG5lZ19sb2dfbGlrZWxpaG9vZCkKCiAgICAgICAgcHJldl9lbmRfbG9jID0gZW5kX2xvYwogICAgICAgIGlmIGVuZF9sb2MgPT0gc2VxX2xlbjoKICAgICAgICAgICAgYnJlYWsKCiAgICBwcGwgPSB0b3JjaC5leHAodG9yY2guc3RhY2sobmxscykubWVhbigpKS5pdGVtKCkKICAgIGNvbnRleHQubG9nX3Jlc3VsdCgicGVycGxleGl0eSIsIHBwbCkK
    commands: []
    code_origin: https://github.com/ZeevRispler/functions.git#da90a20560ddedaebcfdd900a43c76d070041a61:/Users/Zeev_Rispler/PycharmProjects/functions/huggingface_auto_trainer/huggingface_auto_trainer.py
    origin_filename: /Users/Zeev_Rispler/PycharmProjects/functions/huggingface_auto_trainer/huggingface_auto_trainer.py
  entry_points:
    add_interface:
      name: add_interface
      doc: ''
      parameters:
      - name: cls
        default: ''
      - name: obj
        type: Trainer
        default: ''
      - name: restoration
        type: MLRunInterfaceRestorationType
        default: null
      outputs:
      - default: ''
      lineno: 77
    mlrun_train:
      name: mlrun_train
      doc: ''
      parameters:
      - name: cls
        default: ''
      outputs:
      - default: ''
      lineno: 87
    wrapper:
      name: wrapper
      doc: ''
      parameters:
      - name: self
        type: Trainer
        default: ''
      outputs:
      - default: ''
      lineno: 88
    on_epoch_begin:
      name: on_epoch_begin
      doc: ''
      parameters:
      - name: self
        default: ''
      - name: args
        type: TrainingArguments
        default: ''
      - name: state
        type: TrainerState
        default: ''
      - name: control
        type: TrainerControl
        default: ''
      outputs:
      - default: ''
      lineno: 136
    on_epoch_end:
      name: on_epoch_end
      doc: ''
      parameters:
      - name: self
        default: ''
      - name: args
        type: TrainingArguments
        default: ''
      - name: state
        type: TrainerState
        default: ''
      - name: control
        type: TrainerControl
        default: ''
      outputs:
      - default: ''
      lineno: 147
    on_log:
      name: on_log
      doc: ''
      parameters:
      - name: self
        default: ''
      - name: args
        type: TrainingArguments
        default: ''
      - name: state
        type: TrainerState
        default: ''
      - name: control
        type: TrainerControl
        default: ''
      - name: logs
        type: Dict[str, float]
        default: null
      outputs:
      - default: ''
      lineno: 158
    on_train_begin:
      name: on_train_begin
      doc: ''
      parameters:
      - name: self
        default: ''
      - name: args
        type: TrainingArguments
        default: ''
      - name: state
        type: TrainerState
        default: ''
      - name: control
        type: TrainerControl
        default: ''
      outputs:
      - default: ''
      lineno: 184
    on_train_end:
      name: on_train_end
      doc: ''
      parameters:
      - name: self
        default: ''
      - name: args
        type: TrainingArguments
        default: ''
      - name: state
        type: TrainerState
        default: ''
      - name: control
        type: TrainerControl
        default: ''
      - name: model
        type: PreTrainedModel
        default: null
      - name: tokenizer
        type: PreTrainedTokenizer
        default: null
      outputs:
      - default: ''
      lineno: 195
    on_evaluate:
      name: on_evaluate
      doc: ''
      parameters:
      - name: self
        default: ''
      - name: args
        type: TrainingArguments
        default: ''
      - name: state
        type: TrainerState
        default: ''
      - name: control
        type: TrainerControl
        default: ''
      outputs:
      - default: ''
      lineno: 208
    apply_mlrun:
      name: apply_mlrun
      doc: This is temporary and will be built in mlrun 1.5.0
      parameters:
      - name: trainer
        type: Trainer
        default: ''
      - name: model_name
        type: str
        default: null
      - name: tag
        type: str
        default: ''
      - name: context
        type: MLClientCtx
        default: null
      - name: auto_log
        type: bool
        default: true
      - name: labels
        type: Dict[str, str]
        default: null
      - name: extra_data
        type: dict
        default: null
      outputs:
      - default: ''
      lineno: 251
    print_trainable_parameters:
      name: print_trainable_parameters
      doc: Prints the number of trainable parameters in the model.
      parameters:
      - name: model
        default: ''
      outputs:
      - default: ''
      lineno: 283
    update_config:
      name: update_config
      doc: "update configs according to user, this way the user can add/modify values\
        \ in default configs for e.g.\n\ngoes over all configs and corresponding prefixes,\
        \ collect all the keys from the given dict that start\n with the prefix and\
        \ add them to appropriate config"
      parameters:
      - name: src
        type: dict
        doc: dict of all candidate values to update dict.
        default: ''
      - name: dst
        type: dict
        doc: dict containing all configs to update.
        default: ''
      outputs:
      - default: ''
      lineno: 335
    get_class_object:
      name: get_class_object
      doc: given a full class name, this function returns the correct class
      parameters:
      - name: class_path
        type: str
        doc: a full class name (ex. 'transformers.AutoModelForCausalLM')
        default: ''
      outputs:
      - default: ''
        type: type
      lineno: 377
    set_model_and_tokenizer:
      name: set_model_and_tokenizer
      doc: get the correct model and tokenizer according to given user inputs
      parameters:
      - name: model
        type: Union[str, Tuple[str, str]]
        doc: a tuple containing model name and class, or str with model name or path
        default: ''
      - name: tokenizer
        type: Union[str, Tuple[str, str]]
        doc: a tuple containing tokenizer name and class, or str with tokenizer name
          or path
        default: ''
      - name: task
        type: str
        doc: a supported nlp task, used to choose model if not provided
        default: ''
      - name: framework
        type: str
        doc: pt or tf
        default: ''
      - name: lora_config
        type: dict
        doc: lora config or None, to load model in appropriate way
        default: ''
      - name: quantization_config
        type: dict
        doc: quantization config or None, to load model in appropriate way
        default: ''
      - name: use_cuda
        type: bool
        doc: use gpu or not
        default: ''
      - name: tokenizer_pretrained_config
        doc: config to load the pretrained tokenizer
        default: ''
      - name: model_pretrained_config
        doc: config to load the pretrained model
        default: ''
      - name: device_map
        type: str
        doc: a device map for model training if using number of gpu's
        default: ''
      outputs:
      - default: ''
      lineno: 390
    dataset_loader:
      name: dataset_loader
      doc: loads the specific dataset provided by the user
      parameters:
      - name: dataset
        type: str
        doc: name or path of dataset to load
        default: ''
      - name: is_train
        type: bool
        doc: bool that indicates the purpose of the dataset
        default: true
      outputs:
      - default: ''
        type: Dataset
      lineno: 498
    prepare_dataset:
      name: prepare_dataset
      doc: 'Loads the train and eval datasets (if provided) passes them through the
        tokenizer and

        returns them ready to use in training'
      parameters:
      - name: train_dataset
        type: str
        doc: the name or path to the train dataset
        default: ''
      - name: eval_dataset
        type: str
        doc: the name or path to the eval dataset
        default: ''
      - name: train_load_dataset_kwargs
        doc: kwargs for dataset loading
        default: ''
      - name: eval_load_dataset_kwargs
        doc: kwargs for dataset loading
        default: ''
      - name: tokenizer
        doc: the tokenizer to pass the data through
        default: ''
      - name: dataset_columns_to_train
        type: Union[str, list]
        doc: which columns to pass to the model as inputs (need to pass through the
          tokenizer first)
        default: ''
      outputs:
      - default: ''
      lineno: 526
    finetune_llm:
      name: finetune_llm
      doc: "Fine-tunes a Language Model (LLM) on a specific task using the provided\
        \ dataset.\n The function takes various configuration parameters to customize\
        \ the training process\n and adapt the model to specific tasks using a provided\
        \ dataset."
      parameters:
      - name: context
        type: MLClientCtx
        doc: mlrun context in order to log trained model
        default: ''
      - name: train_dataset
        type: str
        doc: The train dataset used for fine-tuning the language model.
        default: ''
      - name: eval_dataset
        type: str
        doc: The eval dataset used for evaluate the language model during training.
        default: null
      - name: train_load_dataset_kwargs
        type: dict
        doc: kwargs for dataset loading
        default: {}
      - name: eval_load_dataset_kwargs
        type: dict
        doc: kwargs for dataset loading
        default: {}
      - name: dataset_columns_to_train
        type: Union[str, list]
        doc: which columns to pass to the model as inputs
        default: text
      - name: model
        type: Union[str, Tuple[str, str]]
        doc: a tuple containing model name and class, or str with model name or path
        default: huggingface-model
      - name: tokenizer
        type: Union[str, Tuple[str, str]]
        doc: a tuple containing tokenizer name and class, or str with tokenizer name
          or path
        default: null
      - name: deepspeed_config
        type: Union[dict, bool]
        doc: Configuration options for DeepSpeed (optional).
        default: false
      - name: quantization_config
        type: Union[dict, bool]
        doc: Configuration options for model quantization (optional).
        default: false
      - name: lora_config
        type: Union[dict, bool]
        doc: Configuration options for Low-Rank Approximation (LoRA) (optional).
        default: false
      - name: training_config
        type: dict
        doc: Configuration options specific to the fine-tuning training process (optional).
        default: {}
      - name: model_pretrained_config
        type: dict
        doc: config to load the pretrained model
        default: {}
      - name: tokenizer_pretrained_config
        type: dict
        doc: config to load the pretrained tokenizer
        default: {}
      - name: data_collator_config
        type: dict
        doc: Configuration options for data collation during training (optional).
        default: {}
      - name: task
        type: str
        doc: A description of the specific task the model is being fine-tuned for.
        default: text-generation
      - name: use_cuda
        type: bool
        doc: use gpu or not
        default: true
      - name: framework
        type: str
        doc: pt ot tf
        default: pt
      - name: device_map
        type: str
        default: auto
      outputs:
      - default: ''
      lineno: 587
    evaluate:
      name: evaluate
      doc: 'Evaluating the model using perplexity, for more information visit:

        https://huggingface.co/docs/transformers/perplexity'
      parameters:
      - name: context
        doc: mlrun context
        default: ''
      - name: model_path
        doc: path to the model directory
        default: ''
      - name: data
        type: DataFrame
        doc: the data to evaluate the model
        default: ''
      - name: model_name
        type: str
        doc: name of base model
        default: null
      - name: tokenizer_name
        type: str
        doc: name of base tokenizer
        default: null
      outputs:
      - default: ''
      lineno: 739
  description: fine-tune llm model with ease
  default_handler: finetune_llm
  disable_auto_mount: false
  env: []
  priority_class_name: ''
  preemption_mode: prevent
  affinity: null
  tolerations: null
  security_context: {}
verbose: false
