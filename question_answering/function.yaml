kind: job
metadata:
  name: question-answering
  tag: ''
  hash: 21d47c5447a7efe701317fe51b068dddd01ecb11
  project: ''
  labels:
    author: yonish
  categories:
  - machine-learning
spec:
  command: ''
  args: []
  image: ''
  build:
    functionSourceCode: IyBDb3B5cmlnaHQgMjAyMyBJZ3VhemlvCiMKIyBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgIkxpY2Vuc2UiKTsKIyB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuCiMgWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0CiMKIyAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMAojCiMgVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZQojIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuICJBUyBJUyIgQkFTSVMsCiMgV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuCiMgU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZAojIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLgppbXBvcnQgbG9nZ2luZwppbXBvcnQgb3BlcmF0b3IKaW1wb3J0IHBhdGhsaWIKZnJvbSBjb2xsZWN0aW9ucyBpbXBvcnQgQ291bnRlcgpmcm9tIGZ1bmN0b29scyBpbXBvcnQgcmVkdWNlLCB3cmFwcwpmcm9tIHR5cGluZyBpbXBvcnQgQW55LCBEaWN0LCBMaXN0LCBUdXBsZSwgVW5pb24KCmltcG9ydCBwYW5kYXMgYXMgcGQKaW1wb3J0IHRyYW5zZm9ybWVycwpmcm9tIHRxZG0gaW1wb3J0IHRxZG0KCiMgR2V0IHRoZSBnbG9iYWwgbG9nZ2VyOgpfTE9HR0VSID0gbG9nZ2luZy5nZXRMb2dnZXIoKQoKCmRlZiBfY2hlY2tfbWxydW5fYW5kX29wZW5fbXBpKCkgLT4gVHVwbGVbIm1scnVuLk1MQ2xpZW50Q3R4IiwgIm1waTRweS5NUEkuSW50cmFjb21tIl06CiAgICBnbG9iYWwgX0xPR0dFUgoKICAgIGlzX21waSA9IEZhbHNlCiAgICB0cnk6CiAgICAgICAgaW1wb3J0IG1scnVuCgogICAgICAgIGNvbnRleHQgPSBtbHJ1bi5nZXRfb3JfY3JlYXRlX2N0eChuYW1lPSJtbHJ1biIpCiAgICAgICAgX0xPR0dFUiA9IGNvbnRleHQubG9nZ2VyCiAgICAgICAgaXNfbXBpID0gY29udGV4dC5sYWJlbHMuZ2V0KCJraW5kIiwgImpvYiIpID09ICJtcGlqb2IiCgogICAgICAgIGlmIGlzX21waToKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgZnJvbSBtcGk0cHkgaW1wb3J0IE1QSQoKICAgICAgICAgICAgICAgIHJldHVybiBjb250ZXh0LCBNUEkuQ09NTV9XT1JMRAogICAgICAgICAgICBleGNlcHQgTW9kdWxlTm90Rm91bmRFcnJvciBhcyBtcGk0cHlfbm90X2ZvdW5kOgogICAgICAgICAgICAgICAgY29udGV4dC5sb2dnZXIuZXJyb3IoCiAgICAgICAgICAgICAgICAgICAgIlRvIGRpc3RyaWJ1dGUgdGhlIGZ1bmN0aW9uIHVzaW5nIE1MUnVuJ3MgJ21waWpvYicgeW91IG5lZWQgdG8gaGF2ZSBgbXBpNHB5YCBwYWNrYWdlIGluIHlvdXIgIgogICAgICAgICAgICAgICAgICAgICJpbnRlcnByZXRlci4gUGxlYXNlIHJ1biBgcGlwIGluc3RhbGwgbXBpNHB5YCBhbmQgbWFrZSBzdXJlIHlvdSBoYXZlIG9wZW4tbXBpLiIKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgIHJhaXNlIG1waTRweV9ub3RfZm91bmQKICAgIGV4Y2VwdCBNb2R1bGVOb3RGb3VuZEVycm9yIGFzIG1vZHVsZV9ub3RfZm91bmQ6CiAgICAgICAgaWYgaXNfbXBpOgogICAgICAgICAgICByYWlzZSBtb2R1bGVfbm90X2ZvdW5kCiAgICByZXR1cm4gTm9uZSwgTm9uZQoKCmRlZiBvcGVuX21waV9oYW5kbGVyKAogICAgd29ya2VyX2lucHV0czogTGlzdFtzdHJdLCByb290X3dvcmtlcl9pbnB1dHM6IERpY3Rbc3RyLCBBbnldID0gTm9uZQopOgogICAgZ2xvYmFsIF9MT0dHRVIKCiAgICAjIENoZWNrIGZvciBNTFJ1biBhbmQgT3Blbk1QSSBhdmFpbGFiaWxpdHk6CiAgICBjb250ZXh0LCBjb21tID0gX2NoZWNrX21scnVuX2FuZF9vcGVuX21waSgpCgogICAgZGVmIGRlY29yYXRvcihoYW5kbGVyKToKICAgICAgICBpZiBjb21tIGlzIE5vbmUgb3IgY29tbS5HZXRfc2l6ZSgpID09IDE6CiAgICAgICAgICAgIHJldHVybiBoYW5kbGVyCgogICAgICAgIEB3cmFwcyhoYW5kbGVyKQogICAgICAgIGRlZiB3cmFwcGVyKCoqa3dhcmdzKToKICAgICAgICAgICAgIyBHZXQgdGhlIG9wZW4gbXBpIGVudmlyb25tZW50IHByb3BlcnRpZXM6CiAgICAgICAgICAgIHNpemUgPSBjb21tLkdldF9zaXplKCkKICAgICAgICAgICAgcmFuayA9IGNvbW0uR2V0X3JhbmsoKQoKICAgICAgICAgICAgIyBHaXZlIHRoZSBjb3JyZWN0IGNodW5rIG9mIHRoZSB3b3JrZXJzIGlucHV0czoKICAgICAgICAgICAgZm9yIHdvcmtlcl9pbnB1dCBpbiB3b3JrZXJfaW5wdXRzOgogICAgICAgICAgICAgICAgaW5wdXRfYXJndW1lbnQgPSBrd2FyZ3Nbd29ya2VyX2lucHV0XQogICAgICAgICAgICAgICAgaWYgaW5wdXRfYXJndW1lbnQgaXMgTm9uZToKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShpbnB1dF9hcmd1bWVudCwgc3RyKToKICAgICAgICAgICAgICAgICAgICBpbnB1dF9hcmd1bWVudCA9IF9nZXRfdGV4dF9maWxlcygKICAgICAgICAgICAgICAgICAgICAgICAgZGF0YV9wYXRoPXBhdGhsaWIuUGF0aChpbnB1dF9hcmd1bWVudCkuYWJzb2x1dGUoKQogICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgIGlmIGxlbihpbnB1dF9hcmd1bWVudCkgPCBzaXplOgogICAgICAgICAgICAgICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoCiAgICAgICAgICAgICAgICAgICAgICAgIGYiQ2Fubm90IHNwbGl0IHRoZSBpbnB1dCAne3dvcmtlcl9pbnB1dH0nIG9mIGxlbmd0aCB7bGVuKGlucHV0X2FyZ3VtZW50KX0gdG8ge3NpemV9IHdvcmtlcnMuICIKICAgICAgICAgICAgICAgICAgICAgICAgZiJQbGVhc2UgcmVkdWNlIHRoZSBhbW91bnQgb2Ygd29ya2VycyBmb3IgdGhpcyBpbnB1dC4iCiAgICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgZXZlbl9jaHVua19zaXplID0gbGVuKGlucHV0X2FyZ3VtZW50KSAvLyBzaXplCiAgICAgICAgICAgICAgICBjaHVua19zdGFydCA9IHJhbmsgKiBldmVuX2NodW5rX3NpemUKICAgICAgICAgICAgICAgIGNodW5rX2VuZCA9ICgKICAgICAgICAgICAgICAgICAgICAocmFuayArIDEpICogZXZlbl9jaHVua19zaXplCiAgICAgICAgICAgICAgICAgICAgaWYgcmFuayArIDEgPCBzaXplCiAgICAgICAgICAgICAgICAgICAgZWxzZSBsZW4oaW5wdXRfYXJndW1lbnQpCiAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICBjb250ZXh0LmxvZ2dlci5pbmZvKAogICAgICAgICAgICAgICAgICAgIGYiUmFuayAje3Jhbmt9OiBQcm9jZXNzaW5nIGlucHV0IGNodW5rIG9mICd7d29ya2VyX2lucHV0fScgIgogICAgICAgICAgICAgICAgICAgIGYiZnJvbSBpbmRleCB7Y2h1bmtfc3RhcnR9IHRvIHtjaHVua19lbmR9LiIKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgIGlmIGlzaW5zdGFuY2UoaW5wdXRfYXJndW1lbnQsIGxpc3QpOgogICAgICAgICAgICAgICAgICAgIGlucHV0X2FyZ3VtZW50ID0gaW5wdXRfYXJndW1lbnRbY2h1bmtfc3RhcnQ6Y2h1bmtfZW5kXQogICAgICAgICAgICAgICAgZWxpZiBpc2luc3RhbmNlKGlucHV0X2FyZ3VtZW50LCBwZC5EYXRhRnJhbWUpOgogICAgICAgICAgICAgICAgICAgIGlucHV0X2FyZ3VtZW50ID0gaW5wdXRfYXJndW1lbnQuaWxvY1tjaHVua19zdGFydDpjaHVua19lbmQ6LCA6XQogICAgICAgICAgICAgICAga3dhcmdzW3dvcmtlcl9pbnB1dF0gPSBpbnB1dF9hcmd1bWVudAoKICAgICAgICAgICAgIyBTZXQgdGhlIHJvb3Qgd29ya2VyIG9ubHkgYXJndW1lbnRzOgogICAgICAgICAgICBpZiByYW5rID09IDAgYW5kIHJvb3Rfd29ya2VyX2lucHV0czoKICAgICAgICAgICAgICAgIGt3YXJncy51cGRhdGUocm9vdF93b3JrZXJfaW5wdXRzKQoKICAgICAgICAgICAgIyBSdW4gdGhlIHdvcmtlcjoKICAgICAgICAgICAgb3V0cHV0ID0gaGFuZGxlcigqKmt3YXJncykKCiAgICAgICAgICAgICMgU2VuZCB0aGUgb3V0cHV0IHRvIHRoZSByb290IHJhbmsgKHJhbmsgIzApOgogICAgICAgICAgICBvdXRwdXQgPSBjb21tLmdhdGhlcihvdXRwdXQsIHJvb3Q9MCkKICAgICAgICAgICAgaWYgcmFuayA9PSAwOgogICAgICAgICAgICAgICAgIyBKb2luIHRoZSBvdXRwdXRzOgogICAgICAgICAgICAgICAgY29udGV4dC5sb2dnZXIuaW5mbygiQ29sbGVjdGluZyBkYXRhIGZyb20gd29ya2VycyB0byByb290IHdvcmtlci4iKQogICAgICAgICAgICAgICAgZGF0YWZyYW1lID0gcGQuY29uY2F0KG9ianM9W2RmIGZvciBkZiwgXyBpbiBvdXRwdXRdLCBheGlzPTApCiAgICAgICAgICAgICAgICBlcnJvcnNfZGljdGlvbmFyeSA9IHJlZHVjZShvcGVyYXRvci5pb3IsIFtlcnIgZm9yIF8sIGVyciBpbiBvdXRwdXRdLCB7fSkKICAgICAgICAgICAgICAgIHJldHVybiBkYXRhZnJhbWUsIGVycm9yc19kaWN0aW9uYXJ5CiAgICAgICAgICAgIHJldHVybiBOb25lCgogICAgICAgIHJldHVybiB3cmFwcGVyCgogICAgcmV0dXJuIGRlY29yYXRvcgoKCkBvcGVuX21waV9oYW5kbGVyKHdvcmtlcl9pbnB1dHM9WyJkYXRhX3BhdGgiXSwgcm9vdF93b3JrZXJfaW5wdXRzPXsidmVyYm9zZSI6IFRydWV9KQpkZWYgYW5zd2VyX3F1ZXN0aW9ucygKICAgIGRhdGFfcGF0aDogVW5pb25bc3RyLCBMaXN0W3N0cl1dLAogICAgbW9kZWxfbmFtZTogc3RyLAogICAgcXVlc3Rpb25zOiBVbmlvbltMaXN0W3N0cl0sIExpc3RbTGlzdFtzdHJdXV0sCiAgICBkZXZpY2VfbWFwOiBVbmlvbltzdHIsIGRpY3RdID0gTm9uZSwKICAgIG1vZGVsX2t3YXJnczogZGljdCA9IE5vbmUsCiAgICBhdXRvX2dwdHFfZXhsbGFtYV9tYXhfaW5wdXRfbGVuZ3RoOiBpbnQgPSBOb25lLAogICAgdG9rZW5pemVyX25hbWU6IHN0ciA9IE5vbmUsCiAgICB0b2tlbml6ZXJfa3dhcmdzOiBkaWN0ID0gTm9uZSwKICAgIHRleHRfd3JhcHBlcjogVW5pb25bc3RyLCBMaXN0W3N0cl1dID0gIiIsCiAgICBxdWVzdGlvbnNfd3JhcHBlcjogVW5pb25bc3RyLCBMaXN0W3N0cl1dID0gIiIsCiAgICBnZW5lcmF0aW9uX2NvbmZpZzogVW5pb25bRGljdCwgTGlzdFtEaWN0XV0gPSBOb25lLAogICAgcXVlc3Rpb25zX2NvbmZpZzogVW5pb25bRGljdCwgTGlzdFtEaWN0XV0gPSBOb25lLAogICAgYmF0Y2hfc2l6ZTogaW50ID0gMSwKICAgIHF1ZXN0aW9uc19jb2x1bW5zOiBMaXN0W3N0cl0gPSBOb25lLAogICAgdmVyYm9zZTogYm9vbCA9IEZhbHNlLAopIC0+IFR1cGxlW3BkLkRhdGFGcmFtZSwgZGljdF06CiAgICAiIiIKICAgIEFuc3dlciBxdWVzdGlvbnMgd2l0aCBhIGNvbnRleHQgdG8gdGhlIGdpdmVuIHRleHQgZmlsZXMgY29udGVudHMgYnkgYSBwcmV0cmFpbmVkIExMTSBtb2RlbC4gRWFjaCB0ZXh0IGZpbGUgd2lsbCBoYXZlCiAgICB0aGUgZm9sbG93aW5nIHByb21wdCBidWlsdDoKCiAgICBzdGFydCBvZiBgdGV4dF93cmFwcGVyYAogICAgPHRleHQgZmlsZSBjb250ZW50PgogICAgZW5kIG9mIGB0ZXh0X3dyYXBwZXJgCgogICAgc3RhcnQgb2YgYHF1ZXN0aW9uc193cmFwcGVyYAogICAgMS4gPHF1ZXN0aW9uc1swXT4KICAgIDIuIDxxdWVzdGlvbnNbMV0+CiAgICAuLi4KICAgIG4uIDxxdWVzdGlvbnNbbi0xXT4KICAgIGVuZCBvZiBgcXVlc3Rpb25zX3dyYXBwZXJgCgogICAgOnBhcmFtIGRhdGFfcGF0aDogICAgICAgICAgICAgICAgICAgICAgICAgIEEgcGF0aCB0byBhIGRpcmVjdG9yeSBvZiB0ZXh0IGZpbGVzIG9yIGEgcGF0aCB0byBhIHRleHQgZmlsZSB0byBhc2sKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBxdWVzdGlvbnMgYWJvdXQuCiAgICA6cGFyYW0gbW9kZWxfbmFtZTogICAgICAgICAgICAgICAgICAgICAgICAgVGhlIHByZS10cmFpbmVkIG1vZGVsIG5hbWUgZnJvbSB0aGUgaHVnZ2luZ2ZhY2UgaHViIHRvIHVzZSBmb3IgYXNraW5nCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcXVlc3Rpb25zLgogICAgOnBhcmFtIHF1ZXN0aW9uczogICAgICAgICAgICAgICAgICAgICAgICAgIFRoZSBxdWVzdGlvbnMgdG8gYXNrLgogICAgOnBhcmFtIGRldmljZV9tYXA6ICAgICAgICAgICAgICAgICAgICAgICAgIEEgbWFwIHRvIHVzZSBmb3IgbG9hZGluZyB0aGUgbW9kZWwgb24gbXVsdGlwbGUgZGV2aWNlcy4KICAgIDpwYXJhbSBtb2RlbF9rd2FyZ3M6ICAgICAgICAgICAgICAgICAgICAgICBLZXl3b3JkIGFyZ3VtZW50cyB0byBwYXNzIGZvciBsb2FkaW5nIHRoZSBtb2RlbCB1c2luZyBIdWdnaW5nRmFjZSdzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYHRyYW5zZm9ybWVycy5BdXRvTW9kZWxGb3JDYXVzYWxMTS5mcm9tX3ByZXRyYWluZWRgIGZ1bmN0aW9uLgogICAgOnBhcmFtIGF1dG9fZ3B0cV9leGxsYW1hX21heF9pbnB1dF9sZW5ndGg6IEZvciBBdXRvR1BUUSBtb2RlbHMgdG8gc2V0IGFuZCBleHRlbmQgdGhlIG1vZGVsJ3MgaW5wdXQgYnVmZmVyIHNpemUuCiAgICA6cGFyYW0gdG9rZW5pemVyX25hbWU6ICAgICAgICAgICAgICAgICAgICAgVGhlIHRva2VuaXplciBuYW1lIGZyb20gdGhlIGh1Z2dpbmdmYWNlIGh1YiB0byB1c2UuIElmIG5vdCBnaXZlbiwgdGhlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbW9kZWwgbmFtZSB3aWxsIGJlIHVzZWQuCiAgICA6cGFyYW0gdG9rZW5pemVyX2t3YXJnczogICAgICAgICAgICAgICAgICAgS2V5d29yZCBhcmd1bWVudHMgdG8gcGFzcyBmb3IgbG9hZGluZyB0aGUgdG9rZW5pemVyIHVzaW5nIEh1Z2dpbmdGYWNlJ3MKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBgdHJhbnNmb3JtZXJzLkF1dG9Ub2tlbml6ZXIuZnJvbV9wcmV0cmFpbmVkYCBmdW5jdGlvbi4KICAgIDpwYXJhbSB0ZXh0X3dyYXBwZXI6ICAgICAgICAgICAgICAgICAgICAgICBBIHdyYXBwZXIgZm9yIHRoZSBmaWxlJ3MgdGV4dC4gV2lsbCBiZSBhZGRlZCBhdCB0aGUgc3RhcnQgb2YgdGhlIHByb21wdC4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBNdXN0IGhhdmUgYSBwbGFjZWhvbGRlciAoJ3t9JykgZm9yIHRoZSB0ZXh0IG9mIHRoZSBmaWxlLgogICAgOnBhcmFtIHF1ZXN0aW9uc193cmFwcGVyOiAgICAgICAgICAgICAgICAgIEEgd3JhcHBlciBmb3IgdGhlIHF1ZXN0aW9ucyByZWNlaXZlZC4gV2lsbCBiZSBhZGRlZCBhZnRlciB0aGUgdGV4dAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdyYXBwZXIgaW4gdGhlIHByb21wdCB0ZW1wbGF0ZS4gTXVzdCBoYXZlIGEgcGxhY2Vob2xkZXIgKCd7fScpIGZvciB0aGUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBxdWVzdGlvbnMuCiAgICA6cGFyYW0gZ2VuZXJhdGlvbl9jb25maWc6ICAgICAgICAgICAgICAgICAgSHVnZ2luZ0ZhY2UncyBgR2VuZXJhdGlvbkNvbmZpZ2Aga2V5d29yZCBhcmd1bWVudHMgdG8gcGFzcyB0byB0aGUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBgZ2VuZXJhdGVgIG1ldGhvZC4KICAgIDpwYXJhbSBxdWVzdGlvbnNfY29uZmlnOiAgICAgICAgICAgICAgICAgICBBIGRpY3Rpb25hcnkgb3IgbGlzdCBvZiBkaWN0aW9uYXJpZXMgY29udGFpbmluZyBzcGVjaWZpYyB3YXlzIHRvIGFuc3dlcgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHF1ZXN0aW9ucyAodXNpbmcgYSBwb2xsIGZvciBleGFtcGxlKS4KICAgIDpwYXJhbSBiYXRjaF9zaXplOiAgICAgICAgICAgICAgICAgICAgICAgICBCYXRjaCBzaXplIGZvciBpbmZlcmVuY2UuCiAgICA6cGFyYW0gcXVlc3Rpb25zX2NvbHVtbnM6ICAgICAgICAgICAgICAgICAgQ29sdW1ucyB0byB1c2UgZm9yIHRoZSBkYXRhZnJhbWUgcmV0dXJuZWQuCiAgICA6cGFyYW0gdmVyYm9zZTogICAgICAgICAgICAgICAgICAgICAgICAgICAgV2hldGhlciB0byBwcmVzZW50IGxvZ3Mgb2YgYSBwcm9ncmVzcyBiYXIgYW5kIGVycm9ycy4gRGVmYXVsdDogVHJ1ZS4KCgogICAgOnJldHVybnM6IEEgdHVwbGUgb2Y6CgogICAgICAgICAgICAgICogQSBkYXRhZnJhbWUgZGF0YXNldCBvZiB0aGUgcXVlc3Rpb25zIGFuc3dlcnMuCiAgICAgICAgICAgICAgKiBBIGRpY3Rpb25hcnkgb2YgZXJyb3JlZCBmaWxlcyB0aGF0IHdlcmUgbm90IGluZmVycmVkIG9yIHdlcmUgbm90IGFuc3dlcmVkIHByb3Blcmx5LgogICAgIiIiCiAgICBnbG9iYWwgX0xPR0dFUgoKICAgICMgU2V0IGNvbmZpZ3MgdG8gZW1wdHkgZGljdCBpZiBub3QgZ2l2ZW46CiAgICBpZiBnZW5lcmF0aW9uX2NvbmZpZyBpcyBOb25lOgogICAgICAgIGdlbmVyYXRpb25fY29uZmlnID0ge30KICAgIGlmIHF1ZXN0aW9uc19jb25maWcgaXMgTm9uZToKICAgICAgICBxdWVzdGlvbnNfY29uZmlnID0ge30KCiAgICAjIEdldCB0aGUgaW5wdXQgdGV4dCBmaWxlcyB0byBxdWVzdGlvbjoKICAgIGlmIHZlcmJvc2U6CiAgICAgICAgX0xPR0dFUi5pbmZvKCJDb2xsZWN0aW5nIHRleHQgZmlsZXMuIikKICAgIGlmIGlzaW5zdGFuY2UoZGF0YV9wYXRoLCBzdHIpOgogICAgICAgIGRhdGFfcGF0aCA9IHBhdGhsaWIuUGF0aChkYXRhX3BhdGgpLmFic29sdXRlKCkKICAgICAgICB0ZXh0X2ZpbGVzID0gX2dldF90ZXh0X2ZpbGVzKGRhdGFfcGF0aD1kYXRhX3BhdGgpCiAgICBlbHNlOgogICAgICAgIHRleHRfZmlsZXMgPSBkYXRhX3BhdGgKICAgIGlmIHZlcmJvc2U6CiAgICAgICAgX0xPR0dFUi5pbmZvKGYiQ29sbGVjdGVkIHtsZW4odGV4dF9maWxlcyl9IHRleHQgZmlsZXMuIikKCiAgICAjIEdldCB0aGUgcHJvbXB0IHRlbXBsYXRlOgogICAgaWYgdmVyYm9zZToKICAgICAgICBfTE9HR0VSLmluZm8oIkNyZWF0aW5nIHByb21wdCB0ZW1wbGF0ZS4iKQogICAgIyBPcmdhbml6ZSBxdWVzdGlvbnMgYXMgYSBsaXN0IG9mIGxpc3QsIGFuZCBjb3VudCBudW1iZXIgb2Ygc3ViLWxpc3RzIGZvciBmdXR1cmUgdXNlCiAgICBudW1iZXJfb2ZfcXVlc3Rpb25fZ3JvdXBzID0gMSBpZiBpc2luc3RhbmNlKHF1ZXN0aW9uc1swXSwgc3RyKSBlbHNlIGxlbihxdWVzdGlvbnMpCiAgICBxdWVzdGlvbnMgPSBfbGlzdF9tZShxdWVzdGlvbnMsICJxdWVzdGlvbnMiLCBudW1iZXJfb2ZfcXVlc3Rpb25fZ3JvdXBzKQogICAgIyBPcmdhbml6ZSBwcm9tcHQgcGFydHMgYXQgcHJvcGVyIGxlbmd0aAogICAgdGV4dF93cmFwcGVyID0gX2xpc3RfbWUodGV4dF93cmFwcGVyLCAidGV4dF93cmFwcGVyIiwgbnVtYmVyX29mX3F1ZXN0aW9uX2dyb3VwcykKICAgIHF1ZXN0aW9uc193cmFwcGVyID0gX2xpc3RfbWUoCiAgICAgICAgcXVlc3Rpb25zX3dyYXBwZXIsICJxdWVzdGlvbnNfd3JhcHBlciIsIG51bWJlcl9vZl9xdWVzdGlvbl9ncm91cHMKICAgICkKICAgICMgQ3JlYXRlIGEgbGlzdCBvZiBwcm9tcHQgYWNjb3JkaW5nIHRvIGdpdmVuIHBhcnRzIGFuZCBxdWVzdGlvbnMKICAgIHByb21wdF90ZW1wbGF0ZSA9IFtdCiAgICBxdWVzdGlvbnMgPSBxdWVzdGlvbnMgaWYgaXNpbnN0YW5jZShxdWVzdGlvbnNbMF0sIGxpc3QpIGVsc2UgW3F1ZXN0aW9uc10KICAgICMgQnVpbGQgYWxsIHByb21wdHMKICAgIGZvciBpIGluIHJhbmdlKG51bWJlcl9vZl9xdWVzdGlvbl9ncm91cHMpOgogICAgICAgIHByb21wdF90ZW1wbGF0ZS5hcHBlbmQoCiAgICAgICAgICAgIF9nZXRfcHJvbXB0X3RlbXBsYXRlKAogICAgICAgICAgICAgICAgdGV4dF93cmFwcGVyPXRleHRfd3JhcHBlcltpXSwKICAgICAgICAgICAgICAgIHF1ZXN0aW9uc193cmFwcGVyPXF1ZXN0aW9uc193cmFwcGVyW2ldLAogICAgICAgICAgICAgICAgcXVlc3Rpb25zPXF1ZXN0aW9uc1tpXSwKICAgICAgICAgICAgKQogICAgICAgICkKICAgIGlmIHZlcmJvc2U6CiAgICAgICAgX0xPR0dFUi5pbmZvKGYiUHJvbXB0IHRlbXBsYXRlIGNyZWF0ZWQ6XG5cbntwcm9tcHRfdGVtcGxhdGV9XG4iKQogICAgIyBHZXQgdGhlIHRvdGFsIGFtb3VudCBvZiBxdWVzdGlvbnM6CiAgICBxdWVzdGlvbnNfYW1vdW50ID0gc3VtKFtsZW4oc3VibGlzdCkgZm9yIHN1Ymxpc3QgaW4gcXVlc3Rpb25zXSkKICAgICMgR2V0IHRoZSBxdWVzdGlvbnMgY29sdW1uczoKICAgIHF1ZXN0aW9uc19jb2x1bW5zID0gcXVlc3Rpb25zX2NvbHVtbnMgb3IgWwogICAgICAgIGYicXtpfSIgZm9yIGkgaW4gcmFuZ2UoMSwgcXVlc3Rpb25zX2Ftb3VudCArIDEpCiAgICBdCiAgICAjIENoZWNrIGlmIHdlIGhhdmUgdGhlIGNvcnJlY3QgYW1vdW50IG9mIHF1ZXN0aW9ucyBjb2x1bW5zOgogICAgaWYgbGVuKHF1ZXN0aW9uc19jb2x1bW5zKSAhPSBxdWVzdGlvbnNfYW1vdW50OgogICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoCiAgICAgICAgICAgIGYiVGhlIHByb3ZpZGVkIHF1ZXN0aW9ucyBjb2x1bW5zIGxlbmd0aCAoe2xlbihxdWVzdGlvbnNfY29sdW1ucyl9KSAiCiAgICAgICAgICAgIGYiZG9lcyBub3QgbWF0Y2ggdGhlIHF1ZXN0aW9ucyBhbW91bnQgKHtxdWVzdGlvbnNfYW1vdW50fSkiCiAgICAgICAgKQoKICAgICMgTG9hZCB0aGUgZ2VuZXJhdGlvbiBjb25maWc6CiAgICBpZiB2ZXJib3NlOgogICAgICAgIF9MT0dHRVIuaW5mbygiTG9hZGluZyBnZW5lcmF0aW9uIGNvbmZpZ3VyYXRpb24uIikKICAgIGdlbmVyYXRpb25fY29uZmlnID0gX2xpc3RfbWUoCiAgICAgICAgZ2VuZXJhdGlvbl9jb25maWcsICJnZW5lcmF0aW9uX2NvbmZpZyIsIG51bWJlcl9vZl9xdWVzdGlvbl9ncm91cHMKICAgICkKICAgIGdlbmVyYXRpb25fY29uZmlncyA9IFtdCiAgICAjIGxvYWQgYSBsaXN0IG9mIGFsbCBhcHByb3ByaWF0ZSBjb25maWdzCiAgICBmb3IgY2ZnIGluIGdlbmVyYXRpb25fY29uZmlnOgogICAgICAgIGdlbmVyYXRpb25fY29uZmlncy5hcHBlbmQodHJhbnNmb3JtZXJzLkdlbmVyYXRpb25Db25maWcoKiooY2ZnIG9yIHt9KSkpCiAgICBpZiB2ZXJib3NlOgogICAgICAgIF9MT0dHRVIuaW5mbyhmIkdlbmVyYXRpb24gY29uZmlndXJhdGlvbiBsb2FkZWQ6IHtnZW5lcmF0aW9uX2NvbmZpZ30iKQoKICAgICMgTG9hZCB0aGUgbW9kZWwgYW5kIHRva2VuaXplciBpbnRvIGEgcGlwZWxpbmUgb2JqZWN0OgogICAgaWYgdmVyYm9zZToKICAgICAgICBfTE9HR0VSLmluZm8oZiJMb2FkaW5nIG1vZGVsICd7bW9kZWxfbmFtZX0nLiIpCiAgICBnZW5lcmF0aW9uX3BpcGVsaW5lID0gX2dldF9nZW5lcmF0aW9uX3BpcGVsaW5lKAogICAgICAgIG1vZGVsX25hbWU9bW9kZWxfbmFtZSwKICAgICAgICBkZXZpY2VfbWFwPWRldmljZV9tYXAsCiAgICAgICAgdG9rZW5pemVyX25hbWU9dG9rZW5pemVyX25hbWUgb3IgbW9kZWxfbmFtZSwKICAgICAgICBtb2RlbF9rd2FyZ3M9bW9kZWxfa3dhcmdzIG9yIHt9LAogICAgICAgIHRva2VuaXplcl9rd2FyZ3M9dG9rZW5pemVyX2t3YXJncyBvciB7fSwKICAgICAgICBhdXRvX2dwdHFfZXhsbGFtYV9tYXhfaW5wdXRfbGVuZ3RoPWF1dG9fZ3B0cV9leGxsYW1hX21heF9pbnB1dF9sZW5ndGgsCiAgICAgICAgYmF0Y2hfc2l6ZT1iYXRjaF9zaXplLAogICAgKQogICAgaWYgdmVyYm9zZToKICAgICAgICBfTE9HR0VSLmluZm8oIk1vZGVsIGxvYWRlZC4iKQoKICAgICMgUHJlcGFyZSB0aGUgc3VjY2Vzc2VzIGRhdGFmcmFtZSBhbmQgZXJyb3JzIGRpY3Rpb25hcnkgdG8gYmUgcmV0dXJuZWQ6CiAgICBzdWNjZXNzZXMgPSBbXQogICAgZXJyb3JzID0ge30KICAgICMgU3BsaXQgdGhlIGZpbGVzIGludG8gYmF0Y2hlczoKICAgIGZpbGVfYmF0Y2hlcyA9IFsKICAgICAgICB0ZXh0X2ZpbGVzW2kgOiBpICsgYmF0Y2hfc2l6ZV0KICAgICAgICBpZiBpICsgYmF0Y2hfc2l6ZSA8IGxlbih0ZXh0X2ZpbGVzKQogICAgICAgIGVsc2UgdGV4dF9maWxlc1tpOl0KICAgICAgICBmb3IgaSBpbiByYW5nZSgwLCBsZW4odGV4dF9maWxlcyksIGJhdGNoX3NpemUpCiAgICBdCiAgICBxdWVzdGlvbnNfY29uZmlnID0gX2xpc3RfbWUoCiAgICAgICAgcXVlc3Rpb25zX2NvbmZpZywgInF1ZXN0aW9uc19jb25maWciLCBudW1iZXJfb2ZfcXVlc3Rpb25fZ3JvdXBzCiAgICApCiAgICAjIENyZWF0ZSBhIGxpc3Qgb2YgcXVlc3Rpb24gaGFuZGxlcnMgYWNjb3JkaW5nIHRvIGdpdmVuIGNvbmZpZ3MKCiAgICBoYW5kbGVycyA9IFtdCiAgICBmb3IgY2ZnIGluIHF1ZXN0aW9uc19jb25maWc6CiAgICAgICAgcXVlc3Rpb25fdHlwZSA9IGNmZy5nZXQoInR5cGUiKSBvciAiZGVmYXVsdCIKICAgICAgICBoYW5kbGVycy5hcHBlbmQoUVVFU1RJT05fTUFQUElORy5nZXQocXVlc3Rpb25fdHlwZSkoY2ZnKSkKCiAgICAjIEdvIG92ZXIgdGhlIGJhdGNoZXMgb2YgdGV4dCBmaWxlcyBhbmQgcXVlc3Rpb24gdGhlbToKICAgIGZvciBmaWxlX2JhdGNoIGluIHRxZG0oCiAgICAgICAgZmlsZV9iYXRjaGVzLAogICAgICAgIGRlc2M9IkdlbmVyYXRpbmcgYW5zd2VycyIsCiAgICAgICAgdW5pdD1mImZpbGUgKGJhdGNoIG9mIHtiYXRjaF9zaXplfSkiLAogICAgICAgIGRpc2FibGU9bm90IHZlcmJvc2UsCiAgICApOgogICAgICAgIHRyeToKICAgICAgICAgICAgdG90YWxfYW5zd2VycyA9IFtbXSBmb3IgXyBpbiByYW5nZShiYXRjaF9zaXplKV0KICAgICAgICAgICAgIyBHbyBvdmVyIGFsbCBxdWVzdGlvbnMgcGVyIGRvY3VtZW50LyBiYXRjaCBvZiBkb2N1bWVudHMKICAgICAgICAgICAgZm9yIHF1ZXN0aW9uX2dyb3VwIGluIHJhbmdlKG51bWJlcl9vZl9xdWVzdGlvbl9ncm91cHMpOgogICAgICAgICAgICAgICAgY3VycmVudF9xdWVzdGlvbnNfYW1vdW50ID0gbGVuKHF1ZXN0aW9uc1txdWVzdGlvbl9ncm91cF0pCiAgICAgICAgICAgICAgICAjIFJlYWQgYmF0Y2ggKHJlYWQgdGhlIHRleHQgZnJvbSB0aGUgdGV4dCBmaWxlcyk6CiAgICAgICAgICAgICAgICBiYXRjaGVkX2lucHV0ID0gX3JlYWRfZmlsZV9iYXRjaCgKICAgICAgICAgICAgICAgICAgICBmaWxlX2JhdGNoPWZpbGVfYmF0Y2gsCiAgICAgICAgICAgICAgICAgICAgcHJvbXB0X3RlbXBsYXRlPXByb21wdF90ZW1wbGF0ZVtxdWVzdGlvbl9ncm91cF0sCiAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICAjIEFuc3dlciB0aGUgcXVlc3Rpb25zIHdpdGggZWFjaCBxdWVzdGlvbiBoYW5kbGVyOgogICAgICAgICAgICAgICAgYmF0Y2hlZF9hbnN3ZXJzID0gaGFuZGxlcnNbcXVlc3Rpb25fZ3JvdXBdLmhhbmRsZV9xdWVzdGlvbnMoCiAgICAgICAgICAgICAgICAgICAgcXVlc3Rpb25zX2Ftb3VudD1jdXJyZW50X3F1ZXN0aW9uc19hbW91bnQsCiAgICAgICAgICAgICAgICAgICAgYmF0Y2hlZF9pbnB1dD1iYXRjaGVkX2lucHV0LAogICAgICAgICAgICAgICAgICAgIGdlbmVyYXRpb25fcGlwZWxpbmU9Z2VuZXJhdGlvbl9waXBlbGluZSwKICAgICAgICAgICAgICAgICAgICBnZW5lcmF0aW9uX2NvbmZpZz1nZW5lcmF0aW9uX2NvbmZpZ3NbcXVlc3Rpb25fZ3JvdXBdLAogICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgIyBQdXQgdGhlIGFuc3dlcnMgaW4gdGhlIGNvcnJlY3QgcGxhY2UgaW4gdGhlIHRvdGFsIGFuc3dlcnMgbGlzdCBhY2NvcmRpbmcgdG8gdGhlIHBsYWNlIGluIHRoZSBiYXRjaDoKICAgICAgICAgICAgICAgIGZvciBpIGluIHJhbmdlKGJhdGNoX3NpemUpOgogICAgICAgICAgICAgICAgICAgIHRvdGFsX2Fuc3dlcnNbaV0uZXh0ZW5kKGJhdGNoZWRfYW5zd2Vyc1tpXSkKICAgICAgICAgICAgIyBDb2xsZWN0IHRoZSBhbnN3ZXJzIGFuZCBhdHRhY2ggdGhlIGZpbGUgbmFtZToKICAgICAgICAgICAgc3VjY2Vzc2VzLmV4dGVuZCgKICAgICAgICAgICAgICAgIFsKICAgICAgICAgICAgICAgICAgICBbZmlsZS5uYW1lLCAqYW5zd2Vyc10KICAgICAgICAgICAgICAgICAgICBmb3IgZmlsZSwgYW5zd2VycyBpbiB6aXAoZmlsZV9iYXRjaCwgdG90YWxfYW5zd2VycykKICAgICAgICAgICAgICAgIF0KICAgICAgICAgICAgKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZXhjZXB0aW9uOgogICAgICAgICAgICAjIE5vdGUgdGhlIGV4Y2VwdGlvbiBhcyBlcnJvciBpbiB0aGUgZGljdGlvbmFyeToKICAgICAgICAgICAgYmF0Y2hfZmlsZV9uYW1lcyA9ICIsICIuam9pbihbZmlsZS5uYW1lIGZvciBmaWxlIGluIGZpbGVfYmF0Y2hdKQogICAgICAgICAgICBpZiB2ZXJib3NlOgogICAgICAgICAgICAgICAgX0xPR0dFUi53YXJuaW5nKAogICAgICAgICAgICAgICAgICAgIGYiRXJyb3IgaW4gYmF0Y2ggJ3tiYXRjaF9maWxlX25hbWVzfSc6IHtzdHIoZXhjZXB0aW9uKX0iCiAgICAgICAgICAgICAgICApCiAgICAgICAgICAgIGVycm9yc1tiYXRjaF9maWxlX25hbWVzXSA9IHN0cihleGNlcHRpb24pCiAgICAgICAgICAgIGNvbnRpbnVlCiAgICAjIENvbnN0cnVjdCB0aGUgYW5zd2VycyBkYXRhZnJhbWU6CiAgICBjb2x1bW5zID0gWwogICAgICAgICJ0ZXh0X2ZpbGUiLAogICAgICAgICpxdWVzdGlvbnNfY29sdW1ucywKICAgIF0KICAgICMgQ3JlYXRlIGEgZGF0YSBmcmFtZSBvZiBhbnN3ZXJzIGJ5IGZpbGVzCiAgICBzdWNjZXNzZXMgPSBwZC5EYXRhRnJhbWUoCiAgICAgICAgc3VjY2Vzc2VzLAogICAgICAgIGNvbHVtbnM9Y29sdW1ucywKICAgICkKCiAgICAjIFByaW50IHRoZSBoZWFkIG9mIHRoZSBwcm9kdWNlZCBkYXRhZnJhbWUgYW5kIHJldHVybjoKICAgIGlmIHZlcmJvc2U6CiAgICAgICAgX0xPR0dFUi5pbmZvKAogICAgICAgICAgICBmIkRvbmUgKHtzdWNjZXNzZXMuc2hhcGVbMF19L3tsZW4odGV4dF9maWxlcyl9KVxuIgogICAgICAgICAgICBmIkFuc3dlcnMgc3VtbWFyeTpcbiIKICAgICAgICAgICAgZiJ7c3VjY2Vzc2VzLmhlYWQoKX0iCiAgICAgICAgKQogICAgcmV0dXJuIHN1Y2Nlc3NlcywgZXJyb3JzCgoKZGVmIF9nZXRfdGV4dF9maWxlcygKICAgIGRhdGFfcGF0aDogcGF0aGxpYi5QYXRoLAopIC0+IExpc3RbcGF0aGxpYi5QYXRoXToKICAgICMgQ2hlY2sgaWYgdGhlIHBhdGggaXMgb2YgYSBkaXJlY3Rvcnkgb3IgYSBmaWxlOgogICAgaWYgZGF0YV9wYXRoLmlzX2RpcigpOgogICAgICAgICMgR2V0IGFsbCBmaWxlcyBpbnNpZGUgdGhlIGRpcmVjdG9yeToKICAgICAgICB0ZXh0X2ZpbGVzID0gbGlzdChkYXRhX3BhdGguZ2xvYigiKi4qIikpCiAgICBlbGlmIGRhdGFfcGF0aC5pc19maWxlKCk6CiAgICAgICAgdGV4dF9maWxlcyA9IFtkYXRhX3BhdGhdCiAgICBlbHNlOgogICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoCiAgICAgICAgICAgIGYiVW5yZWNvZ25pemVkIGRhdGEgcGF0aC4gVGhlIHBhcmFtZXRlciBgZGF0YV9wYXRoYCBtdXN0IGJlIGVpdGhlciBhIGRpcmVjdG9yeSBwYXRoIG9yIGEgZmlsZSBwYXRoLiAiCiAgICAgICAgICAgIGYiR2l2ZW46IHtzdHIoZGF0YV9wYXRoKX0gIgogICAgICAgICkKCiAgICByZXR1cm4gdGV4dF9maWxlcwoKCmRlZiBfZ2V0X3Byb21wdF90ZW1wbGF0ZSgKICAgIHRleHRfd3JhcHBlcjogc3RyLAogICAgcXVlc3Rpb25zX3dyYXBwZXI6IHN0ciwKICAgIHF1ZXN0aW9uczogTGlzdFtzdHJdLAopIC0+IHN0cjoKICAgICMgVmFsaWRhdGUgYW5kIGJ1aWxkIHRoZSB0ZXh0IHdyYXBwZXI6CiAgICB0ZXh0X3dyYXBwZXIgPSB0ZXh0X3dyYXBwZXIgb3IgKAogICAgICAgICJHaXZlbiB0aGUgZm9sbG93aW5nIHRleHQ6XG4iICItLS0tLVxuIiAie31cbiIgIi0tLS0tIgogICAgKQogICAgaWYgdGV4dF93cmFwcGVyLmNvdW50KCJ7fSIpICE9IDE6CiAgICAgICAgcmFpc2UgVmFsdWVFcnJvcigKICAgICAgICAgICAgIlRoZSBgdGV4dF93cmFwcGVyYCBtdXN0IGluY2x1ZGUgb25lIHBsYWNlaG9sZGVyICd7fScgZm9yIHRoZSB0ZXh0IG9mIHRoZSBmaWxlIHRvIGJlIGFza2VkIGFib3V0LiIKICAgICAgICApCgogICAgIyBWYWxpZGF0ZSBhbmQgYnVpbGQgdGhlIHF1ZXN0aW9uIHdyYXBwZXI6CiAgICBxdWVzdGlvbnNfd3JhcHBlciA9IHF1ZXN0aW9uc193cmFwcGVyIG9yICJBbnN3ZXIgdGhlIHF1ZXN0aW9uczpcbiIgInt9IgogICAgaWYgcXVlc3Rpb25zX3dyYXBwZXIuY291bnQoInt9IikgIT0gMToKICAgICAgICByYWlzZSBWYWx1ZUVycm9yKAogICAgICAgICAgICAiVGhlIGBxdWVzdGlvbnNfd3JhcHBlcmAgbXVzdCBpbmNsdWRlIG9uZSBwbGFjZWhvbGRlciAne30nIGZvciB0aGUgbGlzdCBvZiBxdWVzdGlvbnMuIgogICAgICAgICkKCiAgICAjIFZhbGlkYXRlIGFuZCBwYXJzZSB0aGUgcXVlc3Rpb25zOgogICAgaWYgbGVuKHF1ZXN0aW9ucykgPT0gMDoKICAgICAgICByYWlzZSBWYWx1ZUVycm9yKCJQbGVhc2UgaW5jbHVkZSBhdCBsZWFzdCBvbmUgcXVlc3Rpb24uIikKICAgIHF1ZXN0aW9ucyA9ICJcbiIuam9pbigKICAgICAgICBbZiJ7aX0uIHtxdWVzdGlvbn0iIGZvciBpLCBxdWVzdGlvbiBpbiBlbnVtZXJhdGUocXVlc3Rpb25zLCAxKV0KICAgICkKCiAgICAjIENvbnN0cnVjdCB0aGUgdGVtcGxhdGU6CiAgICByZXR1cm4gZiJ7dGV4dF93cmFwcGVyfVxue3F1ZXN0aW9uc193cmFwcGVyLmZvcm1hdChxdWVzdGlvbnMpfVxuIgoKCmRlZiBfZ2V0X2dlbmVyYXRpb25fcGlwZWxpbmUoCiAgICBtb2RlbF9uYW1lOiBzdHIsCiAgICBkZXZpY2VfbWFwOiBVbmlvbltzdHIsIGRpY3RdLAogICAgdG9rZW5pemVyX25hbWU6IHN0ciwKICAgIG1vZGVsX2t3YXJnczogZGljdCwKICAgIHRva2VuaXplcl9rd2FyZ3M6IGRpY3QsCiAgICBhdXRvX2dwdHFfZXhsbGFtYV9tYXhfaW5wdXRfbGVuZ3RoOiBpbnQgPSBOb25lLAogICAgYmF0Y2hfc2l6ZTogaW50ID0gMSwKKToKICAgICMgTG9hZCB0aGUgbW9kZWw6CiAgICBtb2RlbCA9IHRyYW5zZm9ybWVycy5BdXRvTW9kZWxGb3JDYXVzYWxMTS5mcm9tX3ByZXRyYWluZWQoCiAgICAgICAgbW9kZWxfbmFtZSwgZGV2aWNlX21hcD1kZXZpY2VfbWFwLCAqKm1vZGVsX2t3YXJncwogICAgKQoKICAgICMgU2V0IGV4bGxhbWEgbWF4IGlucHV0IGxlbmd0aCBpZiBwcm92aWRlZDoKICAgICMgVGhpcyBjaGFuZ2VzIHRoZSBtb2RlbCdzIGNvbnRleHQgc2l6ZS4KICAgIGlmIGF1dG9fZ3B0cV9leGxsYW1hX21heF9pbnB1dF9sZW5ndGg6CiAgICAgICAgZnJvbSBhdXRvX2dwdHEgaW1wb3J0IGV4bGxhbWFfc2V0X21heF9pbnB1dF9sZW5ndGgKCiAgICAgICAgbW9kZWwgPSBleGxsYW1hX3NldF9tYXhfaW5wdXRfbGVuZ3RoKAogICAgICAgICAgICBtb2RlbD1tb2RlbCwgbWF4X2lucHV0X2xlbmd0aD1hdXRvX2dwdHFfZXhsbGFtYV9tYXhfaW5wdXRfbGVuZ3RoCiAgICAgICAgKQoKICAgICMgTG9hZCB0aGUgdG9rZW5pemVyOgogICAgdG9rZW5pemVyID0gdHJhbnNmb3JtZXJzLkF1dG9Ub2tlbml6ZXIuZnJvbV9wcmV0cmFpbmVkKAogICAgICAgIHRva2VuaXplcl9uYW1lLCAqKnRva2VuaXplcl9rd2FyZ3MKICAgICkKCiAgICAjIEluaXRpYWxpemUgYSBnZW5lcmF0aW9uIHBpcGxpbmUgYW5kIHJldHVybjoKICAgIHBpcGUgPSB0cmFuc2Zvcm1lcnMucGlwZWxpbmUoCiAgICAgICAgdGFzaz0idGV4dC1nZW5lcmF0aW9uIiwKICAgICAgICBtb2RlbD1tb2RlbCwKICAgICAgICB0b2tlbml6ZXI9dG9rZW5pemVyLAogICAgICAgIGJhdGNoX3NpemU9YmF0Y2hfc2l6ZSwKICAgICkKICAgIHBpcGUudG9rZW5pemVyLnBhZF90b2tlbl9pZCA9IG1vZGVsLmNvbmZpZy5lb3NfdG9rZW5faWQKICAgIHJldHVybiBwaXBlCgoKZGVmIF9yZWFkX2ZpbGVfYmF0Y2goCiAgICBmaWxlX2JhdGNoOiBMaXN0W3BhdGhsaWIuUGF0aF0sCiAgICBwcm9tcHRfdGVtcGxhdGU6IHN0ciwKKSAtPiBMaXN0W3N0cl06CiAgICBiYXRjaCA9IFtdCiAgICAjIEdvIG92ZXIgYWxsIGZpbGVzIGFuZCByZWFkIGluIHVzYWJsZSBmb3JtYXQKICAgIGZvciBmaWxlIGluIGZpbGVfYmF0Y2g6CiAgICAgICAgd2l0aCBvcGVuKGZpbGUsICJyIiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZnA6CiAgICAgICAgICAgIGJhdGNoLmFwcGVuZChwcm9tcHRfdGVtcGxhdGUuZm9ybWF0KGZwLnJlYWQoKSkpCiAgICByZXR1cm4gYmF0Y2gKCgpkZWYgX2xpc3RfbWUobGlzdF90b19jaGVjazogbGlzdCwgbmFtZTogc3RyLCBsZW5ndGg6IGludCk6CiAgICAjIENoZWNrIGlmIGlzIGxpc3QsIHR1cm4gdG8gbGlzdCBpZiBub3QKICAgIGxpc3RfdG9fY2hlY2sgPSAoCiAgICAgICAgbGlzdF90b19jaGVjayBpZiBpc2luc3RhbmNlKGxpc3RfdG9fY2hlY2ssIGxpc3QpIGVsc2UgW2xpc3RfdG9fY2hlY2tdCiAgICApCiAgICBsaXN0X2xlbiA9IGxlbihsaXN0X3RvX2NoZWNrKQogICAgIyBJZiBub3QgYSBsaXN0LCBvciBpcyBhIGxpc3Qgb2YgbGVuIDEgd2UgZHVwbGljYXRlIGZvciBjb3JyZWN0IGxlbmd0aAogICAgIyBJZiBsaXN0IGluIHdyb25nIGxlbmd0aCB0aHJvdyBhbiBlcnJvcgogICAgaWYgbGlzdF9sZW4gIT0gbGVuZ3RoOgogICAgICAgIGlmIGxpc3RfbGVuID09IDE6CiAgICAgICAgICAgIHJldHVybiBsaXN0X3RvX2NoZWNrICogbGVuZ3RoCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmFpc2UgVmFsdWVFcnJvcigKICAgICAgICAgICAgICAgIGYiVGhlIGFyZ3VtZW50IHZhbHVlIG9mICd7bmFtZX0nIGlzIG5vdCBlcXVhbCB0byB0aGUgbGVuZ3RoIG9mIHRoZSBnaXZlbiBxdWVzdGlvbnMgLSB7bGVuZ3RofSIKICAgICAgICAgICAgKQogICAgcmV0dXJuIGxpc3RfdG9fY2hlY2sKCgpjbGFzcyBRdWVzdGlvbkhhbmRsZXI6CiAgICAiIiIKICAgIEEgY2xhc3MgZm9yIGhhbmRsaW5nIHF1ZXN0aW9ucyBhbnN3ZXJpbmcgZm9yIGEgZ2l2ZW4gcXVlc3Rpb24gdHlwZS4KICAgIFRoaXMgY2xhc3MgaXMgdXNlZCBhcyBhIGJhc2UgY2xhc3MgZm9yIGFsbCBxdWVzdGlvbiB0eXBlcywgYW5kIGZvciBkZWZhdWx0IHF1ZXN0aW9uIHR5cGUgKHJlZ3VsYXIgcXVlc3Rpb24KICAgIGFuc3dlcmluZyB3aXRob3V0IGFueSBzcGVjaWFsIGhhbmRsaW5nKS4KICAgICIiIgoKICAgIGNsYXNzIENvbmZpZ0tleXM6CiAgICAgICAgcGFzcwoKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBxdXN0aW9uX2NvbmZpZzogZGljdCA9IE5vbmUpOgogICAgICAgIGlmIHF1c3Rpb25fY29uZmlnIGlzIE5vbmU6CiAgICAgICAgICAgIHF1c3Rpb25fY29uZmlnID0ge30KICAgICAgICBzZWxmLnR5cGUgPSBxdXN0aW9uX2NvbmZpZy5nZXQoInR5cGUiKSBvciAiZGVmYXVsdCIKCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgX2dldF9hbnN3ZXJzKGdlbmVyYXRlZF90ZXh0OiBzdHIsIHF1ZXN0aW9uc19hbW91bnQ6IGludCkgLT4gTGlzdFtzdHJdOgogICAgICAgICMgQ2xlYXIgYW5zd2VyIHN0YXJ0IChwYXJ0IGJlZm9yZSBudW1iZXJzKToKICAgICAgICAjIFRPRE8gZmluZCBiZXR0ZXIgd2F5IHRvIHZlcmlmeSwgZm9yIGxpc3Qgb2YgcXVlc3Rpb25zIHRoaXMgaXMgcmVkdW5kYW50IGZvciBleGFtcGxlCiAgICAgICAgaWYgIjEuIiBub3QgaW4gZ2VuZXJhdGVkX3RleHQ6CiAgICAgICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoCiAgICAgICAgICAgICAgICBmIkFuc3dlciAxLiBpcyBtaXNzaW5nIGZyb20gdGhlIGdlbmVyYXRlZCB0ZXh0OiAne2dlbmVyYXRlZF90ZXh0fSciCiAgICAgICAgICAgICkKICAgICAgICB0ZXh0ID0gZ2VuZXJhdGVkX3RleHQuc3BsaXQoIjEuIiwgMSlbMV0KCiAgICAgICAgIyBTdGFydCBleHRyYWN0aW5nIHRoZSBhbnN3ZXJzOgogICAgICAgIGFuc3dlcnMgPSBbXQogICAgICAgIGZvciBpIGluIHJhbmdlKDEsIHF1ZXN0aW9uc19hbW91bnQgKyAxKToKICAgICAgICAgICAgIyBJZiBpdCdzIHRoZSBsYXN0IGFuc3dlciB0byBsb29rIGZvciwgdGFrZSB0aGUgcmVzdCBvZiB0aGUgdGV4dDoKICAgICAgICAgICAgaWYgaSA9PSBxdWVzdGlvbnNfYW1vdW50OgogICAgICAgICAgICAgICAgYW5zd2VyX2kgPSB0ZXh0CiAgICAgICAgICAgICMgVmVyaWZ5IHRoZXJlIGlzIGEgcXVlc3Rpb24gbnVtYmVyIGluIHRoZSB0ZXh0OgogICAgICAgICAgICBlbGlmIGYie2kgKyAxfS4iIG5vdCBpbiB0ZXh0OgogICAgICAgICAgICAgICAgcmFpc2UgVmFsdWVFcnJvcigKICAgICAgICAgICAgICAgICAgICBmIkFuc3dlciB7aSArIDF9LiBpcyBtaXNzaW5nIGZyb20gdGhlIGdlbmVyYXRlZCB0ZXh0OiAne2dlbmVyYXRlZF90ZXh0fSciCiAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICMgVGFrZSBpJ3MgYW5zd2VyOgogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgYW5zd2VyX2ksIHRleHQgPSB0ZXh0LnNwbGl0KGYie2kgKyAxfS4iLCAxKQogICAgICAgICAgICAjIENvbGxlY3QgdGhlIGFuc3dlciByZW1vdmluZyByZWR1bmRhbnQgc3BhY2VzOgogICAgICAgICAgICBhbnN3ZXJzLmFwcGVuZChhbnN3ZXJfaS5zdHJpcCgpKQoKICAgICAgICByZXR1cm4gYW5zd2VycwoKICAgIGRlZiBfYW5zd2VyX3F1ZXN0aW9ucygKICAgICAgICBzZWxmLAogICAgICAgIHF1ZXN0aW9uc19hbW91bnQ6IGludCwKICAgICAgICBiYXRjaGVkX2lucHV0OiBMaXN0W3N0cl0sCiAgICAgICAgZ2VuZXJhdGlvbl9waXBlbGluZTogdHJhbnNmb3JtZXJzLlBpcGVsaW5lLAogICAgICAgIGdlbmVyYXRpb25fY29uZmlnOiB0cmFuc2Zvcm1lcnMuR2VuZXJhdGlvbkNvbmZpZywKICAgICkgLT4gTGlzdFtMaXN0W3N0cl1dOgogICAgICAgICMgSW5mZXIgdGhyb3VnaCB0aGUgbGxtOgogICAgICAgIGJhdGNoZWRfb3V0cHV0ID0gZ2VuZXJhdGlvbl9waXBlbGluZSgKICAgICAgICAgICAgYmF0Y2hlZF9pbnB1dCwKICAgICAgICAgICAgZ2VuZXJhdGlvbl9jb25maWc9Z2VuZXJhdGlvbl9jb25maWcsCiAgICAgICAgICAgIGVvc190b2tlbl9pZD1nZW5lcmF0aW9uX3BpcGVsaW5lLnRva2VuaXplci5lb3NfdG9rZW5faWQsCiAgICAgICAgICAgIHJldHVybl9mdWxsX3RleHQ9RmFsc2UsCiAgICAgICAgICAgIG51bV9yZXR1cm5fc2VxdWVuY2VzPTEsCiAgICAgICAgKQogICAgICAgICMgUHJvY2VzcyB0aGUgb3V0cHV0cyB0byBnZXQgdGhlIGFuc3dlcnM6CiAgICAgICAgYmF0Y2hlZF9hbnN3ZXJzID0gW10KICAgICAgICBmb3Igb3V0cHV0IGluIGJhdGNoZWRfb3V0cHV0OgogICAgICAgICAgICAjIEdldCB0aGUgZ2VuZXJhdGVkIGFuc3dlcnM6CiAgICAgICAgICAgIGFuc3dlcnMgPSBzZWxmLl9nZXRfYW5zd2VycygKICAgICAgICAgICAgICAgIGdlbmVyYXRlZF90ZXh0PW91dHB1dFswXVsiZ2VuZXJhdGVkX3RleHQiXSwKICAgICAgICAgICAgICAgIHF1ZXN0aW9uc19hbW91bnQ9cXVlc3Rpb25zX2Ftb3VudCwKICAgICAgICAgICAgKQogICAgICAgICAgICAjIENvbGxlY3QgdGhlIHByb2Nlc3NlZCBhbnN3ZXJzOgogICAgICAgICAgICBiYXRjaGVkX2Fuc3dlcnMuYXBwZW5kKGFuc3dlcnMpCiAgICAgICAgcmV0dXJuIGJhdGNoZWRfYW5zd2VycwoKICAgIGRlZiBoYW5kbGVfcXVlc3Rpb25zKAogICAgICAgIHNlbGYsCiAgICAgICAgcXVlc3Rpb25zX2Ftb3VudDogaW50LAogICAgICAgIGJhdGNoZWRfaW5wdXQ6IExpc3Rbc3RyXSwKICAgICAgICBnZW5lcmF0aW9uX3BpcGVsaW5lOiB0cmFuc2Zvcm1lcnMuUGlwZWxpbmUsCiAgICAgICAgZ2VuZXJhdGlvbl9jb25maWc6IHRyYW5zZm9ybWVycy5HZW5lcmF0aW9uQ29uZmlnLAogICAgKSAtPiBMaXN0W0xpc3Rbc3RyXV06CiAgICAgICAgIiIiCiAgICAgICAgQW5zd2VyIHF1ZXN0aW9ucyB3aXRoIGEgY29udGV4dCB0byB0aGUgZ2l2ZW4gdGV4dCBmaWxlcyBjb250ZW50cyBieSBhIHByZXRyYWluZWQgTExNIG1vZGVsIGluIGdpdmVuIHBpcGVsaW5lLgogICAgICAgICIiIgogICAgICAgIHJldHVybiBzZWxmLl9hbnN3ZXJfcXVlc3Rpb25zKAogICAgICAgICAgICBxdWVzdGlvbnNfYW1vdW50PXF1ZXN0aW9uc19hbW91bnQsCiAgICAgICAgICAgIGJhdGNoZWRfaW5wdXQ9YmF0Y2hlZF9pbnB1dCwKICAgICAgICAgICAgZ2VuZXJhdGlvbl9waXBlbGluZT1nZW5lcmF0aW9uX3BpcGVsaW5lLAogICAgICAgICAgICBnZW5lcmF0aW9uX2NvbmZpZz1nZW5lcmF0aW9uX2NvbmZpZywKICAgICAgICApCgoKY2xhc3MgUG9sbFF1ZXN0aW9uSGFuZGxlcihRdWVzdGlvbkhhbmRsZXIpOgogICAgIiIiCiAgICBBIGNsYXNzIGZvciBoYW5kbGluZyBxdWVzdGlvbnMgYW5zd2VyaW5nIGZvciBwb2xsIHR5cGUgcXVlc3Rpb25zLgogICAgVGhlc2UgdHlwZSBvZiBxdWVzdGlvbiBhcmUgYW5zd2VyZWQgYnkgYXNraW5nIHRoZSBzYW1lIHF1ZXN0aW9uIG11bHRpcGxlIHRpbWVzCiAgICBhbmQgY2hvb3NpbmcgdGhlIG1vc3QgY29tbW9uIGFuc3dlciBvciB0aGUgYXZlcmFnZSBhbnN3ZXIuCiAgICAiIiIKCiAgICBjbGFzcyBDb25maWdLZXlzOgogICAgICAgICIiIgogICAgICAgIEEgY2xhc3MgZm9yIGhhbmRsaW5nIHF1ZXN0aW9ucyBhbnN3ZXJpbmcgZm9yIHBvbGwgdHlwZSBxdWVzdGlvbnMuCiAgICAgICAgVGhlc2UgdHlwZSBvZiBxdWVzdGlvbiBhcmUgYW5zd2VyZWQgYnkgYXNraW5nIHRoZSBzYW1lIHF1ZXN0aW9uIG11bHRpcGxlIHRpbWVzCiAgICAgICAgYW5kIGNob29zaW5nIHRoZSBtb3N0IGNvbW1vbiBhbnN3ZXIgb3IgdGhlIGF2ZXJhZ2UgYW5zd2VyLgogICAgICAgICIiIgoKICAgICAgICAjOiBUaGUgbnVtYmVyIG9mIHRpbWVzIHRvIGFzayB0aGUgc2FtZSBxdWVzdGlvbi4KICAgICAgICBQT0xMX0NPVU5UID0gInBvbGxfY291bnQiCiAgICAgICAgIzogVGhlIHN0cmF0ZWd5IHRvIHVzZSBmb3IgY2hvb3NpbmcgdGhlIGFuc3dlciBmcm9tIHRoZSBwb2xsLgogICAgICAgIFBPTExfU1RSQVRFR1kgPSAicG9sbF9zdHJhdGVneSIKICAgICAgICAjOiBUaGUgbW9zdCBjb21tb24gYW5zd2VyIHN0cmF0ZWd5LgogICAgICAgIE1PU1RfQ09NTU9OID0gIm1vc3RfY29tbW9uIgogICAgICAgICM6IFRoZSBhdmVyYWdlIGFuc3dlciBzdHJhdGVneS4KICAgICAgICBBVkVSQUdFID0gImF2ZXJhZ2UiCgogICAgZGVmIF9faW5pdF9fKHNlbGYsIHF1ZXN0aW9uX2NvbmZpZzogZGljdCk6CiAgICAgICAgc3VwZXIoKS5fX2luaXRfXyhxdWVzdGlvbl9jb25maWcpCiAgICAgICAgc2VsZi5wb2xsX2NvdW50ID0gcXVlc3Rpb25fY29uZmlnLmdldChzZWxmLkNvbmZpZ0tleXMuUE9MTF9DT1VOVCkgb3IgNQogICAgICAgIHNlbGYucG9sbF9zdHJhdGVneSA9ICgKICAgICAgICAgICAgcXVlc3Rpb25fY29uZmlnLmdldChzZWxmLkNvbmZpZ0tleXMuUE9MTF9TVFJBVEVHWSkgb3IgIm1vc3RfY29tbW9uIgogICAgICAgICkKCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgX21vc3RfY29tbW9uX2Fuc3dlcihhbnN3ZXJzKToKICAgICAgICAiIiIKICAgICAgICBDYWxjdWxhdGUgdGhlIG1vc3QgY29tbW9uIGFuc3dlciBmb3IgYSBnaXZlbiBsaXN0IG9mIGFuc3dlcnMuCiAgICAgICAgIiIiCiAgICAgICAgY291bnQgPSBDb3VudGVyKGFuc3dlcnMpCiAgICAgICAgbW9zdF9jb21tb24gPSBjb3VudC5tb3N0X2NvbW1vbigxKQogICAgICAgIHJldHVybiBtb3N0X2NvbW1vblswXVswXQoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBfYXZlcmFnZV9hbnN3ZXIoYW5zd2Vycyk6CiAgICAgICAgIiIiCiAgICAgICAgQ2FsY3VsYXRlIHRoZSBhdmVyYWdlIGFuc3dlciBmb3IgYSBnaXZlbiBsaXN0IG9mIGFuc3dlcnMuCiAgICAgICAgIiIiCiAgICAgICAgaWYgaXNpbnN0YW5jZShhbnN3ZXJzWzBdLCBzdHIpOgogICAgICAgICAgICByYWlzZSBWYWx1ZUVycm9yKAogICAgICAgICAgICAgICAgIkNhbm5vdCBwZXJmb3JtIHBvbGwgd2l0aCBhdmVyYWdlIGFuc3dlciBzdHJhdGVneSBvZiBub24gbnVtZXJpYyB2YWx1ZXMsIgogICAgICAgICAgICAgICAgIiBwbGVhc2UgY2hhbmdlIHRoZSBxdWVzdGlvbiB0byBnaXZlIG51bWVyaWMgZGF0YSwgb3IgY2hvb3NlICdtb3N0X2NvbW1vbicgYXMgc3RyYXRlZ3kuIgogICAgICAgICAgICApCiAgICAgICAgZWxzZToKICAgICAgICAgICAgbnVtZXJpY192YWx1ZXMgPSBhbnN3ZXJzCiAgICAgICAgYXZnID0gc3VtKG51bWVyaWNfdmFsdWVzKSAvIGxlbihudW1lcmljX3ZhbHVlcykKICAgICAgICAjIFJvdW5kIHRvIHRoZSBjbG9zZXN0IGludGVnZXIgYW5kIHJldHVybiBjb3JyZXNwb25kaW5nIHZhbHVlCiAgICAgICAgcmV0dXJuIHJvdW5kKGF2ZykKCiAgICBkZWYgaGFuZGxlX3F1ZXN0aW9ucygKICAgICAgICBzZWxmLAogICAgICAgIHF1ZXN0aW9uc19hbW91bnQ6IGludCwKICAgICAgICBiYXRjaGVkX2lucHV0OiBMaXN0W3N0cl0sCiAgICAgICAgZ2VuZXJhdGlvbl9waXBlbGluZTogdHJhbnNmb3JtZXJzLlBpcGVsaW5lLAogICAgICAgIGdlbmVyYXRpb25fY29uZmlnOiB0cmFuc2Zvcm1lcnMuR2VuZXJhdGlvbkNvbmZpZywKICAgICkgLT4gTGlzdFtMaXN0W3N0cl1dOgogICAgICAgICIiIgogICAgICAgIEFuc3dlciBxdWVzdGlvbnMgd2l0aCBhIGNvbnRleHQgdG8gdGhlIGdpdmVuIHRleHQgZmlsZXMgY29udGVudHMgYnkgYSBwcmV0cmFpbmVkIExMTSBtb2RlbCBpbiBnaXZlbiBwaXBlbGluZS4KICAgICAgICAiIiIKICAgICAgICByZXR1cm4gc2VsZi5fYW5zd2VyX3BvbGxfcXVlc3Rpb25zKAogICAgICAgICAgICBxdWVzdGlvbnNfYW1vdW50PXF1ZXN0aW9uc19hbW91bnQsCiAgICAgICAgICAgIGJhdGNoZWRfaW5wdXQ9YmF0Y2hlZF9pbnB1dCwKICAgICAgICAgICAgZ2VuZXJhdGlvbl9waXBlbGluZT1nZW5lcmF0aW9uX3BpcGVsaW5lLAogICAgICAgICAgICBnZW5lcmF0aW9uX2NvbmZpZz1nZW5lcmF0aW9uX2NvbmZpZywKICAgICAgICApCgogICAgZGVmIF9hbnN3ZXJfcG9sbF9xdWVzdGlvbnMoCiAgICAgICAgc2VsZiwKICAgICAgICBxdWVzdGlvbnNfYW1vdW50OiBpbnQsCiAgICAgICAgYmF0Y2hlZF9pbnB1dDogTGlzdFtzdHJdLAogICAgICAgIGdlbmVyYXRpb25fcGlwZWxpbmU6IHRyYW5zZm9ybWVycy5QaXBlbGluZSwKICAgICAgICBnZW5lcmF0aW9uX2NvbmZpZzogdHJhbnNmb3JtZXJzLkdlbmVyYXRpb25Db25maWcsCiAgICApIC0+IExpc3RbTGlzdFtzdHJdXToKICAgICAgICB2b3RlcyA9IFtdCiAgICAgICAgIyBSdW4gdGhlIHBvbGwgZm9yIGVhY2ggcXVlc3Rpb24KICAgICAgICBmb3IgXyBpbiByYW5nZShzZWxmLnBvbGxfY291bnQpOgogICAgICAgICAgICBiYXRjaGVkX2Fuc3dlcnMgPSBzZWxmLl9hbnN3ZXJfcXVlc3Rpb25zKAogICAgICAgICAgICAgICAgcXVlc3Rpb25zX2Ftb3VudD1xdWVzdGlvbnNfYW1vdW50LAogICAgICAgICAgICAgICAgYmF0Y2hlZF9pbnB1dD1iYXRjaGVkX2lucHV0LAogICAgICAgICAgICAgICAgZ2VuZXJhdGlvbl9waXBlbGluZT1nZW5lcmF0aW9uX3BpcGVsaW5lLAogICAgICAgICAgICAgICAgZ2VuZXJhdGlvbl9jb25maWc9Z2VuZXJhdGlvbl9jb25maWcsCiAgICAgICAgICAgICkKICAgICAgICAgICAgdm90ZXMuYXBwZW5kKGJhdGNoZWRfYW5zd2VycykKICAgICAgICBhbnN3ZXJzID0gW10KICAgICAgICAjIENvbGxlY3QgdGhlIGFuc3dlcnMgYWNjb3JkaW5nIHRvIHRoZSBwb2xsIHN0cmF0ZWd5CiAgICAgICAgIyBBdmVyYWdlIHN0cmF0ZWd5IHdvcmtzIGZvciBudW1lcmljIHZhbHVlcyBvbmx5CiAgICAgICAgZm9yIGJhdGNoIGluIHJhbmdlKGxlbih2b3Rlc1swXSkpOgogICAgICAgICAgICBiYXRjaGVkX2Fuc3dlcnMgPSBbXQogICAgICAgICAgICBmb3IgcXVlc3Rpb24gaW4gcmFuZ2UocXVlc3Rpb25zX2Ftb3VudCk6CiAgICAgICAgICAgICAgICAjIENyZWF0ZSBhIGxpc3Qgb2YgYWxsIGFuc3dlcnMgdG8gcmVsZXZhbnQgcXVlc3Rpb24KICAgICAgICAgICAgICAgIGFuc3dlciA9IFsKICAgICAgICAgICAgICAgICAgICB2b3Rlc1t2b3Rlcl1bYmF0Y2hdW3F1ZXN0aW9uXSBmb3Igdm90ZXIgaW4gcmFuZ2Uoc2VsZi5wb2xsX2NvdW50KQogICAgICAgICAgICAgICAgXQogICAgICAgICAgICAgICAgaWYgc2VsZi5wb2xsX3N0cmF0ZWd5ID09IHNlbGYuQ29uZmlnS2V5cy5NT1NUX0NPTU1PTjoKICAgICAgICAgICAgICAgICAgICBhbnN3ZXIgPSBzZWxmLl9tb3N0X2NvbW1vbl9hbnN3ZXIoYW5zd2VyKQogICAgICAgICAgICAgICAgZWxpZiBzZWxmLnBvbGxfc3RyYXRlZ3kgPT0gc2VsZi5Db25maWdLZXlzLkFWRVJBR0U6CiAgICAgICAgICAgICAgICAgICAgYW5zd2VyID0gc2VsZi5fYXZlcmFnZV9hbnN3ZXIoYW5zd2VyKQogICAgICAgICAgICAgICAgYmF0Y2hlZF9hbnN3ZXJzLmFwcGVuZChhbnN3ZXIpCiAgICAgICAgICAgIGFuc3dlcnMuYXBwZW5kKGJhdGNoZWRfYW5zd2VycykKICAgICAgICByZXR1cm4gYW5zd2VycwoKCiMgSG9sZHMgbmFtZXMgb2YgUXVlc3Rpb25IYW5kbGVzCmNsYXNzIFF1ZXN0aW9uQ29uc3RhbnRzOgogICAgREVGQVVMVCA9ICJkZWZhdWx0IgogICAgUE9MTCA9ICJwb2xsIgoKCiMgTWFwcyBxdWVzdGlvbiB0eXBlcyB0byB0aGVpciBoYW5kbGVycwpRVUVTVElPTl9NQVBQSU5HID0gewogICAgUXVlc3Rpb25Db25zdGFudHMuREVGQVVMVDogUXVlc3Rpb25IYW5kbGVyLAogICAgUXVlc3Rpb25Db25zdGFudHMuUE9MTDogUG9sbFF1ZXN0aW9uSGFuZGxlciwKfQo=
    base_image: mlrun/mlrun
    commands: []
    code_origin: ''
    origin_filename: ''
    requirements:
    - transformers torch tqdm
  entry_points:
    open_mpi_handler:
      name: open_mpi_handler
      doc: ''
      parameters:
      - name: worker_inputs
        type: List[str]
        default: ''
      - name: root_worker_inputs
        type: Dict[str, Any]
        default: null
      outputs:
      - default: ''
      lineno: 57
    decorator:
      name: decorator
      doc: ''
      parameters:
      - name: handler
        default: ''
      outputs:
      - default: ''
      lineno: 65
    wrapper:
      name: wrapper
      doc: ''
      parameters: []
      outputs:
      - default: ''
      lineno: 70
    answer_questions:
      name: answer_questions
      doc: 'Answer questions with a context to the given text files contents by a
        pretrained LLM model. Each text file will have

        the following prompt built:


        start of `text_wrapper`

        <text file content>

        end of `text_wrapper`


        start of `questions_wrapper`

        1. <questions[0]>

        2. <questions[1]>

        ...

        n. <questions[n-1]>

        end of `questions_wrapper`'
      parameters:
      - name: data_path
        type: Union[str, List[str]]
        doc: A path to a directory of text files or a path to a text file to ask questions
          about.
        default: ''
      - name: model_name
        type: str
        doc: The pre-trained model name from the huggingface hub to use for asking
          questions.
        default: ''
      - name: questions
        type: Union[List[str], List[List[str]]]
        doc: The questions to ask.
        default: ''
      - name: device_map
        type: Union[str, dict]
        doc: A map to use for loading the model on multiple devices.
        default: null
      - name: model_kwargs
        type: dict
        doc: Keyword arguments to pass for loading the model using HuggingFace's `transformers.AutoModelForCausalLM.from_pretrained`
          function.
        default: null
      - name: auto_gptq_exllama_max_input_length
        type: int
        doc: For AutoGPTQ models to set and extend the model's input buffer size.
        default: null
      - name: tokenizer_name
        type: str
        doc: The tokenizer name from the huggingface hub to use. If not given, the
          model name will be used.
        default: null
      - name: tokenizer_kwargs
        type: dict
        doc: Keyword arguments to pass for loading the tokenizer using HuggingFace's
          `transformers.AutoTokenizer.from_pretrained` function.
        default: null
      - name: text_wrapper
        type: Union[str, List[str]]
        doc: A wrapper for the file's text. Will be added at the start of the prompt.
          Must have a placeholder ('{}') for the text of the file.
        default: ''
      - name: questions_wrapper
        type: Union[str, List[str]]
        doc: A wrapper for the questions received. Will be added after the text wrapper
          in the prompt template. Must have a placeholder ('{}') for the questions.
        default: ''
      - name: generation_config
        type: Union[Dict, List[Dict]]
        doc: HuggingFace's `GenerationConfig` keyword arguments to pass to the `generate`
          method.
        default: null
      - name: questions_config
        type: Union[Dict, List[Dict]]
        doc: A dictionary or list of dictionaries containing specific ways to answer
          questions (using a poll for example).
        default: null
      - name: batch_size
        type: int
        doc: Batch size for inference.
        default: 1
      - name: questions_columns
        type: List[str]
        doc: Columns to use for the dataframe returned.
        default: null
      - name: verbose
        type: bool
        doc: 'Whether to present logs of a progress bar and errors. Default: True.'
        default: false
      outputs:
      - default: ''
        doc: 'A tuple of:'
      lineno: 129
    handle_questions:
      name: handle_questions
      doc: Answer questions with a context to the given text files contents by a pretrained
        LLM model in given pipeline.
      parameters:
      - name: self
        default: ''
      - name: questions_amount
        type: int
        default: ''
      - name: batched_input
        type: List[str]
        default: ''
      - name: generation_pipeline
        type: Pipeline
        default: ''
      - name: generation_config
        type: GenerationConfig
        default: ''
      outputs:
      - default: ''
      lineno: 625
  description: GenAI approach of question answering on a given data
  default_handler: answer_questions
  disable_auto_mount: false
  clone_target_dir: ''
  env: []
  priority_class_name: ''
  preemption_mode: prevent
  affinity: null
  tolerations: null
  security_context: {}
verbose: false
