kind: job
metadata:
  name: huggingface-auto-trainer
  tag: ''
  hash: c1f93ee094c69aba9a22c4e919939f451904148b
  project: ''
  labels:
    author: Zeevr
  categories:
  - machine-learning
  - model-training
spec:
  command: ''
  args: []
  image: mlrun/mlrun
  build:
    functionSourceCode: aW1wb3J0IGltcG9ydGxpYgppbXBvcnQgb3MKaW1wb3J0IHNodXRpbAppbXBvcnQgdGVtcGZpbGUKaW1wb3J0IHppcGZpbGUKZnJvbSBhYmMgaW1wb3J0IEFCQwpmcm9tIHR5cGluZyBpbXBvcnQgRGljdCwgTGlzdCwgVHVwbGUsIFVuaW9uCgppbXBvcnQgbWxydW4KaW1wb3J0IG51bXB5IGFzIG5wCmltcG9ydCBwYW5kYXMgYXMgcGQKaW1wb3J0IHBlZnQKaW1wb3J0IHRvcmNoCmltcG9ydCB0cmFuc2Zvcm1lcnMKZnJvbSBkYXRhc2V0cyBpbXBvcnQgRGF0YXNldCwgbG9hZF9kYXRhc2V0CmZyb20gbWxydW4uYXJ0aWZhY3RzLm1hbmFnZXIgaW1wb3J0IEFydGlmYWN0LCBQbG90bHlBcnRpZmFjdApmcm9tIG1scnVuLmRhdGFzdG9yZSBpbXBvcnQgaXNfc3RvcmVfdXJpCmZyb20gbWxydW4uZnJhbWV3b3Jrcy5fY29tbW9uIGltcG9ydCBDb21tb25UeXBlcywgTUxSdW5JbnRlcmZhY2UKZnJvbSBtbHJ1bi51dGlscyBpbXBvcnQgbG9nZ2VyCmZyb20gcGVmdCBpbXBvcnQgKExvcmFDb25maWcsIFBlZnRNb2RlbCwgZ2V0X3BlZnRfbW9kZWwsCiAgICAgICAgICAgICAgICAgIHByZXBhcmVfbW9kZWxfZm9yX2tiaXRfdHJhaW5pbmcpCmZyb20gcGxvdGx5IGltcG9ydCBncmFwaF9vYmplY3RzIGFzIGdvCmZyb20gdHJhbnNmb3JtZXJzIGltcG9ydCAoQXV0b01vZGVsRm9yQ2F1c2FsTE0sIEF1dG9Ub2tlbml6ZXIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgQml0c0FuZEJ5dGVzQ29uZmlnLCBEYXRhQ29sbGF0b3JGb3JMYW5ndWFnZU1vZGVsaW5nLAogICAgICAgICAgICAgICAgICAgICAgICAgIFByZVRyYWluZWRNb2RlbCwgUHJlVHJhaW5lZFRva2VuaXplciwgVHJhaW5lciwKICAgICAgICAgICAgICAgICAgICAgICAgICBUcmFpbmVyQ2FsbGJhY2ssIFRyYWluZXJDb250cm9sLCBUcmFpbmVyU3RhdGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgVHJhaW5pbmdBcmd1bWVudHMpCgpzdXBwb3J0ZWRfdGFza3MgPSBbCiAgICAicXVlc3Rpb24tYW5zd2VyaW5nIiwKICAgICJzdW1tYXJpemF0aW9uIiwKICAgICJ0YWJsZS1xdWVzdGlvbi1hbnN3ZXJpbmciLAogICAgInRleHQydGV4dC1nZW5lcmF0aW9uIiwKICAgICJ0ZXh0LWNsYXNzaWZpY2F0aW9uIiwKICAgICJzZW50aW1lbnQtYW5hbHlzaXMiLAogICAgInRleHQtZ2VuZXJhdGlvbiIsCiAgICAidG9rZW4tY2xhc3NpZmljYXRpb24iLAogICAgInRyYW5zbGF0aW9uIiwKICAgICJ0cmFuc2xhdGlvbl94eF90b195eSIsCl0KCgpjbGFzcyBDb25maWdLZXlzOgogICAgZGVlcHNwZWVkID0gImRlZXBzcGVlZCIKICAgIHF1YW50aXphdGlvbiA9ICJxdWFudGl6YXRpb24iCiAgICBsb3JhID0gImxvcmEiCiAgICB0cmFpbmluZyA9ICJ0cmFpbmluZyIKICAgIHRva2VuaXplcl9wcmV0cmFpbmVkID0gInRva2VuaXplcl9wcmV0cmFpbmVkIgogICAgbW9kZWxfcHJldHJhaW5lZCA9ICJtb2RlbF9wcmV0cmFpbmVkIgogICAgZGF0YV9jb2xsYXRvciA9ICJkYXRhX2NvbGxhdG9yIgoKCiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLWZyb20gTUxSVU4tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQpjbGFzcyBIRlRyYWluZXJNTFJ1bkludGVyZmFjZShNTFJ1bkludGVyZmFjZSwgQUJDKToKICAgICIiIgogICAgVGhpcyBpcyB0ZW1wb3JhcnkgYW5kIHdpbGwgYmUgYnVpbHQgaW4gbWxydW4gMS41LjAKICAgIEludGVyZmFjZSBmb3IgYWRkaW5nIE1MUnVuIGZlYXR1cmVzIGZvciB0ZW5zb3JmbG93IGtlcmFzIEFQSS4KICAgICIiIgoKICAgICMgTUxSdW5zIGNvbnRleHQgZGVmYXVsdCBuYW1lOgogICAgREVGQVVMVF9DT05URVhUX05BTUUgPSAibWxydW4taHVnZ2luZ2ZhY2UiCgogICAgIyBBdHRyaWJ1dGVzIHRvIHJlcGxhY2Ugc28gdGhlIE1MUnVuIGludGVyZmFjZSB3aWxsIGJlIGZ1bGx5IGVuYWJsZWQuCiAgICBfUkVQTEFDRURfTUVUSE9EUyA9IFsKICAgICAgICAidHJhaW4iLAogICAgICAgICMgImV2YWx1YXRlIgogICAgXQoKICAgIEBjbGFzc21ldGhvZAogICAgZGVmIF9hZGRfaW50ZXJmYWNlKAogICAgICAgIGNscywKICAgICAgICBvYmo6IFRyYWluZXIsCiAgICAgICAgcmVzdG9yYXRpb246IENvbW1vblR5cGVzLk1MUnVuSW50ZXJmYWNlUmVzdG9yYXRpb25UeXBlID0gTm9uZSwKICAgICk6CiAgICAgICAgc3VwZXIoSEZUcmFpbmVyTUxSdW5JbnRlcmZhY2UsIGNscykuX2FkZF9pbnRlcmZhY2UoCiAgICAgICAgICAgIG9iaj1vYmosIHJlc3RvcmF0aW9uPXJlc3RvcmF0aW9uCiAgICAgICAgKQoKICAgIEBjbGFzc21ldGhvZAogICAgZGVmIF9tbHJ1bl90cmFpbihjbHMpOgogICAgICAgIGRlZiBfd3JhcHBlcihzZWxmOiBUcmFpbmVyLCAqYXJncywgKiprd2FyZ3MpOgogICAgICAgICAgICAjIFJlc3RvcmUgdGhlIGV2YWx1YXRpb24gbWV0aG9kIGFzIGB0cmFpbmAgd2lsbCB1c2UgaXQ6CiAgICAgICAgICAgICMgY2xzLl9yZXN0b3JlX2F0dHJpYnV0ZShvYmo9c2VsZiwgYXR0cmlidXRlX25hbWU9ImV2YWx1YXRlIikKCiAgICAgICAgICAgICMgQ2FsbCB0aGUgb3JpZ2luYWwgZml0IG1ldGhvZDoKICAgICAgICAgICAgcmVzdWx0ID0gc2VsZi5vcmlnaW5hbF90cmFpbigqYXJncywgKiprd2FyZ3MpCgogICAgICAgICAgICAjIFJlcGxhY2UgdGhlIGV2YWx1YXRpb24gbWV0aG9kIGFnYWluOgogICAgICAgICAgICAjIGNscy5fcmVwbGFjZV9mdW5jdGlvbihvYmo9c2VsZiwgZnVuY3Rpb25fbmFtZT0iZXZhbHVhdGUiKQoKICAgICAgICAgICAgcmV0dXJuIHJlc3VsdAoKICAgICAgICByZXR1cm4gX3dyYXBwZXIKCgpjbGFzcyBNTFJ1bkNhbGxiYWNrKFRyYWluZXJDYWxsYmFjayk6CiAgICAiIiIKICAgIFRoaXMgaXMgdGVtcG9yYXJ5IGFuZCB3aWxsIGJlIGJ1aWx0IGluIG1scnVuIDEuNS4wCiAgICBDYWxsYmFjayBmb3IgY29sbGVjdGluZyBsb2dzIGR1cmluZyB0cmFpbmluZyAvIGV2YWx1YXRpb24gb2YgdGhlIGBUcmFpbmVyYCBBUEkuCiAgICAiIiIKCiAgICBkZWYgX19pbml0X18oCiAgICAgICAgc2VsZiwKICAgICAgICBjb250ZXh0OiBtbHJ1bi5NTENsaWVudEN0eCA9IE5vbmUsCiAgICAgICAgbW9kZWxfbmFtZTogc3RyID0gIm1vZGVsIiwKICAgICAgICB0YWc6IHN0ciA9ICIiLAogICAgICAgIGxhYmVsczogRGljdFtzdHIsIHN0cl0gPSBOb25lLAogICAgICAgIGV4dHJhX2RhdGE6IGRpY3QgPSBOb25lLAogICAgKToKICAgICAgICBzdXBlcigpLl9faW5pdF9fKCkKCiAgICAgICAgIyBTdG9yZSB0aGUgY29uZmlndXJhdGlvbnM6CiAgICAgICAgc2VsZi5fY29udGV4dCA9ICgKICAgICAgICAgICAgY29udGV4dAogICAgICAgICAgICBpZiBjb250ZXh0IGlzIG5vdCBOb25lCiAgICAgICAgICAgIGVsc2UgbWxydW4uZ2V0X29yX2NyZWF0ZV9jdHgoIi4vbWxydW4taHVnZ2luZ2ZhY2UiKQogICAgICAgICkKICAgICAgICBzZWxmLl9tb2RlbF9uYW1lID0gbW9kZWxfbmFtZQogICAgICAgIHNlbGYuX3RhZyA9IHRhZwogICAgICAgIHNlbGYuX2xhYmVscyA9IGxhYmVscwogICAgICAgIHNlbGYuX2V4dHJhX2RhdGEgPSBleHRyYV9kYXRhIGlmIGV4dHJhX2RhdGEgaXMgbm90IE5vbmUgZWxzZSB7fQoKICAgICAgICAjIFNldCB1cCB0aGUgbG9nZ2luZyBtb2RlOgogICAgICAgIHNlbGYuX2lzX3RyYWluaW5nID0gRmFsc2UKICAgICAgICBzZWxmLl9zdGVwczogTGlzdFtMaXN0W2ludF1dID0gW10KICAgICAgICBzZWxmLl9tZXRyaWNfc2NvcmVzOiBEaWN0W3N0ciwgTGlzdFtmbG9hdF1dID0ge30KICAgICAgICBzZWxmLl9hcnRpZmFjdHM6IERpY3Rbc3RyLCBBcnRpZmFjdF0gPSB7fQoKICAgIGRlZiBfb25fZXBvY2hfYmVnaW4oCiAgICAgICAgc2VsZiwKICAgICAgICBhcmdzOiBUcmFpbmluZ0FyZ3VtZW50cywKICAgICAgICBzdGF0ZTogVHJhaW5lclN0YXRlLAogICAgICAgIGNvbnRyb2w6IFRyYWluZXJDb250cm9sLAogICAgICAgICoqa3dhcmdzLAogICAgKToKICAgICAgICBpZiBub3Qgc3RhdGUuaXNfd29ybGRfcHJvY2Vzc196ZXJvOgogICAgICAgICAgICByZXR1cm4KICAgICAgICBzZWxmLl9zdGVwcy5hcHBlbmQoW10pCgogICAgZGVmIF9vbl9lcG9jaF9lbmQoCiAgICAgICAgc2VsZiwKICAgICAgICBhcmdzOiBUcmFpbmluZ0FyZ3VtZW50cywKICAgICAgICBzdGF0ZTogVHJhaW5lclN0YXRlLAogICAgICAgIGNvbnRyb2w6IFRyYWluZXJDb250cm9sLAogICAgICAgICoqa3dhcmdzLAogICAgKToKICAgICAgICBpZiBub3Qgc3RhdGUuaXNfd29ybGRfcHJvY2Vzc196ZXJvOgogICAgICAgICAgICByZXR1cm4KICAgICAgICBzZWxmLl9sb2dfbWV0cmljcygpCgogICAgZGVmIF9vbl9sb2coCiAgICAgICAgc2VsZiwKICAgICAgICBhcmdzOiBUcmFpbmluZ0FyZ3VtZW50cywKICAgICAgICBzdGF0ZTogVHJhaW5lclN0YXRlLAogICAgICAgIGNvbnRyb2w6IFRyYWluZXJDb250cm9sLAogICAgICAgIGxvZ3M6IERpY3Rbc3RyLCBmbG9hdF0gPSBOb25lLAogICAgICAgICoqa3dhcmdzLAogICAgKToKICAgICAgICBpZiBub3Qgc3RhdGUuaXNfd29ybGRfcHJvY2Vzc196ZXJvOgogICAgICAgICAgICByZXR1cm4KICAgICAgICByZWNlbnRfbG9ncyA9IHN0YXRlLmxvZ19oaXN0b3J5Wy0xXS5jb3B5KCkKCiAgICAgICAgcmVjZW50X2xvZ3MucG9wKCJlcG9jaCIpCiAgICAgICAgY3VycmVudF9zdGVwID0gaW50KHJlY2VudF9sb2dzLnBvcCgic3RlcCIpKQogICAgICAgIGlmIGN1cnJlbnRfc3RlcCBub3QgaW4gc2VsZi5fc3RlcHNbLTFdOgogICAgICAgICAgICBzZWxmLl9zdGVwc1stMV0uYXBwZW5kKGN1cnJlbnRfc3RlcCkKCiAgICAgICAgZm9yIG1ldHJpY19uYW1lLCBtZXRyaWNfc2NvcmUgaW4gcmVjZW50X2xvZ3MuaXRlbXMoKToKICAgICAgICAgICAgaWYgbWV0cmljX25hbWUuc3RhcnRzd2l0aCgidHJhaW5fIik6CiAgICAgICAgICAgICAgICBpZiBtZXRyaWNfbmFtZS5zcGxpdCgidHJhaW5fIilbMV0gbm90IGluIHNlbGYuX21ldHJpY19zY29yZXM6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5fbWV0cmljX3Njb3Jlc1ttZXRyaWNfbmFtZV0gPSBbbWV0cmljX3Njb3JlXQogICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgaWYgbWV0cmljX25hbWUgbm90IGluIHNlbGYuX21ldHJpY19zY29yZXM6CiAgICAgICAgICAgICAgICBzZWxmLl9tZXRyaWNfc2NvcmVzW21ldHJpY19uYW1lXSA9IFtdCiAgICAgICAgICAgIHNlbGYuX21ldHJpY19zY29yZXNbbWV0cmljX25hbWVdLmFwcGVuZChtZXRyaWNfc2NvcmUpCgogICAgZGVmIF9vbl90cmFpbl9iZWdpbigKICAgICAgICBzZWxmLAogICAgICAgIGFyZ3M6IFRyYWluaW5nQXJndW1lbnRzLAogICAgICAgIHN0YXRlOiBUcmFpbmVyU3RhdGUsCiAgICAgICAgY29udHJvbDogVHJhaW5lckNvbnRyb2wsCiAgICAgICAgKiprd2FyZ3MsCiAgICApOgogICAgICAgIGlmIG5vdCBzdGF0ZS5pc193b3JsZF9wcm9jZXNzX3plcm86CiAgICAgICAgICAgIHJldHVybgogICAgICAgIHNlbGYuX2lzX3RyYWluaW5nID0gVHJ1ZQoKICAgIGRlZiBfb25fdHJhaW5fZW5kKAogICAgICAgIHNlbGYsCiAgICAgICAgYXJnczogVHJhaW5pbmdBcmd1bWVudHMsCiAgICAgICAgc3RhdGU6IFRyYWluZXJTdGF0ZSwKICAgICAgICBjb250cm9sOiBUcmFpbmVyQ29udHJvbCwKICAgICAgICBtb2RlbDogUHJlVHJhaW5lZE1vZGVsID0gTm9uZSwKICAgICAgICB0b2tlbml6ZXI6IFByZVRyYWluZWRUb2tlbml6ZXIgPSBOb25lLAogICAgICAgICoqa3dhcmdzLAogICAgKToKICAgICAgICBpZiBub3Qgc3RhdGUuaXNfd29ybGRfcHJvY2Vzc196ZXJvOgogICAgICAgICAgICByZXR1cm4KICAgICAgICBzZWxmLl9sb2dfbWV0cmljcygpCgogICAgZGVmIF9vbl9ldmFsdWF0ZSgKICAgICAgICBzZWxmLAogICAgICAgIGFyZ3M6IFRyYWluaW5nQXJndW1lbnRzLAogICAgICAgIHN0YXRlOiBUcmFpbmVyU3RhdGUsCiAgICAgICAgY29udHJvbDogVHJhaW5lckNvbnRyb2wsCiAgICAgICAgKiprd2FyZ3MsCiAgICApOgogICAgICAgIGlmIG5vdCBzdGF0ZS5pc193b3JsZF9wcm9jZXNzX3plcm86CiAgICAgICAgICAgIHJldHVybgogICAgICAgIHNlbGYuX2xvZ19tZXRyaWNzKCkKCiAgICAgICAgaWYgc2VsZi5faXNfdHJhaW5pbmc6CiAgICAgICAgICAgIHJldHVybgoKICAgIGRlZiBfbG9nX21ldHJpY3Moc2VsZik6CiAgICAgICAgZm9yIG1ldHJpY19uYW1lLCBtZXRyaWNfc2NvcmVzIGluIHNlbGYuX21ldHJpY19zY29yZXMuaXRlbXMoKToKICAgICAgICAgICAgc2VsZi5fY29udGV4dC5sb2dfcmVzdWx0KGtleT1tZXRyaWNfbmFtZSwgdmFsdWU9bWV0cmljX3Njb3Jlc1stMV0pCiAgICAgICAgICAgIGlmIGxlbihtZXRyaWNfc2NvcmVzKSA+IDE6CiAgICAgICAgICAgICAgICBzZWxmLl9sb2dfbWV0cmljX3Bsb3QobmFtZT1tZXRyaWNfbmFtZSwgc2NvcmVzPW1ldHJpY19zY29yZXMpCiAgICAgICAgc2VsZi5fY29udGV4dC5jb21taXQoY29tcGxldGVkPUZhbHNlKQoKICAgIGRlZiBfbG9nX21ldHJpY19wbG90KHNlbGYsIG5hbWU6IHN0ciwgc2NvcmVzOiBMaXN0W2Zsb2F0XSk6CiAgICAgICAgIyBJbml0aWFsaXplIGEgcGxvdGx5IGZpZ3VyZToKICAgICAgICBtZXRyaWNfZmlndXJlID0gZ28uRmlndXJlKCkKCiAgICAgICAgIyBBZGQgdGl0bGVzOgogICAgICAgIG1ldHJpY19maWd1cmUudXBkYXRlX2xheW91dCgKICAgICAgICAgICAgdGl0bGU9bmFtZS5jYXBpdGFsaXplKCkucmVwbGFjZSgiXyIsICIgIiksCiAgICAgICAgICAgIHhheGlzX3RpdGxlPSJTYW1wbGVzIiwKICAgICAgICAgICAgeWF4aXNfdGl0bGU9IlNjb3JlcyIsCiAgICAgICAgKQoKICAgICAgICAjIERyYXc6CiAgICAgICAgbWV0cmljX2ZpZ3VyZS5hZGRfdHJhY2UoCiAgICAgICAgICAgIGdvLlNjYXR0ZXIoeD1ucC5hcmFuZ2UobGVuKHNjb3JlcykpLCB5PXNjb3JlcywgbW9kZT0ibGluZXMiKQogICAgICAgICkKCiAgICAgICAgIyBDcmVhdGUgdGhlIHBsb3RseSBhcnRpZmFjdDoKICAgICAgICBhcnRpZmFjdF9uYW1lID0gZiJ7bmFtZX1fcGxvdCIKICAgICAgICBhcnRpZmFjdCA9IFBsb3RseUFydGlmYWN0KGtleT1hcnRpZmFjdF9uYW1lLCBmaWd1cmU9bWV0cmljX2ZpZ3VyZSkKICAgICAgICBzZWxmLl9hcnRpZmFjdHNbYXJ0aWZhY3RfbmFtZV0gPSBzZWxmLl9jb250ZXh0LmxvZ19hcnRpZmFjdChhcnRpZmFjdCkKCgpkZWYgX2FwcGx5X21scnVuKAogICAgdHJhaW5lcjogdHJhbnNmb3JtZXJzLlRyYWluZXIsCiAgICBtb2RlbF9uYW1lOiBzdHIgPSBOb25lLAogICAgdGFnOiBzdHIgPSAiIiwKICAgIGNvbnRleHQ6IG1scnVuLk1MQ2xpZW50Q3R4ID0gTm9uZSwKICAgIGF1dG9fbG9nOiBib29sID0gVHJ1ZSwKICAgIGxhYmVsczogRGljdFtzdHIsIHN0cl0gPSBOb25lLAogICAgZXh0cmFfZGF0YTogZGljdCA9IE5vbmUsCiAgICAqKmt3YXJncywKKToKICAgICIiIgogICAgVGhpcyBpcyB0ZW1wb3JhcnkgYW5kIHdpbGwgYmUgYnVpbHQgaW4gbWxydW4gMS41LjAKICAgICIiIgogICAgIyBHZXQgcGFyYW1ldGVycyBkZWZhdWx0czoKICAgIGlmIGNvbnRleHQgaXMgTm9uZToKICAgICAgICBjb250ZXh0ID0gbWxydW4uZ2V0X29yX2NyZWF0ZV9jdHgoSEZUcmFpbmVyTUxSdW5JbnRlcmZhY2UuREVGQVVMVF9DT05URVhUX05BTUUpCgogICAgSEZUcmFpbmVyTUxSdW5JbnRlcmZhY2UuX2FkZF9pbnRlcmZhY2Uob2JqPXRyYWluZXIpCgogICAgaWYgYXV0b19sb2c6CiAgICAgICAgdHJhaW5lci5hZGRfY2FsbGJhY2soCiAgICAgICAgICAgIE1MUnVuQ2FsbGJhY2soCiAgICAgICAgICAgICAgICBjb250ZXh0PWNvbnRleHQsCiAgICAgICAgICAgICAgICBtb2RlbF9uYW1lPW1vZGVsX25hbWUsCiAgICAgICAgICAgICAgICB0YWc9dGFnLAogICAgICAgICAgICAgICAgbGFiZWxzPWxhYmVscywKICAgICAgICAgICAgICAgIGV4dHJhX2RhdGE9ZXh0cmFfZGF0YSwKICAgICAgICAgICAgKQogICAgICAgICkKCgojIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS1lbmQgZnJvbSBNTFJVTi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCgoKZGVmIF9wcmludF90cmFpbmFibGVfcGFyYW1ldGVycyhtb2RlbCk6CiAgICAiIiIKICAgIFByaW50cyB0aGUgbnVtYmVyIG9mIHRyYWluYWJsZSBwYXJhbWV0ZXJzIGluIHRoZSBtb2RlbC4KICAgICIiIgogICAgdHJhaW5hYmxlX3BhcmFtcyA9IDAKICAgIGFsbF9wYXJhbSA9IDAKICAgIGZvciBfLCBwYXJhbSBpbiBtb2RlbC5uYW1lZF9wYXJhbWV0ZXJzKCk6CiAgICAgICAgYWxsX3BhcmFtICs9IHBhcmFtLm51bWVsKCkKICAgICAgICBpZiBwYXJhbS5yZXF1aXJlc19ncmFkOgogICAgICAgICAgICB0cmFpbmFibGVfcGFyYW1zICs9IHBhcmFtLm51bWVsKCkKICAgIHByaW50KAogICAgICAgIGYidHJhaW5hYmxlIHBhcmFtczoge3RyYWluYWJsZV9wYXJhbXN9IHx8IGFsbCBwYXJhbXM6IHthbGxfcGFyYW19IHx8IHRyYWluYWJsZSU6IgogICAgICAgIGYiIHsxMDAgKiB0cmFpbmFibGVfcGFyYW1zIC8gYWxsX3BhcmFtfSIKICAgICkKCgojIGRlZmF1bHQgY29uZmlncwojIHdpbGwgYmUgdXNlZCBpZiB1c2VyIHByb3ZpZGVzICJUcnVlIiB3aXRoIGNvbmZpZyBuYW1lIGFzIGlucHV0ClFVQU5USVpBVElPTl9DT05GSUcgPSB0cmFuc2Zvcm1lcnMuQml0c0FuZEJ5dGVzQ29uZmlnKAogICAgbG9hZF9pbl80Yml0PVRydWUsCiAgICBibmJfNGJpdF91c2VfZG91YmxlX3F1YW50PVRydWUsCiAgICBibmJfNGJpdF9xdWFudF90eXBlPSJuZjQiLAogICAgYm5iXzRiaXRfY29tcHV0ZV9kdHlwZT10b3JjaC5iZmxvYXQxNiwKKQoKTE9SQV9DT05GSUcgPSBwZWZ0LkxvcmFDb25maWcoCiAgICByPTgsCiAgICBsb3JhX2FscGhhPTMyLAogICAgdGFyZ2V0X21vZHVsZXM9WyJxdWVyeV9rZXlfdmFsdWUiXSwKICAgIGxvcmFfZHJvcG91dD0wLjA1LAogICAgYmlhcz0ibm9uZSIsCiAgICB0YXNrX3R5cGU9IkNBVVNBTF9MTSIsCikKCkRFRVBTUEVFRF9DT05GSUcgPSB7CiAgICAidHJhaW5fbWljcm9fYmF0Y2hfc2l6ZV9wZXJfZ3B1IjogImF1dG8iLAogICAgImZwMTYiOiB7ImVuYWJsZWQiOiBUcnVlfSwKICAgICJhdXRvdHVuaW5nIjogewogICAgICAgICJlbmFibGVkIjogVHJ1ZSwKICAgICAgICAiYXJnX21hcHBpbmdzIjogewogICAgICAgICAgICAidHJhaW5fbWljcm9fYmF0Y2hfc2l6ZV9wZXJfZ3B1IjogIi0tcGVyX2RldmljZV90cmFpbl9iYXRjaF9zaXplIiwKICAgICAgICAgICAgImdyYWRpZW50X2FjY3VtdWxhdGlvbl9zdGVwcyAiOiAiLS1ncmFkaWVudF9hY2N1bXVsYXRpb25fc3RlcHMiLAogICAgICAgIH0sCiAgICB9LAogICAgInplcm9fb3B0aW1pemF0aW9uIjogewogICAgICAgICJzdGFnZSI6IDIsCiAgICB9LAp9CgoKZGVmIF91cGRhdGVfY29uZmlnKHNyYzogZGljdCwgZHN0OiBkaWN0KToKICAgICIiIgogICAgdXBkYXRlIGNvbmZpZ3MgYWNjb3JkaW5nIHRvIHVzZXIsIHRoaXMgd2F5IHRoZSB1c2VyIGNhbiBhZGQvbW9kaWZ5IHZhbHVlcyBpbiBkZWZhdWx0IGNvbmZpZ3MgZm9yIGUuZy4KCiAgICBnb2VzIG92ZXIgYWxsIGNvbmZpZ3MgYW5kIGNvcnJlc3BvbmRpbmcgcHJlZml4ZXMsIGNvbGxlY3QgYWxsIHRoZSBrZXlzIGZyb20gdGhlIGdpdmVuIGRpY3QgdGhhdCBzdGFydAogICAgIHdpdGggdGhlIHByZWZpeCBhbmQgYWRkIHRoZW0gdG8gYXBwcm9wcmlhdGUgY29uZmlnCgogICAgOnBhcmFtIHNyYzogZGljdCBvZiBhbGwgY2FuZGlkYXRlIHZhbHVlcyB0byB1cGRhdGUgZGljdC4KICAgIDpwYXJhbSBkc3Q6IGRpY3QgY29udGFpbmluZyBhbGwgY29uZmlncyB0byB1cGRhdGUuCiAgICAiIiIKCiAgICBmb3IgY29uZmlnX25hbWUsIGNvbmZpZyBpbiBkc3QuaXRlbXMoKToKCiAgICAgICAgIyBJZiBnaXZlbiBUcnVlIHdlIHVzZSBkZWZhdWx0IGRpY3QKICAgICAgICAjIENhbiBhbHNvIGJlIEZhbHNlIG9yIGEgY29uZmlnIGRpY3QgZ2l2ZW4gZnJvbSB1c2VyLCBzbyB3ZSBjaGVjayBzcGVjaWZpY2FsbHkgZm8gVHJ1ZQogICAgICAgIGlmIGNvbmZpZyBpcyBUcnVlIGFuZCBjb25maWdfbmFtZSA9PSAicXVhbnRpemF0aW9uIjoKICAgICAgICAgICAgY29uZmlnID0gUVVBTlRJWkFUSU9OX0NPTkZJRwoKICAgICAgICBpZiBjb25maWcgaXMgVHJ1ZSBhbmQgY29uZmlnX25hbWUgPT0gImxvcmEiOgogICAgICAgICAgICBjb25maWcgPSBMT1JBX0NPTkZJRwoKICAgICAgICBpZiBjb25maWcgaXMgVHJ1ZSBhbmQgY29uZmlnX25hbWUgPT0gImRlZXBzcGVlZCI6CiAgICAgICAgICAgIGNvbmZpZyA9IERFRVBTUEVFRF9DT05GSUcKCiAgICAgICAgIyBpbiBzb21lIGNhc2VzIHdlIGNhbiBnZXQgYSBib29sZWFuIHZhbHVlLCBpbiB0aGF0IGNhc2Ugbm8gbmVlZCB0byBsb29rIGZvciBhcmdzCiAgICAgICAgaWYgaXNpbnN0YW5jZShjb25maWcsIGJvb2wpOgogICAgICAgICAgICBjb25maWcgPSBOb25lCgogICAgICAgIGVsaWYgaXNpbnN0YW5jZShjb25maWcsIGRpY3QpOgogICAgICAgICAgICBmb3Iga2V5LCB2YWwgaW4gc3JjLml0ZW1zKCk6CiAgICAgICAgICAgICAgICBpZiBrZXkuc3RhcnRzd2l0aChjb25maWdfbmFtZSk6CiAgICAgICAgICAgICAgICAgICAgY29uZmlnW2tleS5yZXBsYWNlKGYie2NvbmZpZ19uYW1lfV8iLCAiIildID0gdmFsCgogICAgICAgICMgdXBkYXRlIGJ5IGNvbmZpZyBuYW1lCiAgICAgICAgZWxzZToKICAgICAgICAgICAgZm9yIGtleSwgdmFsIGluIHNyYy5pdGVtcygpOgogICAgICAgICAgICAgICAgaWYga2V5LnN0YXJ0c3dpdGgoY29uZmlnX25hbWUpOgogICAgICAgICAgICAgICAgICAgIHNldGF0dHIoY29uZmlnLCBrZXkucmVwbGFjZShmIntjb25maWdfbmFtZX1fIiwgIiIpLCB2YWwpCgogICAgICAgIGRzdC51cGRhdGUoe2NvbmZpZ19uYW1lOiBjb25maWd9KQoKCmRlZiBfZ2V0X2NsYXNzX29iamVjdChjbGFzc19wYXRoOiBzdHIpIC0+IHR5cGU6CiAgICAiIiIKICAgIGdpdmVuIGEgZnVsbCBjbGFzcyBuYW1lLCB0aGlzIGZ1bmN0aW9uIHJldHVybnMgdGhlIGNvcnJlY3QgY2xhc3MKCiAgICA6cGFyYW0gY2xhc3NfcGF0aDogYSBmdWxsIGNsYXNzIG5hbWUgKGV4LiAndHJhbnNmb3JtZXJzLkF1dG9Nb2RlbEZvckNhdXNhbExNJykKCiAgICA6cmV0dXJuIHRoZSB3YW50ZWQgY2xhc3Mgb2JqZWN0CiAgICAiIiIKICAgIG1vZHVsZV9wYXRoLCBjbGFzc19uYW1lID0gY2xhc3NfcGF0aC5yc3BsaXQoIi4iLCAxKQogICAgbW9kdWxlID0gaW1wb3J0bGliLmltcG9ydF9tb2R1bGUobW9kdWxlX3BhdGgpCiAgICByZXR1cm4gZ2V0YXR0cihtb2R1bGUsIGNsYXNzX25hbWUpCgoKZGVmIF9zZXRfbW9kZWxfYW5kX3Rva2VuaXplcigKICAgIG1vZGVsOiBVbmlvbltzdHIsIFR1cGxlW3N0ciwgc3RyXV0sCiAgICB0b2tlbml6ZXI6IFVuaW9uW3N0ciwgVHVwbGVbc3RyLCBzdHJdXSwKICAgIHRhc2s6IHN0ciwKICAgIGZyYW1ld29yazogc3RyLAogICAgbG9yYV9jb25maWc6IGRpY3QsCiAgICBxdWFudGl6YXRpb25fY29uZmlnOiBkaWN0LAogICAgdXNlX2N1ZGE6IGJvb2wsCiAgICB0b2tlbml6ZXJfcHJldHJhaW5lZF9jb25maWcsCiAgICBtb2RlbF9wcmV0cmFpbmVkX2NvbmZpZywKICAgIGRldmljZV9tYXA6IHN0ciwKKToKICAgICIiIgogICAgZ2V0IHRoZSBjb3JyZWN0IG1vZGVsIGFuZCB0b2tlbml6ZXIgYWNjb3JkaW5nIHRvIGdpdmVuIHVzZXIgaW5wdXRzCgogICAgOnBhcmFtIG1vZGVsOiBhIHR1cGxlIGNvbnRhaW5pbmcgbW9kZWwgbmFtZSBhbmQgY2xhc3MsIG9yIHN0ciB3aXRoIG1vZGVsIG5hbWUgb3IgcGF0aAogICAgOnBhcmFtIHRva2VuaXplcjogYSB0dXBsZSBjb250YWluaW5nIHRva2VuaXplciBuYW1lIGFuZCBjbGFzcywgb3Igc3RyIHdpdGggdG9rZW5pemVyIG5hbWUgb3IgcGF0aAogICAgOnBhcmFtIHRhc2s6IGEgc3VwcG9ydGVkIG5scCB0YXNrLCB1c2VkIHRvIGNob29zZSBtb2RlbCBpZiBub3QgcHJvdmlkZWQKICAgIDpwYXJhbSBmcmFtZXdvcms6IHB0IG9yIHRmCiAgICA6cGFyYW0gbG9yYV9jb25maWc6IGxvcmEgY29uZmlnIG9yIE5vbmUsIHRvIGxvYWQgbW9kZWwgaW4gYXBwcm9wcmlhdGUgd2F5CiAgICA6cGFyYW0gcXVhbnRpemF0aW9uX2NvbmZpZzogcXVhbnRpemF0aW9uIGNvbmZpZyBvciBOb25lLCB0byBsb2FkIG1vZGVsIGluIGFwcHJvcHJpYXRlIHdheQogICAgOnBhcmFtIHVzZV9jdWRhOiB1c2UgZ3B1IG9yIG5vdAogICAgOnBhcmFtIHRva2VuaXplcl9wcmV0cmFpbmVkX2NvbmZpZzogY29uZmlnIHRvIGxvYWQgdGhlIHByZXRyYWluZWQgdG9rZW5pemVyCiAgICA6cGFyYW0gbW9kZWxfcHJldHJhaW5lZF9jb25maWc6IGNvbmZpZyB0byBsb2FkIHRoZSBwcmV0cmFpbmVkIG1vZGVsCiAgICA6cGFyYW0gZGV2aWNlX21hcDogYSBkZXZpY2UgbWFwIGZvciBtb2RlbCB0cmFpbmluZyBpZiB1c2luZyBudW1iZXIgb2YgZ3B1J3MKCiAgICA6cmV0dXJuIG1vZGVsIGFuZCB0b2tlbml6ZXIKICAgICIiIgogICAgIyBpZiB0YXNrIGlzIG5vdCBzdXBwb3J0ZWQgYW5kIG5vIG1vZGVsIHdhcyBnaXZlbiB3ZSBjYW4ndCBjaG9vc2Ugb25lCiAgICBpZiB0YXNrIGFuZCB0YXNrIG5vdCBpbiBzdXBwb3J0ZWRfdGFza3MgYW5kIG5vdCBtb2RlbDoKICAgICAgICBsb2dnZXIuZXJyb3IoInVuc3VwcG9ydGVkIHRhc2sgb3B0aW9uIGNob3NlbiIpCiAgICAgICAgcmFpc2UKCiAgICAjIGxvYWQgbW9kZWwgZnJvbSBzdG9yZQogICAgaWYgaXNpbnN0YW5jZShtb2RlbCwgc3RyKSBhbmQgaXNfc3RvcmVfdXJpKG1vZGVsKToKICAgICAgICBwYXNzCiAgICAgICAgIyBUT0RPOiBsb2FkIGJvdGggbW9kZWwgYW5kIHRva2VuaXplciBhbmQgcmV0dXJuLCBuZWVkIGd1eSdzIGhlbHAKCiAgICAjIGlmIGl0J3MgYSB0dXBsZSB0aGVtIHdlIGFzc3VtZSBpdCBjb250YWlucyBvZiBib3RoIG5hbWUgYW5kIGNsYXNzCiAgICBpZiBpc2luc3RhbmNlKG1vZGVsLCB0dXBsZSk6CiAgICAgICAgbW9kZWxfbmFtZSwgbW9kZWxfY2xhc3MgPSBtb2RlbAogICAgICAgIG1vZGVsX2NsYXNzID0gX2dldF9jbGFzc19vYmplY3QobW9kZWxfY2xhc3MpCgogICAgIyBpbiB0aGUgY2FzZSB3ZSBkb24ndCBnZXQgdGhlIG1vZGVsIGNsYXNzIHdlIG5lZWQgdGhlIHRhc2sgaW4gb3JkZXIgdG8gY2hvb3NlIHRoZSBjb3JyZWN0IG1vZGVsCiAgICBlbHNlOgogICAgICAgIGlmIHRhc2sgaXMgTm9uZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKCJ0YXNrIG11c3QgYmUgY2hvc2VuIGluIG9yZGVyIHRvIGRldGVybWluZSB0aGUgY29ycmVjdCBtb2RlbCIpCiAgICAgICAgICAgIHJhaXNlIEV4Y2VwdGlvbigKICAgICAgICAgICAgICAgICJ0aGlzIGZ1bmN0aW9uIHJlcXVpcmVzIGVpdGhlciBhIHN1cHBvcnRlZCB0YXNrIG9yIGEgbW9kZWwgYW5kIG1vZGVsIGNsYXNzIHRvIGJlIGNob3NlbiIKICAgICAgICAgICAgKQoKICAgICAgICBfLCBhdmFpbGFibGVfY2xhc3NlcywgdGFza19vcHRpb25zID0gdHJhbnNmb3JtZXJzLnBpcGVsaW5lcy5jaGVja190YXNrKHRhc2spCgogICAgICAgIGlmIGlzaW5zdGFuY2UobW9kZWwsIHN0cik6CiAgICAgICAgICAgIG1vZGVsX25hbWUgPSBtb2RlbAoKICAgICAgICAjIGlmIG1vZGVsIGlzIG5vdCBnaXZlbiwgd2UgdGFrZSB0aGUgZGVmYXVsdCBtb2RlbCBmb3IgdGhlIGdpdmVuIHRhc2sKICAgICAgICBlbHNlOgogICAgICAgICAgICBtb2RlbF9uYW1lLCBfID0gdHJhbnNmb3JtZXJzLnBpcGVsaW5lcy5nZXRfZGVmYXVsdF9tb2RlbF9hbmRfcmV2aXNpb24oCiAgICAgICAgICAgICAgICBhdmFpbGFibGVfY2xhc3NlcywgZnJhbWV3b3JrLCB0YXNrX29wdGlvbnMKICAgICAgICAgICAgKQogICAgICAgIGlmIG5vdCBhdmFpbGFibGVfY2xhc3Nlcy5nZXQoZnJhbWV3b3JrLCB0dXBsZSgpKToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKAogICAgICAgICAgICAgICAgImdpdmVuIHRhc2sncyBkZWZhdWx0IG1vZGVsIGlzIG5vdCBzdXBwb3J0ZWQgaW4gc3BlY2lmaWVkIGZyYW1ld29yayIKICAgICAgICAgICAgKQogICAgICAgICAgICByYWlzZSBFeGNlcHRpb24oCiAgICAgICAgICAgICAgICAidGhpcyBmdW5jdGlvbiByZXF1aXJlcyBlaXRoZXIgYSBzdXBwb3J0ZWQgdGFzayBvciBhIG1vZGVsIGFuZCBtb2RlbCBjbGFzcyB0byBiZSBjaG9zZW4iCiAgICAgICAgICAgICkKCiAgICAgICAgbW9kZWxfY2xhc3MgPSBhdmFpbGFibGVfY2xhc3Nlc1tmcmFtZXdvcmtdWzBdCgogICAgIyBsb2FkIHRoZSBwcmV0cmFpbmVkIG1vZGVsCiAgICBpZiB1c2VfY3VkYToKICAgICAgICBkZXZpY2VfbWFwID0gZGV2aWNlX21hcAogICAgZWxzZToKICAgICAgICBkZXZpY2VfbWFwID0gTm9uZQoKICAgIG1vZGVsID0gbW9kZWxfY2xhc3MuZnJvbV9wcmV0cmFpbmVkKAogICAgICAgIG1vZGVsX25hbWUsCiAgICAgICAgcXVhbnRpemF0aW9uX2NvbmZpZz1xdWFudGl6YXRpb25fY29uZmlnLAogICAgICAgIGRldmljZV9tYXA9ZGV2aWNlX21hcCwKICAgICAgICAqKm1vZGVsX3ByZXRyYWluZWRfY29uZmlnLAogICAgKQoKICAgICMgSWYgcXVhbnRpemF0aW9uIGNvbmZpZyBpcyBnaXZlbiB3ZSB3aWxsIGxvYWQgYSBxdWFudGl6ZWQgbW9kZWwsIGlmIG5vdCBhIHJlZ3VsYXIgb25lCiAgICBpZiBxdWFudGl6YXRpb25fY29uZmlnOgogICAgICAgIG1vZGVsLmdyYWRpZW50X2NoZWNrcG9pbnRpbmdfZW5hYmxlKCkKICAgICAgICBtb2RlbCA9IHBlZnQucHJlcGFyZV9tb2RlbF9mb3Jfa2JpdF90cmFpbmluZyhtb2RlbCkKCiAgICAjIElmIGxvcmEgY29uZmlnIHdhcyBnaXZlbiB3ZSB3YW50IHRvIGRvIGxvcmEgZmluZSB0dW5lLCB3ZSB1cGRhdGUgbW9kZWwgaGVyZQogICAgaWYgbG9yYV9jb25maWc6CiAgICAgICAgbW9kZWwgPSBwZWZ0LmdldF9wZWZ0X21vZGVsKG1vZGVsLCBsb3JhX2NvbmZpZykKCiAgICAjIGlmIG5vdCBzcGVjaWZpZWQgd2UgY2hvb3NlIHRoZSBkZWZhdWx0IHRva2VuaXplciB0aGF0IGNvcnJlc3BvbmRpbmcgdG8gdGhlIG1vZGVsCiAgICBpZiB0b2tlbml6ZXIgaXMgTm9uZToKICAgICAgICB0b2tlbml6ZXIgPSB0cmFuc2Zvcm1lcnMuQXV0b1Rva2VuaXplci5mcm9tX3ByZXRyYWluZWQobW9kZWxfbmFtZSkKICAgICAgICByZXR1cm4gbW9kZWxfbmFtZSwgbW9kZWwsIHRva2VuaXplcgoKICAgIGlmIGlzaW5zdGFuY2UodG9rZW5pemVyLCBzdHIpOgogICAgICAgIHRva2VuaXplcl9uYW1lID0gdG9rZW5pemVyCiAgICAgICAgdG9rZW5pemVyX2NsYXNzID0gdHJhbnNmb3JtZXJzLkF1dG9Ub2tlbml6ZXIKCiAgICAjIGlmIGl0J3Mgbm90IGEgc3RyIHRoZW4gaXQncyBhIHR1cGxlIG9mIGJvdGggbmFtZSBhbmQgY2xhc3MKICAgIGVsc2U6CiAgICAgICAgdG9rZW5pemVyX25hbWUsIHRva2VuaXplcl9jbGFzcyA9IHRva2VuaXplcgogICAgICAgIHRva2VuaXplcl9jbGFzcyA9IF9nZXRfY2xhc3Nfb2JqZWN0KHRva2VuaXplcl9jbGFzcykKCiAgICB0b2tlbml6ZXIgPSB0b2tlbml6ZXJfY2xhc3MuZnJvbV9wcmV0cmFpbmVkKAogICAgICAgIHRva2VuaXplcl9uYW1lLCAqKnRva2VuaXplcl9wcmV0cmFpbmVkX2NvbmZpZwogICAgKQoKICAgIGlmIG5vdCB0b2tlbml6ZXIucGFkX3Rva2VuOgogICAgICAgIHRva2VuaXplci5wYWRfdG9rZW4gPSB0b2tlbml6ZXIuZW9zX3Rva2VuCgogICAgcmV0dXJuIG1vZGVsX25hbWUsIG1vZGVsLCB0b2tlbml6ZXIKCgpkZWYgX2RhdGFzZXRfbG9hZGVyKGRhdGFzZXQ6IHN0ciwgaXNfdHJhaW46IGJvb2wgPSBUcnVlLCAqKmt3YXJncykgLT4gRGF0YXNldDoKICAgICIiIgogICAgbG9hZHMgdGhlIHNwZWNpZmljIGRhdGFzZXQgcHJvdmlkZWQgYnkgdGhlIHVzZXIKCiAgICA6cGFyYW0gZGF0YXNldDogbmFtZSBvciBwYXRoIG9mIGRhdGFzZXQgdG8gbG9hZAogICAgOnBhcmFtIGlzX3RyYWluOiBib29sIHRoYXQgaW5kaWNhdGVzIHRoZSBwdXJwb3NlIG9mIHRoZSBkYXRhc2V0CiAgICA6cGFyYW0ga3dhcmdzOiBvdGhlciBrd2FyZ3MgZm9yIGxvYWRpbmcgdGhlIGRhdGFzZXQKCiAgICA6cmV0dXJuIGxvYWRlZCBkYXRhc2V0CiAgICAiIiIKICAgICMgaWYgc3BsaXQgaW4ga3dhcmdzIHRoZW4gdGhlIHVzZXIgZGVjaWRlcyBob3cgdG8gc3BsaXQgdGhlIGRhdGFzZXQKICAgIGlmICJzcGxpdCIgaW4ga3dhcmdzOgogICAgICAgIHJldHVybiBsb2FkX2RhdGFzZXQoZGF0YXNldCwgKiprd2FyZ3MpCgogICAgIyBpZiBpdCdzIGEgZGF0YXNldCBmb3IgdHJhaW4gd2Ugc3BsaXQgd2l0aCB0cmFpbgogICAgaWYgaXNfdHJhaW46CiAgICAgICAgcmV0dXJuIGxvYWRfZGF0YXNldChkYXRhc2V0LCBzcGxpdD0idHJhaW4iLCAqKmt3YXJncykKCiAgICAjIGlmIGl0J3MgZXZhbCBkYXRhc2V0LCB0aGVuIGEgbG90IG9mIG5hbWVzIGFyZSBhY2NlcHRhYmxlIGZvciB0aGUgc2V0IGFuZCB3ZSBjaGVjayBhbGwgb2YgdGhlbQogICAgZGF0YXNldCA9IGxvYWRfZGF0YXNldChkYXRhc2V0LCAqKmt3YXJncykKICAgIGlmICJ0ZXN0IiBpbiBkYXRhc2V0OgogICAgICAgIHJldHVybiBkYXRhc2V0LmdldCgidGVzdCIpCiAgICBlbGlmICJldmFsIiBpbiBkYXRhc2V0OgogICAgICAgIHJldHVybiBkYXRhc2V0LmdldCgiZXZhbCIpCiAgICBlbGlmICJ2YWxpZGF0aW9uIiBpbiBkYXRhc2V0OgogICAgICAgIHJldHVybiBkYXRhc2V0LmdldCgidmFsaWRhdGlvbiIpCgoKZGVmIF9wcmVwYXJlX2RhdGFzZXQoCiAgICB0cmFpbl9kYXRhc2V0OiBzdHIsCiAgICBldmFsX2RhdGFzZXQ6IHN0ciwKICAgIHRyYWluX2xvYWRfZGF0YXNldF9rd2FyZ3MsCiAgICBldmFsX2xvYWRfZGF0YXNldF9rd2FyZ3MsCiAgICB0b2tlbml6ZXIsCiAgICBkYXRhc2V0X2NvbHVtbnNfdG9fdHJhaW46IFVuaW9uW3N0ciwgbGlzdF0sCikgLT4gKERhdGFzZXQsIFVuaW9uW0RhdGFzZXQsIE5vbmVdKToKICAgICIiIgogICAgTG9hZHMgdGhlIHRyYWluIGFuZCBldmFsIGRhdGFzZXRzIChpZiBwcm92aWRlZCkgcGFzc2VzIHRoZW0gdGhyb3VnaCB0aGUgdG9rZW5pemVyIGFuZAogICAgcmV0dXJucyB0aGVtIHJlYWR5IHRvIHVzZSBpbiB0cmFpbmluZwoKICAgIDpwYXJhbSB0cmFpbl9kYXRhc2V0OiB0aGUgbmFtZSBvciBwYXRoIHRvIHRoZSB0cmFpbiBkYXRhc2V0CiAgICA6cGFyYW0gZXZhbF9kYXRhc2V0OiB0aGUgbmFtZSBvciBwYXRoIHRvIHRoZSBldmFsIGRhdGFzZXQKICAgIDpwYXJhbSBkYXRhc2V0X2NvbHVtbnNfdG9fdHJhaW46IHdoaWNoIGNvbHVtbnMgdG8gcGFzcyB0byB0aGUgbW9kZWwgYXMgaW5wdXRzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAobmVlZCB0byBwYXNzIHRocm91Z2ggdGhlIHRva2VuaXplciBmaXJzdCkKICAgIDpwYXJhbSB0cmFpbl9sb2FkX2RhdGFzZXRfa3dhcmdzOiBrd2FyZ3MgZm9yIGRhdGFzZXQgbG9hZGluZwogICAgOnBhcmFtIGV2YWxfbG9hZF9kYXRhc2V0X2t3YXJnczoga3dhcmdzIGZvciBkYXRhc2V0IGxvYWRpbmcKICAgIDpwYXJhbSB0b2tlbml6ZXI6IHRoZSB0b2tlbml6ZXIgdG8gcGFzcyB0aGUgZGF0YSB0aHJvdWdoCgogICAgOnJldHVybiB0b2tlbml6ZWQgZGF0YXNldHMKICAgICIiIgogICAgIyB3ZSB0YWtlIGNvbCBuYW1lL3MgaW4gYSBsaXN0IGZvciBlYXN5IGdlbmVyYWxpemF0aW9uCiAgICBpZiBpc2luc3RhbmNlKGRhdGFzZXRfY29sdW1uc190b190cmFpbiwgc3RyKToKICAgICAgICBkYXRhc2V0X2NvbHVtbnNfdG9fdHJhaW4gPSBbZGF0YXNldF9jb2x1bW5zX3RvX3RyYWluXQoKICAgICMgTG9hZCBkYXRhc2V0cwogICAgIyBpZiBwcm92aWRlZCB0d28gcGF0aHMvbmFtZXMgd2UgbG9hZCBlYWNoIHNlcGFyYXRlbHkgdXNpbmcgZGVzaWduYXRlZCBmdW5jCiAgICBpZiBldmFsX2RhdGFzZXQ6CiAgICAgICAgdHJhaW5fZGF0YXNldCA9IF9kYXRhc2V0X2xvYWRlcigKICAgICAgICAgICAgZGF0YXNldD10cmFpbl9kYXRhc2V0LCBpc190cmFpbj1UcnVlLCAqKnRyYWluX2xvYWRfZGF0YXNldF9rd2FyZ3MKICAgICAgICApCiAgICAgICAgZXZhbF9kYXRhc2V0ID0gX2RhdGFzZXRfbG9hZGVyKAogICAgICAgICAgICBkYXRhc2V0PWV2YWxfZGF0YXNldCwgaXNfdHJhaW49RmFsc2UsICoqZXZhbF9sb2FkX2RhdGFzZXRfa3dhcmdzCiAgICAgICAgKQoKICAgICMgaWYgb25seSBvbiBwYXRoIGlzIGdpdmVuIHRoZW4gd2UgbXVzdCBjaGVjayBpZiBpdCBjb250YWlucyBib3RoIGRhdGFzZXQgb3IgaWYgb25seSBvbmUgc2hvdWxkIGJlIHVzZWQKICAgIGVsc2U6CiAgICAgICAgZGF0YXNldCA9IGxvYWRfZGF0YXNldCh0cmFpbl9kYXRhc2V0LCAqKnRyYWluX2xvYWRfZGF0YXNldF9rd2FyZ3MpCiAgICAgICAgaWYgInRyYWluIiBpbiBkYXRhc2V0OgogICAgICAgICAgICB0cmFpbl9kYXRhc2V0ID0gZGF0YXNldC5nZXQoInRyYWluIikKICAgICAgICAgICAgaWYgInRlc3QiIGluIGRhdGFzZXQ6CiAgICAgICAgICAgICAgICBldmFsX2RhdGFzZXQgPSBkYXRhc2V0LmdldCgidGVzdCIpCiAgICAgICAgICAgIGVsaWYgImV2YWwiIGluIGRhdGFzZXQ6CiAgICAgICAgICAgICAgICBldmFsX2RhdGFzZXQgPSBkYXRhc2V0LmdldCgiZXZhbCIpCiAgICAgICAgICAgIGVsaWYgInZhbGlkYXRpb24iIGluIGRhdGFzZXQ6CiAgICAgICAgICAgICAgICBldmFsX2RhdGFzZXQgPSBkYXRhc2V0LmdldCgidmFsaWRhdGlvbiIpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAjIG9ubHkgdHJhaW4gZGF0YXNldCBnaXZlbiwgdG9rZW5pemUgYW5kIHJldHVybiBpdAogICAgICAgICAgICAgICAgcmV0dXJuICgKICAgICAgICAgICAgICAgICAgICB0cmFpbl9kYXRhc2V0Lm1hcCgKICAgICAgICAgICAgICAgICAgICAgICAgbGFtYmRhIGV4YW1wbGVzOiB0b2tlbml6ZXIoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAqW2V4YW1wbGVzW2NvbF0gZm9yIGNvbCBpbiBkYXRhc2V0X2NvbHVtbnNfdG9fdHJhaW5dLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJ1bmNhdGlvbj1UcnVlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFkZGluZz1UcnVlLAogICAgICAgICAgICAgICAgICAgICAgICApLAogICAgICAgICAgICAgICAgICAgICAgICBiYXRjaGVkPVRydWUsCiAgICAgICAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICAgICAgICBOb25lLAogICAgICAgICAgICAgICAgKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcigidHJhaW4gZGF0YXNldCBpcyBtYW5kYXRvcnkiKQogICAgICAgICAgICByYWlzZSBLZXlFcnJvcigibm8gdHJhaW4gZGF0YXNldCBmb3VuZCBpbiBnaXZlbiBkYXRhc2V0IikKCiAgICAjIFRva2VuaXplIHRoZSBkYXRhIHNvIHRoZSBtb2RlbCBjYW4gdW5kZXJzdGFuZCBpdAogICAgdG9rZW5pemVkX3RyYWluX2RhdGFzZXQgPSB0cmFpbl9kYXRhc2V0Lm1hcCgKICAgICAgICBsYW1iZGEgZXhhbXBsZXM6IHRva2VuaXplcigKICAgICAgICAgICAgKltleGFtcGxlc1tjb2xdIGZvciBjb2wgaW4gZGF0YXNldF9jb2x1bW5zX3RvX3RyYWluXSwKICAgICAgICAgICAgdHJ1bmNhdGlvbj1UcnVlLAogICAgICAgICAgICBwYWRkaW5nPVRydWUsCiAgICAgICAgKSwKICAgICAgICBiYXRjaGVkPVRydWUsCiAgICApCgogICAgdG9rZW5pemVkX2V2YWxfZGF0YXNldCA9IGV2YWxfZGF0YXNldC5tYXAoCiAgICAgICAgbGFtYmRhIGV4YW1wbGVzOiB0b2tlbml6ZXIoCiAgICAgICAgICAgICpbZXhhbXBsZXNbY29sXSBmb3IgY29sIGluIGRhdGFzZXRfY29sdW1uc190b190cmFpbl0sCiAgICAgICAgICAgIHRydW5jYXRpb249VHJ1ZSwKICAgICAgICAgICAgcGFkZGluZz1UcnVlLAogICAgICAgICksCiAgICAgICAgYmF0Y2hlZD1UcnVlLAogICAgKQoKICAgIHJldHVybiB0b2tlbml6ZWRfdHJhaW5fZGF0YXNldCwgdG9rZW5pemVkX2V2YWxfZGF0YXNldAoKCmRlZiBmaW5ldHVuZV9sbG0oCiAgICBjb250ZXh0OiBtbHJ1bi5NTENsaWVudEN0eCwKICAgIHRyYWluX2RhdGFzZXQ6IHN0ciwKICAgIGV2YWxfZGF0YXNldDogc3RyID0gTm9uZSwKICAgIHRyYWluX2xvYWRfZGF0YXNldF9rd2FyZ3M6IGRpY3QgPSB7fSwKICAgIGV2YWxfbG9hZF9kYXRhc2V0X2t3YXJnczogZGljdCA9IHt9LAogICAgZGF0YXNldF9jb2x1bW5zX3RvX3RyYWluOiBVbmlvbltzdHIsIGxpc3RdID0gInRleHQiLAogICAgbW9kZWw6IFVuaW9uW3N0ciwgVHVwbGVbc3RyLCBzdHJdXSA9ICJodWdnaW5nZmFjZS1tb2RlbCIsCiAgICB0b2tlbml6ZXI6IFVuaW9uW3N0ciwgVHVwbGVbc3RyLCBzdHJdXSA9IE5vbmUsCiAgICBkZWVwc3BlZWRfY29uZmlnOiBVbmlvbltkaWN0LCBib29sXSA9IEZhbHNlLAogICAgcXVhbnRpemF0aW9uX2NvbmZpZzogVW5pb25bZGljdCwgYm9vbF0gPSBGYWxzZSwKICAgIGxvcmFfY29uZmlnOiBVbmlvbltkaWN0LCBib29sXSA9IEZhbHNlLAogICAgdHJhaW5pbmdfY29uZmlnOiBkaWN0ID0ge30sCiAgICBtb2RlbF9wcmV0cmFpbmVkX2NvbmZpZzogZGljdCA9IHt9LAogICAgdG9rZW5pemVyX3ByZXRyYWluZWRfY29uZmlnOiBkaWN0ID0ge30sCiAgICBkYXRhX2NvbGxhdG9yX2NvbmZpZzogZGljdCA9IHt9LAogICAgdGFzazogc3RyID0gInRleHQtZ2VuZXJhdGlvbiIsCiAgICB1c2VfY3VkYTogYm9vbCA9IFRydWUsCiAgICBmcmFtZXdvcms6IHN0ciA9ICJwdCIsCiAgICBkZXZpY2VfbWFwOiBzdHIgPSAiYXV0byIsCiAgICAqKmt3YXJncywKKToKICAgICIiIgogICAgRmluZS10dW5lcyBhIExhbmd1YWdlIE1vZGVsIChMTE0pIG9uIGEgc3BlY2lmaWMgdGFzayB1c2luZyB0aGUgcHJvdmlkZWQgZGF0YXNldC4KICAgICBUaGUgZnVuY3Rpb24gdGFrZXMgdmFyaW91cyBjb25maWd1cmF0aW9uIHBhcmFtZXRlcnMgdG8gY3VzdG9taXplIHRoZSB0cmFpbmluZyBwcm9jZXNzCiAgICAgYW5kIGFkYXB0IHRoZSBtb2RlbCB0byBzcGVjaWZpYyB0YXNrcyB1c2luZyBhIHByb3ZpZGVkIGRhdGFzZXQuCgogICAgOnBhcmFtIGNvbnRleHQ6IG1scnVuIGNvbnRleHQgaW4gb3JkZXIgdG8gbG9nIHRyYWluZWQgbW9kZWwKICAgIDpwYXJhbSBkYXRhc2V0X2NvbHVtbnNfdG9fdHJhaW46IHdoaWNoIGNvbHVtbnMgdG8gcGFzcyB0byB0aGUgbW9kZWwgYXMgaW5wdXRzCiAgICA6cGFyYW0gZXZhbF9sb2FkX2RhdGFzZXRfa3dhcmdzOiBrd2FyZ3MgZm9yIGRhdGFzZXQgbG9hZGluZwogICAgOnBhcmFtIHRyYWluX2xvYWRfZGF0YXNldF9rd2FyZ3M6IGt3YXJncyBmb3IgZGF0YXNldCBsb2FkaW5nCiAgICA6cGFyYW0gZnJhbWV3b3JrOiBwdCBvdCB0ZgogICAgOnBhcmFtIHVzZV9jdWRhOiB1c2UgZ3B1IG9yIG5vdAogICAgOnBhcmFtIHRva2VuaXplcl9wcmV0cmFpbmVkX2NvbmZpZzogY29uZmlnIHRvIGxvYWQgdGhlIHByZXRyYWluZWQgdG9rZW5pemVyCiAgICA6cGFyYW0gbW9kZWxfcHJldHJhaW5lZF9jb25maWc6IGNvbmZpZyB0byBsb2FkIHRoZSBwcmV0cmFpbmVkIG1vZGVsCiAgICA6cGFyYW0gdG9rZW5pemVyOiBhIHR1cGxlIGNvbnRhaW5pbmcgdG9rZW5pemVyIG5hbWUgYW5kIGNsYXNzLCBvciBzdHIgd2l0aCB0b2tlbml6ZXIgbmFtZSBvciBwYXRoCiAgICA6cGFyYW0gbW9kZWw6IGEgdHVwbGUgY29udGFpbmluZyBtb2RlbCBuYW1lIGFuZCBjbGFzcywgb3Igc3RyIHdpdGggbW9kZWwgbmFtZSBvciBwYXRoCiAgICA6cGFyYW0gdHJhaW5fZGF0YXNldDogVGhlIHRyYWluIGRhdGFzZXQgdXNlZCBmb3IgZmluZS10dW5pbmcgdGhlIGxhbmd1YWdlIG1vZGVsLgogICAgOnBhcmFtIGV2YWxfZGF0YXNldDogVGhlIGV2YWwgZGF0YXNldCB1c2VkIGZvciBldmFsdWF0ZSB0aGUgbGFuZ3VhZ2UgbW9kZWwgZHVyaW5nIHRyYWluaW5nLgogICAgOnBhcmFtIGRlZXBzcGVlZF9jb25maWc6IENvbmZpZ3VyYXRpb24gb3B0aW9ucyBmb3IgRGVlcFNwZWVkIChvcHRpb25hbCkuCiAgICA6cGFyYW0gcXVhbnRpemF0aW9uX2NvbmZpZzogQ29uZmlndXJhdGlvbiBvcHRpb25zIGZvciBtb2RlbCBxdWFudGl6YXRpb24gKG9wdGlvbmFsKS4KICAgIDpwYXJhbSBsb3JhX2NvbmZpZzogQ29uZmlndXJhdGlvbiBvcHRpb25zIGZvciBMb3ctUmFuayBBcHByb3hpbWF0aW9uIChMb1JBKSAob3B0aW9uYWwpLgogICAgOnBhcmFtIHRyYWluaW5nX2NvbmZpZzogQ29uZmlndXJhdGlvbiBvcHRpb25zIHNwZWNpZmljIHRvIHRoZSBmaW5lLXR1bmluZyB0cmFpbmluZyBwcm9jZXNzIChvcHRpb25hbCkuCiAgICA6cGFyYW0gZGF0YV9jb2xsYXRvcl9jb25maWc6IENvbmZpZ3VyYXRpb24gb3B0aW9ucyBmb3IgZGF0YSBjb2xsYXRpb24gZHVyaW5nIHRyYWluaW5nIChvcHRpb25hbCkuCiAgICA6cGFyYW0gdGFzazogQSBkZXNjcmlwdGlvbiBvZiB0aGUgc3BlY2lmaWMgdGFzayB0aGUgbW9kZWwgaXMgYmVpbmcgZmluZS10dW5lZCBmb3IuCiAgICA6cGFyYW0ga3dhcmdzOiBBZGRpdGlvbmFsIGtleXdvcmQgYXJndW1lbnRzLgogICAgIiIiCgogICAgIyBUT0RPOiBtYXRjaCBmb3J3YXJkLmtleXdvcmQgdG8gZGF0YXNldC5rZXl3b3JkIC0gY2hlY2sgaWYgcmVsZXZhbnQgaW4gbmV3IGRlc2lnbgogICAgIyBUT0RPOiBhZGQgd2FybmluZyBmb3IgbGFiZWwsIGFuZCBhZGQgb3B0aW9uIHRvIG1vZGlmeSBkYXRhc2V0IGNvbCBuYW1lcyAtIGNoZWNrIGlmIHJlbGV2YW50IGluIG5ldyBkZXNpZ24KCiAgICAjIExvb2sgZm9yIHVwZGF0ZXMgdG8gY29uZmlncyBnaXZlbiBpbiBrd2FyZ3MKICAgIGNvbmZpZ3MgPSB7CiAgICAgICAgQ29uZmlnS2V5cy5kZWVwc3BlZWQ6IGRlZXBzcGVlZF9jb25maWcsCiAgICAgICAgQ29uZmlnS2V5cy5xdWFudGl6YXRpb246IHF1YW50aXphdGlvbl9jb25maWcsCiAgICAgICAgQ29uZmlnS2V5cy5sb3JhOiBsb3JhX2NvbmZpZywKICAgICAgICBDb25maWdLZXlzLnRyYWluaW5nOiB0cmFpbmluZ19jb25maWcsCiAgICAgICAgQ29uZmlnS2V5cy5tb2RlbF9wcmV0cmFpbmVkOiBtb2RlbF9wcmV0cmFpbmVkX2NvbmZpZywKICAgICAgICBDb25maWdLZXlzLnRva2VuaXplcl9wcmV0cmFpbmVkOiB0b2tlbml6ZXJfcHJldHJhaW5lZF9jb25maWcsCiAgICAgICAgQ29uZmlnS2V5cy5kYXRhX2NvbGxhdG9yOiBkYXRhX2NvbGxhdG9yX2NvbmZpZywKICAgIH0KICAgIF91cGRhdGVfY29uZmlnKGRzdD1jb25maWdzLCBzcmM9a3dhcmdzKQoKICAgICMgY2hlY2sgZ3B1IHBlcm1pc3Npb24gYW5kIGF2YWlsYWJpbGl0eQogICAgaWYgdXNlX2N1ZGE6CiAgICAgICAgaWYgdG9yY2guY3VkYS5pc19hdmFpbGFibGUoKToKICAgICAgICAgICAgIyBDbGVhbiBncHUgY2FjaGUKICAgICAgICAgICAgdG9yY2guY3VkYS5lbXB0eV9jYWNoZSgpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoIid1c2VfY3VkYScgaXMgc2V0IHRvIFRydWUsIGJ1dCBubyBjdWRhIGRldmljZSBpcyBhdmFpbGFibGUiKQoKICAgICMgZ2V0IG1vZGVsIGFuZCB0b2tlbml6ZXIKICAgIG1vZGVsX25hbWUsIG1vZGVsLCB0b2tlbml6ZXIgPSBfc2V0X21vZGVsX2FuZF90b2tlbml6ZXIoCiAgICAgICAgbW9kZWw9bW9kZWwsCiAgICAgICAgdG9rZW5pemVyPXRva2VuaXplciwKICAgICAgICB0YXNrPXRhc2ssCiAgICAgICAgZnJhbWV3b3JrPWZyYW1ld29yaywKICAgICAgICBsb3JhX2NvbmZpZz1jb25maWdzW0NvbmZpZ0tleXMubG9yYV0sCiAgICAgICAgcXVhbnRpemF0aW9uX2NvbmZpZz1jb25maWdzW0NvbmZpZ0tleXMucXVhbnRpemF0aW9uXSwKICAgICAgICB1c2VfY3VkYT11c2VfY3VkYSwKICAgICAgICB0b2tlbml6ZXJfcHJldHJhaW5lZF9jb25maWc9dG9rZW5pemVyX3ByZXRyYWluZWRfY29uZmlnLAogICAgICAgIG1vZGVsX3ByZXRyYWluZWRfY29uZmlnPWNvbmZpZ3NbQ29uZmlnS2V5cy5tb2RlbF9wcmV0cmFpbmVkXSwKICAgICAgICBkZXZpY2VfbWFwPWRldmljZV9tYXAsCiAgICApCgogICAgIyBMb2FkIGRhdGFzZXRzCiAgICB0b2tlbml6ZWRfdHJhaW4sIHRva2VuaXplZF9ldmFsID0gX3ByZXBhcmVfZGF0YXNldCgKICAgICAgICB0cmFpbl9kYXRhc2V0PXRyYWluX2RhdGFzZXQsCiAgICAgICAgZXZhbF9kYXRhc2V0PWV2YWxfZGF0YXNldCwKICAgICAgICB0cmFpbl9sb2FkX2RhdGFzZXRfa3dhcmdzPXRyYWluX2xvYWRfZGF0YXNldF9rd2FyZ3MsCiAgICAgICAgZXZhbF9sb2FkX2RhdGFzZXRfa3dhcmdzPWV2YWxfbG9hZF9kYXRhc2V0X2t3YXJncywKICAgICAgICB0b2tlbml6ZXI9dG9rZW5pemVyLAogICAgICAgIGRhdGFzZXRfY29sdW1uc190b190cmFpbj1kYXRhc2V0X2NvbHVtbnNfdG9fdHJhaW4sCiAgICApCgogICAgIyBJbml0aWFsaXplIHRoZSBkYXRhIGNvbGxhdG9yIGZvciB0aGUgdHJhaW5lciB0byB1c2UgaW4gb3JkZXIgdG8gY3JlYXRlIGJhdGNoZXMgb2YgZGF0YQogICAgZGF0YV9jb2xsYXRvciA9IHRyYW5zZm9ybWVycy5EYXRhQ29sbGF0b3JGb3JMYW5ndWFnZU1vZGVsaW5nKAogICAgICAgIHRva2VuaXplcj10b2tlbml6ZXIsIG1sbT1GYWxzZSwgKipkYXRhX2NvbGxhdG9yX2NvbmZpZwogICAgKQoKICAgICMgSW5pdGlhbGl6ZSB0cmFpbmluZyBrd2FyZ3MgZnJvbSB1c2VyIGt3YXJnczoKICAgIHRyYWluX2t3YXJncyA9IGNvbmZpZ3NbQ29uZmlnS2V5cy50cmFpbmluZ10KCiAgICAjIElmIGRlZXBzcGVlZCBjb25maWcgZ2l2ZW4gd2UgYWRkIGl0IHRvIHRyYWluaW5nIGt3YXJncwogICAgaWYgY29uZmlnc1tDb25maWdLZXlzLmRlZXBzcGVlZF06CiAgICAgICAgdHJhaW5fa3dhcmdzWyJkZWVwc3BlZWQiXSA9IGNvbmZpZ3NbQ29uZmlnS2V5cy5kZWVwc3BlZWRdCgogICAgIyBUYWtlIGEgbG9vayBhdCB0aGUgdHJhaW5hYmxlIHBhcmFtZXRlcnMgaW4gdGhlIG1vZGVsCiAgICBfcHJpbnRfdHJhaW5hYmxlX3BhcmFtZXRlcnMobW9kZWwpCgogICAgIyBQcmVwYXJpbmcgdHJhaW5pbmcgYXJndW1lbnRzOgogICAgdHJhaW5pbmdfYXJncyA9IHRyYW5zZm9ybWVycy5UcmFpbmluZ0FyZ3VtZW50cygKICAgICAgICBvdXRwdXRfZGlyPXRlbXBmaWxlLm1rZHRlbXAoKSwKICAgICAgICAqKnRyYWluX2t3YXJncywKICAgICkKCiAgICB0cmFpbmVyID0gdHJhbnNmb3JtZXJzLlRyYWluZXIoCiAgICAgICAgbW9kZWw9bW9kZWwsCiAgICAgICAgdHJhaW5fZGF0YXNldD10b2tlbml6ZWRfdHJhaW4sCiAgICAgICAgZXZhbF9kYXRhc2V0PXRva2VuaXplZF9ldmFsLAogICAgICAgIHRva2VuaXplcj10b2tlbml6ZXIsCiAgICAgICAgZGF0YV9jb2xsYXRvcj1kYXRhX2NvbGxhdG9yLAogICAgICAgIGFyZ3M9dHJhaW5pbmdfYXJncywKICAgICkKCiAgICBfYXBwbHlfbWxydW4odHJhaW5lciwgbW9kZWxfbmFtZT1tb2RlbF9uYW1lKQogICAgbW9kZWwuY29uZmlnLnVzZV9jYWNoZSA9ICgKICAgICAgICBGYWxzZSAgIyBzaWxlbmNlIHRoZSB3YXJuaW5ncy4gUGxlYXNlIHJlLWVuYWJsZSBmb3IgaW5mZXJlbmNlIQogICAgKQoKICAgICMgQXBwbHkgdHJhaW5pbmcgd2l0aCBldmFsdWF0aW9uOgogICAgY29udGV4dC5sb2dnZXIuaW5mbyhmInRyYWluaW5nICd7bW9kZWxfbmFtZX0nIikKICAgIHRyYWluZXIudHJhaW4oKQoKICAgIHRlbXBfZGlyZWN0b3J5ID0gdGVtcGZpbGUuVGVtcG9yYXJ5RGlyZWN0b3J5KCkubmFtZQogICAgdHJhaW5lci5zYXZlX21vZGVsKHRlbXBfZGlyZWN0b3J5KQoKICAgICMgWmlwIHRoZSBtb2RlbCBkaXJlY3Rvcnk6CiAgICBzaHV0aWwubWFrZV9hcmNoaXZlKAogICAgICAgIGJhc2VfbmFtZT0ibW9kZWwiLAogICAgICAgIGZvcm1hdD0iemlwIiwKICAgICAgICByb290X2Rpcj10ZW1wX2RpcmVjdG9yeSwKICAgICkKCiAgICAjIExvZyB0aGUgbW9kZWw6CiAgICBjb250ZXh0LmxvZ19tb2RlbCgKICAgICAgICBrZXk9Im1vZGVsIiwKICAgICAgICBkYl9rZXk9bW9kZWxfbmFtZSwKICAgICAgICBtb2RlbF9maWxlPSJtb2RlbC56aXAiLAogICAgICAgIHRhZz0iIiwKICAgICAgICBmcmFtZXdvcms9Ikh1Z2dpbmcgRmFjZSIsCiAgICApCgoKZGVmIGV2YWx1YXRlKAogICAgY29udGV4dCwKICAgIG1vZGVsX3BhdGgsCiAgICBkYXRhOiBwZC5EYXRhRnJhbWUsCiAgICBtb2RlbF9uYW1lOiBzdHIgPSBOb25lLAogICAgdG9rZW5pemVyX25hbWU6IHN0ciA9IE5vbmUsCik6CiAgICAiIiIKICAgIEV2YWx1YXRpbmcgdGhlIG1vZGVsIHVzaW5nIHBlcnBsZXhpdHksIGZvciBtb3JlIGluZm9ybWF0aW9uIHZpc2l0OgogICAgaHR0cHM6Ly9odWdnaW5nZmFjZS5jby9kb2NzL3RyYW5zZm9ybWVycy9wZXJwbGV4aXR5CgogICAgOnBhcmFtIGNvbnRleHQ6ICAgICBtbHJ1biBjb250ZXh0CiAgICA6cGFyYW0gbW9kZWxfcGF0aDogIHBhdGggdG8gdGhlIG1vZGVsIGRpcmVjdG9yeQogICAgOnBhcmFtIGRhdGE6ICAgICAgICB0aGUgZGF0YSB0byBldmFsdWF0ZSB0aGUgbW9kZWwKICAgIDpwYXJhbSBtb2RlbF9uYW1lOiAgbmFtZSBvZiBiYXNlIG1vZGVsCiAgICA6cGFyYW0gdG9rZW5pemVyX25hbWU6IG5hbWUgb2YgYmFzZSB0b2tlbml6ZXIKICAgICIiIgogICAgIyBHZXQgdGhlIG1vZGVsIGFydGlmYWN0IGFuZCBmaWxlOgogICAgKAogICAgICAgIG1vZGVsX2ZpbGUsCiAgICAgICAgbW9kZWxfYXJ0aWZhY3QsCiAgICAgICAgZXh0cmFfZGF0YSwKICAgICkgPSBtbHJ1bi5hcnRpZmFjdHMuZ2V0X21vZGVsKG1vZGVsX3BhdGgpCgogICAgIyBSZWFkIHRoZSBuYW1lOgogICAgX21vZGVsX25hbWUgPSBtb2RlbF9hcnRpZmFjdC5zcGVjLmRiX2tleQoKICAgICMgRXh0cmFjdCBsb2dnZWQgbW9kZWwgZmlsZXM6CiAgICBtb2RlbF9kaXJlY3RvcnkgPSBvcy5wYXRoLmpvaW4ob3MucGF0aC5kaXJuYW1lKG1vZGVsX2ZpbGUpLCBfbW9kZWxfbmFtZSkKICAgIHdpdGggemlwZmlsZS5aaXBGaWxlKG1vZGVsX2ZpbGUsICJyIikgYXMgemlwX2ZpbGU6CiAgICAgICAgemlwX2ZpbGUuZXh0cmFjdGFsbChtb2RlbF9kaXJlY3RvcnkpCgogICAgIyBMb2FkaW5nIHRoZSBzYXZlZCBwcmV0cmFpbmVkIHRva2VuaXplciBhbmQgbW9kZWw6CiAgICBkYXRhc2V0ID0gRGF0YXNldC5mcm9tX3BhbmRhcyhkYXRhKQogICAgdG9rZW5pemVyID0gQXV0b1Rva2VuaXplci5mcm9tX3ByZXRyYWluZWQodG9rZW5pemVyX25hbWUpCiAgICBwYWRfdG9rZW5faWQgPSB0b2tlbml6ZXIuZW9zX3Rva2VuX2lkCiAgICBtb2RlbCA9IEF1dG9Nb2RlbEZvckNhdXNhbExNLmZyb21fcHJldHJhaW5lZCgKICAgICAgICBtb2RlbF9uYW1lLCBkZXZpY2VfbWFwPSJjdWRhOjAiLCB0cnVzdF9yZW1vdGVfY29kZT1UcnVlLCBsb2FkX2luXzhiaXQ9VHJ1ZQogICAgKQogICAgbW9kZWwgPSBQZWZ0TW9kZWwuZnJvbV9wcmV0cmFpbmVkKG1vZGVsLCBtb2RlbF9kaXJlY3RvcnkpCiAgICBtb2RlbC5ldmFsKCkKICAgIGVuY29kaW5ncyA9IHRva2VuaXplcigiXG5cbiIuam9pbihkYXRhc2V0WyJ0ZXh0Il1bOjVdKSwgcmV0dXJuX3RlbnNvcnM9InB0IikKCiAgICBtYXhfbGVuZ3RoID0gMTAyNAogICAgc3RyaWRlID0gNTEyCiAgICBzZXFfbGVuID0gZW5jb2RpbmdzLmlucHV0X2lkcy5zaXplKDEpCgogICAgbmxscyA9IFtdCiAgICBwcmV2X2VuZF9sb2MgPSAwCiAgICBmb3IgYmVnaW5fbG9jIGluIHJhbmdlKDAsIHNlcV9sZW4sIHN0cmlkZSk6CiAgICAgICAgZW5kX2xvYyA9IG1pbihiZWdpbl9sb2MgKyBtYXhfbGVuZ3RoLCBzZXFfbGVuKQogICAgICAgIHRyZ19sZW4gPSBlbmRfbG9jIC0gcHJldl9lbmRfbG9jICAjIG1heSBiZSBkaWZmZXJlbnQgZnJvbSBzdHJpZGUgb24gbGFzdCBsb29wCiAgICAgICAgaW5wdXRfaWRzID0gZW5jb2RpbmdzLmlucHV0X2lkc1s6LCBiZWdpbl9sb2M6ZW5kX2xvY10KICAgICAgICB0YXJnZXRfaWRzID0gaW5wdXRfaWRzLmNsb25lKCkKICAgICAgICB0YXJnZXRfaWRzWzosIDotdHJnX2xlbl0gPSAtMTAwCgogICAgICAgIHdpdGggdG9yY2gubm9fZ3JhZCgpOgogICAgICAgICAgICBvdXRwdXRzID0gbW9kZWwoaW5wdXRfaWRzLmN1ZGEoKSwgbGFiZWxzPXRhcmdldF9pZHMpCgogICAgICAgICAgICAjIGxvc3MgaXMgY2FsY3VsYXRlZCB1c2luZyBDcm9zc0VudHJvcHlMb3NzIHdoaWNoIGF2ZXJhZ2VzIG92ZXIgdmFsaWQgbGFiZWxzCiAgICAgICAgICAgICMgTi5CLiB0aGUgbW9kZWwgb25seSBjYWxjdWxhdGVzIGxvc3Mgb3ZlciB0cmdfbGVuIC0gMSBsYWJlbHMsIGJlY2F1c2UgaXQgaW50ZXJuYWxseSBzaGlmdHMgdGhlIGxhYmVscwogICAgICAgICAgICAjIHRvIHRoZSBsZWZ0IGJ5IDEuCiAgICAgICAgICAgIG5lZ19sb2dfbGlrZWxpaG9vZCA9IG91dHB1dHMubG9zcwoKICAgICAgICBubGxzLmFwcGVuZChuZWdfbG9nX2xpa2VsaWhvb2QpCgogICAgICAgIHByZXZfZW5kX2xvYyA9IGVuZF9sb2MKICAgICAgICBpZiBlbmRfbG9jID09IHNlcV9sZW46CiAgICAgICAgICAgIGJyZWFrCgogICAgcHBsID0gdG9yY2guZXhwKHRvcmNoLnN0YWNrKG5sbHMpLm1lYW4oKSkuaXRlbSgpCiAgICBjb250ZXh0LmxvZ19yZXN1bHQoInBlcnBsZXhpdHkiLCBwcGwpCg==
    commands: []
    code_origin: https://github.com/ZeevRispler/functions.git#4ef6bf0c63ff8d61e388ad1538d63e016d2625d6:/Users/Zeev_Rispler/PycharmProjects/functions/huggingface_auto_trainer/huggingface_auto_trainer.py
    origin_filename: /Users/Zeev_Rispler/PycharmProjects/functions/huggingface_auto_trainer/huggingface_auto_trainer.py
    requirements: []
  entry_points:
    finetune_llm:
      name: finetune_llm
      doc: "Fine-tunes a Language Model (LLM) on a specific task using the provided\
        \ dataset.\n The function takes various configuration parameters to customize\
        \ the training process\n and adapt the model to specific tasks using a provided\
        \ dataset."
      parameters:
      - name: context
        type: MLClientCtx
        doc: mlrun context in order to log trained model
        default: ''
      - name: train_dataset
        type: str
        doc: The train dataset used for fine-tuning the language model.
        default: ''
      - name: eval_dataset
        type: str
        doc: The eval dataset used for evaluate the language model during training.
        default: null
      - name: train_load_dataset_kwargs
        type: dict
        doc: kwargs for dataset loading
        default: {}
      - name: eval_load_dataset_kwargs
        type: dict
        doc: kwargs for dataset loading
        default: {}
      - name: dataset_columns_to_train
        type: Union[str, list]
        doc: which columns to pass to the model as inputs
        default: text
      - name: model
        type: Union[str, Tuple[str, str]]
        doc: a tuple containing model name and class, or str with model name or path
        default: huggingface-model
      - name: tokenizer
        type: Union[str, Tuple[str, str]]
        doc: a tuple containing tokenizer name and class, or str with tokenizer name
          or path
        default: null
      - name: deepspeed_config
        type: Union[dict, bool]
        doc: Configuration options for DeepSpeed (optional).
        default: false
      - name: quantization_config
        type: Union[dict, bool]
        doc: Configuration options for model quantization (optional).
        default: false
      - name: lora_config
        type: Union[dict, bool]
        doc: Configuration options for Low-Rank Approximation (LoRA) (optional).
        default: false
      - name: training_config
        type: dict
        doc: Configuration options specific to the fine-tuning training process (optional).
        default: {}
      - name: model_pretrained_config
        type: dict
        doc: config to load the pretrained model
        default: {}
      - name: tokenizer_pretrained_config
        type: dict
        doc: config to load the pretrained tokenizer
        default: {}
      - name: data_collator_config
        type: dict
        doc: Configuration options for data collation during training (optional).
        default: {}
      - name: task
        type: str
        doc: A description of the specific task the model is being fine-tuned for.
        default: text-generation
      - name: use_cuda
        type: bool
        doc: use gpu or not
        default: true
      - name: framework
        type: str
        doc: pt ot tf
        default: pt
      - name: device_map
        type: str
        default: auto
      outputs:
      - default: ''
      lineno: 614
    evaluate:
      name: evaluate
      doc: 'Evaluating the model using perplexity, for more information visit:

        https://huggingface.co/docs/transformers/perplexity'
      parameters:
      - name: context
        doc: mlrun context
        default: ''
      - name: model_path
        doc: path to the model directory
        default: ''
      - name: data
        type: DataFrame
        doc: the data to evaluate the model
        default: ''
      - name: model_name
        type: str
        doc: name of base model
        default: null
      - name: tokenizer_name
        type: str
        doc: name of base tokenizer
        default: null
      outputs:
      - default: ''
      lineno: 768
  description: fine-tune llm model with ease
  default_handler: finetune_llm
  disable_auto_mount: false
  clone_target_dir: ''
  env: []
  priority_class_name: ''
  preemption_mode: prevent
  affinity: null
  tolerations: null
  security_context: {}
verbose: false
